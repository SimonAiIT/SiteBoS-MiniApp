<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Product Editor</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
    <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
  </div>

  <div class="container" id="mainContent">
    <h1 id="pageTitle">Product Editor</h1>
    <p class="subtitle" id="pageSubtitle">Details management</p>
    
    <form id="productForm">
      <div class="section-title" id="lblIdentity">üìã Identity</div>
      
      <div class="form-group">
        <label for="itemName" class="required" id="lblItemName">Product Name</label>
        <input type="text" id="itemName" required>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="itemSku" class="disabled">SKU (Immutable)</label>
          <input type="text" id="itemSku" disabled>
        </div>
        <div class="form-group">
          <label for="itemType" id="lblItemType">Type</label>
          <select id="itemType">
            <option value="SERVICE" id="optService">Service</option>
            <option value="PRODUCT" id="optProduct">Product</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="descShort" class="required" id="lblShortDesc">Short Description (max 100 chars)</label>
        <input type="text" id="descShort" maxlength="100" required>
      </div>

      <div class="form-group">
        <label for="descLong" id="lblLongDesc">Full Description</label>
        <textarea id="descLong" rows="4"></textarea>
      </div>

      <div class="form-group">
        <label for="internalNotes" id="lblInternalNotes">Internal Notes</label>
        <textarea id="internalNotes" rows="3" class="monospace"></textarea>
      </div>

      <div class="section-title" id="lblPricing">üí∞ Pricing</div>

      <div class="row">
        <div class="form-group">
          <label for="basePrice" class="required" id="lblPrice">Base Price</label>
          <input type="number" id="basePrice" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label for="currency" id="lblCurrency">Currency</label>
          <select id="currency">
            <option value="EUR">EUR (‚Ç¨)</option>
            <option value="USD">USD ($)</option>
            <option value="GBP">GBP (¬£)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="unitOfMeasure" class="required" id="lblUnit">Unit of Measure</label>
          <select id="unitOfMeasure" required>
            <option value="item" id="optItem">Item/Unit</option>
            <option value="hour" id="optHour">Hour</option>
            <option value="day" id="optDay">Day</option>
            <option value="project" id="optProject">Project</option>
            <option value="month" id="optMonth">Month</option>
          </select>
        </div>
        <div class="form-group">
          <label for="taxRate" id="lblTax">Tax Rate (%)</label>
          <input type="number" id="taxRate" step="1" min="0" max="100" value="22">
        </div>
      </div>

      <div class="section-title" id="lblOps">‚öôÔ∏è Operations</div>

      <div class="row">
        <div class="form-group">
          <label>
            <input type="checkbox" id="requiresBooking">
            <span id="chkBooking">Requires Booking</span>
          </label>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="requiresInventory">
            <span id="chkInventory">Inventory Check</span>
          </label>
        </div>
      </div>

      <div class="form-group">
        <label for="skillTags" id="lblSkills">Required Skills (press Enter)</label>
        <div class="tag-input-container" id="skillTagsContainer">
          <input type="text" class="tag-input" id="skillTagInput" placeholder="Es: SeniorConsultant">
        </div>
      </div>

      <div class="form-group">
        <label for="keywords" id="lblKeywords">Keywords/Tags (press Enter)</label>
        <div class="tag-input-container" id="keywordsContainer">
          <input type="text" class="tag-input" id="keywordInput" placeholder="Es: setup, consulting">
        </div>
      </div>

      <div class="button-container">
        <button type="submit" id="saveBtn">Save Changes</button>
      </div>
      <p class="cancel-hint" id="hintCancel">To cancel, close this window</p>
    </form>
  </div>

  <script>
    const WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/2c6416b1-32c6-4661-bd8f-b175d24fd035";
    
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    const ownerId = urlParams.get('owner');
    const langParam = urlParams.get('lang') || urlParams.get('language') || 'it';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TRANSLATION DICTIONARY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const translations = {
      it: {
        title: "‚úèÔ∏è Modifica Prodotto", subtitle: "Gestione dettagli e prezzi",
        secIdentity: "üìã Identit√†", secPricing: "üí∞ Pricing", secOps: "‚öôÔ∏è Operativit√†",
        lblName: "Nome Prodotto/Servizio", lblType: "Tipo", lblShort: "Descrizione Breve (max 100)",
        lblLong: "Descrizione Completa", lblInternal: "Note Interne (Staff)",
        lblPrice: "Prezzo Base", lblCurrency: "Valuta", lblUnit: "Unit√† di Misura", lblTax: "Aliquota IVA (%)",
        chkBooking: "Richiede Prenotazione", chkInventory: "Controllo Inventario",
        lblSkills: "Competenze Richieste (Invio per agg.)", lblKw: "Keywords/Tag (Invio per agg.)",
        btnSave: "üíæ Salva Modifiche", hintCancel: "Per annullare, chiudi questa finestra",
        optService: "Servizio", optProduct: "Prodotto",
        optItem: "Pezzo/Unit√†", optHour: "Ora", optDay: "Giorno", optProject: "Progetto", optMonth: "Mese",
        loading: "Caricamento...", saving: "Salvataggio...", saved: "‚úÖ Salvato!", error: "‚ùå Errore",
        phSkill: "Es: SeniorConsultant", phKw: "Es: consulenza, setup"
      },
      en: {
        title: "‚úèÔ∏è Edit Product", subtitle: "Manage details and pricing",
        secIdentity: "üìã Identity", secPricing: "üí∞ Pricing", secOps: "‚öôÔ∏è Operations",
        lblName: "Product/Service Name", lblType: "Type", lblShort: "Short Description (max 100)",
        lblLong: "Full Description", lblInternal: "Internal Notes (Staff only)",
        lblPrice: "Base Price", lblCurrency: "Currency", lblUnit: "Unit of Measure", lblTax: "Tax Rate (%)",
        chkBooking: "Requires Booking", chkInventory: "Check Inventory",
        lblSkills: "Required Skills (Enter to add)", lblKw: "Keywords/Tags (Enter to add)",
        btnSave: "üíæ Save Changes", hintCancel: "Close this window to cancel",
        optService: "Service", optProduct: "Product",
        optItem: "Item/Unit", optHour: "Hour", optDay: "Day", optProject: "Project", optMonth: "Month",
        loading: "Loading...", saving: "Saving...", saved: "‚úÖ Saved!", error: "‚ùå Error",
        phSkill: "E.g.: SeniorConsultant", phKw: "E.g.: consulting, setup"
      },
      fr: {
        title: "‚úèÔ∏è Modifier Produit", subtitle: "Gestion d√©tails et prix",
        secIdentity: "üìã Identit√©", secPricing: "üí∞ Tarification", secOps: "‚öôÔ∏è Op√©rations",
        lblName: "Nom Produit/Service", lblType: "Type", lblShort: "Description Courte (max 100)",
        lblLong: "Description Compl√®te", lblInternal: "Notes Internes (Staff)",
        lblPrice: "Prix de Base", lblCurrency: "Devise", lblUnit: "Unit√© de Mesure", lblTax: "TVA (%)",
        chkBooking: "R√©servation Requise", chkInventory: "Contr√¥le Inventaire",
        lblSkills: "Comp√©tences Requises (Entr√©e)", lblKw: "Mots-cl√©s/Tags (Entr√©e)",
        btnSave: "üíæ Enregistrer", hintCancel: "Fermer pour annuler",
        optService: "Service", optProduct: "Produit",
        optItem: "Pi√®ce/Unit√©", optHour: "Heure", optDay: "Jour", optProject: "Projet", optMonth: "Mois",
        loading: "Chargement...", saving: "Enregistrement...", saved: "‚úÖ Enregistr√© !", error: "‚ùå Erreur",
        phSkill: "Ex: SeniorConsultant", phKw: "Ex: conseil, setup"
      },
      de: {
        title: "‚úèÔ∏è Produkt bearbeiten", subtitle: "Details und Preise verwalten",
        secIdentity: "üìã Identit√§t", secPricing: "üí∞ Preisgestaltung", secOps: "‚öôÔ∏è Betrieb",
        lblName: "Produkt-/Dienstname", lblType: "Typ", lblShort: "Kurzbeschreibung (max 100)",
        lblLong: "Vollst√§ndige Beschreibung", lblInternal: "Interne Notizen",
        lblPrice: "Grundpreis", lblCurrency: "W√§hrung", lblUnit: "Ma√üeinheit", lblTax: "Steuersatz (%)",
        chkBooking: "Buchung erforderlich", chkInventory: "Bestandspr√ºfung",
        lblSkills: "Erforderliche F√§higkeiten", lblKw: "Stichworte/Tags",
        btnSave: "üíæ Speichern", hintCancel: "Zum Abbrechen Fenster schlie√üen",
        optService: "Dienstleistung", optProduct: "Produkt",
        optItem: "St√ºck/Einheit", optHour: "Stunde", optDay: "Tag", optProject: "Projekt", optMonth: "Monat",
        loading: "Laden...", saving: "Speichern...", saved: "‚úÖ Gespeichert!", error: "‚ùå Fehler",
        phSkill: "Z.B.: SeniorConsultant", phKw: "Z.B.: Beratung"
      },
      es: {
        title: "‚úèÔ∏è Editar Producto", subtitle: "Gesti√≥n de detalles y precios",
        secIdentity: "üìã Identidad", secPricing: "üí∞ Precios", secOps: "‚öôÔ∏è Operaciones",
        lblName: "Nombre Producto/Servicio", lblType: "Tipo", lblShort: "Descripci√≥n Corta (max 100)",
        lblLong: "Descripci√≥n Completa", lblInternal: "Notas Internas",
        lblPrice: "Precio Base", lblCurrency: "Moneda", lblUnit: "Unidad de Medida", lblTax: "IVA (%)",
        chkBooking: "Requiere Reserva", chkInventory: "Control Inventario",
        lblSkills: "Habilidades Requeridas", lblKw: "Palabras Clave/Tags",
        btnSave: "üíæ Guardar Cambios", hintCancel: "Cerrar para cancelar",
        optService: "Servicio", optProduct: "Producto",
        optItem: "Pieza/Unidad", optHour: "Hora", optDay: "D√≠a", optProject: "Proyecto", optMonth: "Mes",
        loading: "Cargando...", saving: "Guardando...", saved: "‚úÖ ¬°Guardado!", error: "‚ùå Error",
        phSkill: "Ej: SeniorConsultant", phKw: "Ej: consultor√≠a"
      },
      pt: {
        title: "‚úèÔ∏è Editar Produto", subtitle: "Gest√£o de detalhes e pre√ßos",
        secIdentity: "üìã Identidade", secPricing: "üí∞ Pre√ßos", secOps: "‚öôÔ∏è Opera√ß√µes",
        lblName: "Nome Produto/Servi√ßo", lblType: "Tipo", lblShort: "Descri√ß√£o Curta (max 100)",
        lblLong: "Descri√ß√£o Completa", lblInternal: "Notas Internas",
        lblPrice: "Pre√ßo Base", lblCurrency: "Moeda", lblUnit: "Unidade de Medida", lblTax: "Taxa (%)",
        chkBooking: "Requer Reserva", chkInventory: "Controle de Estoque",
        lblSkills: "Habilidades Necess√°rias", lblKw: "Palavras-chave/Tags",
        btnSave: "üíæ Salvar Altera√ß√µes", hintCancel: "Fechar para cancelar",
        optService: "Servi√ßo", optProduct: "Produto",
        optItem: "Item/Unidade", optHour: "Hora", optDay: "Dia", optProject: "Projeto", optMonth: "M√™s",
        loading: "Carregando...", saving: "Salvando...", saved: "‚úÖ Salvo!", error: "‚ùå Erro",
        phSkill: "Ex: SeniorConsultant", phKw: "Ex: consultoria"
      }
    };

    const t = translations[langParam] || translations['it'];

    function applyTranslations() {
        document.title = t.title;
        document.getElementById('pageTitle').textContent = t.title;
        document.getElementById('pageSubtitle').textContent = t.subtitle;
        document.getElementById('lblIdentity').textContent = t.secIdentity;
        document.getElementById('lblPricing').textContent = t.secPricing;
        document.getElementById('lblOps').textContent = t.secOps;
        
        document.getElementById('lblItemName').textContent = t.lblName;
        document.getElementById('lblItemType').textContent = t.lblType;
        document.getElementById('lblShortDesc').textContent = t.lblShort;
        document.getElementById('lblLongDesc').textContent = t.lblLong;
        document.getElementById('lblInternalNotes').textContent = t.lblInternal;
        
        document.getElementById('lblPrice').textContent = t.lblPrice;
        document.getElementById('lblCurrency').textContent = t.lblCurrency;
        document.getElementById('lblUnit').textContent = t.lblUnit;
        document.getElementById('lblTax').textContent = t.lblTax;
        
        document.getElementById('chkBooking').textContent = t.chkBooking;
        document.getElementById('chkInventory').textContent = t.chkInventory;
        
        document.getElementById('lblSkills').textContent = t.lblSkills;
        document.getElementById('skillTagInput').placeholder = t.phSkill;
        
        document.getElementById('lblKeywords').textContent = t.lblKw;
        document.getElementById('keywordInput').placeholder = t.phKw;
        
        document.getElementById('saveBtn').textContent = t.btnSave;
        document.getElementById('hintCancel').textContent = t.hintCancel;
        document.getElementById('loadingText').textContent = t.loading;

        // Dropdown Translations
        document.getElementById('optService').textContent = t.optService;
        document.getElementById('optProduct').textContent = t.optProduct;
        document.getElementById('optItem').textContent = t.optItem;
        document.getElementById('optHour').textContent = t.optHour;
        document.getElementById('optDay').textContent = t.optDay;
        document.getElementById('optProject').textContent = t.optProject;
        document.getElementById('optMonth').textContent = t.optMonth;
    }
    applyTranslations();

    let currentData = null;
    let skillTags = [];
    let keywords = [];

    // TAG MANAGEMENT
    function renderTags(container, tags, onRemove) {
      const input = container.querySelector('.tag-input');
      container.querySelectorAll('.tag').forEach(el => el.remove());
      
      tags.forEach((tag, idx) => {
        const tagEl = document.createElement('div');
        tagEl.className = 'tag';
        tagEl.innerHTML = `${tag} <span class="tag-remove" data-idx="${idx}">√ó</span>`;
        tagEl.querySelector('.tag-remove').onclick = () => onRemove(idx);
        container.insertBefore(tagEl, input);
      });
    }

    function setupTagInput(inputId, containerId, tagsArray) {
      const input = document.getElementById(inputId);
      const container = document.getElementById(containerId);
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          const val = input.value.trim();
          if (val && !tagsArray.includes(val)) {
            tagsArray.push(val);
            input.value = '';
            renderTags(container, tagsArray, (idx) => {
              tagsArray.splice(idx, 1);
              renderTags(container, tagsArray, arguments.callee);
            });
          }
        }
      });
    }

    // LOAD PRODUCT DATA
    async function loadProduct() {
      try {
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'GET',
            type: 'PRODUCT',
            id: productId,
            owner_id: ownerId
          })
        });

        let data;
        const text = await response.text();
        try { data = JSON.parse(text); } catch (e) { data = JSON.parse(text.replace(/^"|"$/g, '').replace(/\\"/g, '"')); }

        currentData = data;

        // Popola form
        document.getElementById('itemName').value = data.identity.item_name;
        document.getElementById('itemSku').value = data.identity.item_sku;
        document.getElementById('itemType').value = data.identity.item_type;
        document.getElementById('descShort').value = data.identity.description.short;
        document.getElementById('descLong').value = data.identity.description.long || '';
        document.getElementById('internalNotes').value = data.identity.description.internal_notes || '';

        document.getElementById('basePrice').value = data.pricing.base_price;
        document.getElementById('currency').value = data.pricing.currency;
        document.getElementById('unitOfMeasure').value = data.pricing.unit_of_measure;
        document.getElementById('taxRate').value = data.pricing.tax_info.tax_rate_percentage;

        document.getElementById('requiresBooking').checked = data.operations.requires_booking;
        document.getElementById('requiresInventory').checked = data.operations.requires_inventory_check;

        skillTags = data.operations.provider_info.required_skill_tags || [];
        keywords = data.identity.keywords || [];

        renderTags(document.getElementById('skillTagsContainer'), skillTags, (idx) => {
          skillTags.splice(idx, 1);
          renderTags(document.getElementById('skillTagsContainer'), skillTags, arguments.callee);
        });
        
        renderTags(document.getElementById('keywordsContainer'), keywords, (idx) => {
          keywords.splice(idx, 1);
          renderTags(document.getElementById('keywordsContainer'), keywords, arguments.callee);
        });

        // Update page title dynamically if name is loaded
        document.getElementById('pageTitle').textContent = `‚úèÔ∏è ${data.identity.item_name}`;
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('mainContent').style.display = 'block';

      } catch (error) {
        console.error('Load error:', error);
        document.getElementById('loadingText').textContent = t.error;
      }
    }

    // SAVE PRODUCT DATA
    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.innerHTML = `<div class="spinner"></div> ${t.saving}`;
      saveBtn.disabled = true;

      currentData.identity.item_name = document.getElementById('itemName').value.trim();
      currentData.identity.item_type = document.getElementById('itemType').value;
      currentData.identity.description.short = document.getElementById('descShort').value.trim();
      currentData.identity.description.long = document.getElementById('descLong').value.trim();
      currentData.identity.description.internal_notes = document.getElementById('internalNotes').value.trim();
      currentData.identity.keywords = keywords;

      currentData.pricing.base_price = parseFloat(document.getElementById('basePrice').value);
      currentData.pricing.currency = document.getElementById('currency').value;
      currentData.pricing.unit_of_measure = document.getElementById('unitOfMeasure').value;
      currentData.pricing.tax_info.tax_rate_percentage = parseInt(document.getElementById('taxRate').value);

      currentData.operations.requires_booking = document.getElementById('requiresBooking').checked;
      currentData.operations.requires_inventory_check = document.getElementById('requiresInventory').checked;
      currentData.operations.provider_info.required_skill_tags = skillTags;

      try {
        await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'SAVE',
            type: 'PRODUCT',
            id: productId,
            owner_id: ownerId,
            payload: currentData
          })
        });

        saveBtn.textContent = t.saved;
        saveBtn.classList.add('success');
        setTimeout(() => tg.close(), 1200);

      } catch (error) {
        console.error('Save error:', error);
        saveBtn.textContent = t.error;
        saveBtn.disabled = false;
      }
    });

    setupTagInput('skillTagInput', 'skillTagsContainer', skillTags);
    setupTagInput('keywordInput', 'keywordsContainer', keywords);
    loadProduct();
  </script>
</body>
</html>
