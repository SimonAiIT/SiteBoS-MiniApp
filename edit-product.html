<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Product Editor</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Collegamento al file CSS unificato -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- LOADING OVERLAY -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
  </div>

  <div class="container hidden" id="mainContent">
    <h1 id="pageTitle">Product Editor</h1>
    <p class="subtitle" id="pageSubtitle">Details management</p>
    
    <form id="productForm">
      
      <!-- SEZIONE 1: IDENTIT√Ä -->
      <div class="form-section">
        <div class="form-section-title" id="lblIdentity">üìã Identity</div>
        
        <div class="input-group">
          <label for="itemName" class="required" id="lblItemName">Product Name</label>
          <input type="text" id="itemName" required placeholder="...">
        </div>

        <div class="row">
          <div class="col">
            <div class="input-group">
              <label for="itemSku">SKU</label>
              <input type="text" id="itemSku" disabled style="opacity: 0.7;">
            </div>
          </div>
          <div class="col">
            <div class="input-group">
              <label for="itemType" id="lblItemType">Type</label>
              <select id="itemType">
                <option value="SERVICE" id="optService">Service</option>
                <option value="PRODUCT" id="optProduct">Product</option>
              </select>
            </div>
          </div>
        </div>

        <div class="input-group">
          <label for="descShort" class="required" id="lblShortDesc">Short Description</label>
          <input type="text" id="descShort" maxlength="100" required>
        </div>

        <div class="input-group">
          <label for="descLong" id="lblLongDesc">Full Description</label>
          <textarea id="descLong" rows="4"></textarea>
        </div>

        <div class="input-group">
          <label for="internalNotes" id="lblInternalNotes">Internal Notes</label>
          <textarea id="internalNotes" rows="2" style="font-family: monospace; font-size: 13px;"></textarea>
        </div>
      </div>

      <!-- SEZIONE 2: PRICING -->
      <div class="form-section">
        <div class="form-section-title" id="lblPricing">üí∞ Pricing</div>

        <div class="row">
          <div class="col">
            <div class="input-group">
              <label for="basePrice" class="required" id="lblPrice">Base Price</label>
              <input type="number" id="basePrice" step="0.01" min="0" required>
            </div>
          </div>
          <div class="col">
            <div class="input-group">
              <label for="currency" id="lblCurrency">Currency</label>
              <select id="currency">
                <option value="EUR">EUR (‚Ç¨)</option>
                <option value="USD">USD ($)</option>
                <option value="GBP">GBP (¬£)</option>
              </select>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="input-group">
              <label for="unitOfMeasure" class="required" id="lblUnit">Unit</label>
              <select id="unitOfMeasure" required>
                <option value="item" id="optItem">Item/Unit</option>
                <option value="hour" id="optHour">Hour</option>
                <option value="day" id="optDay">Day</option>
                <option value="project" id="optProject">Project</option>
                <option value="month" id="optMonth">Month</option>
              </select>
            </div>
          </div>
          <div class="col">
            <div class="input-group">
              <label for="taxRate" id="lblTax">Tax (%)</label>
              <input type="number" id="taxRate" step="1" min="0" max="100" value="22">
            </div>
          </div>
        </div>
      </div>

      <!-- SEZIONE 3: OPERATIONS & TAGS -->
      <div class="form-section">
        <div class="form-section-title" id="lblOps">‚öôÔ∏è Operations</div>

        <div class="checkbox-group">
          <div>
            <input type="checkbox" id="requiresBooking">
            <label for="requiresBooking" id="chkBooking">Requires Booking</label>
          </div>
          <div>
            <input type="checkbox" id="requiresInventory">
            <label for="requiresInventory" id="chkInventory">Inventory Check</label>
          </div>
        </div>

        <div class="input-group">
          <label for="skillTagInput" id="lblSkills">Required Skills</label>
          <div class="tag-input-container" id="skillTagsContainer">
            <input type="text" id="skillTagInput" placeholder="...">
          </div>
        </div>

        <div class="input-group">
          <label for="keywordInput" id="lblKeywords">Keywords (SEO)</label>
          <div class="tag-input-container" id="keywordsContainer">
            <input type="text" id="keywordInput" placeholder="...">
          </div>
        </div>
      </div>

      <!-- FOOTER ACTIONS -->
      <div class="button-container">
        <button type="submit" id="saveBtn" class="btn btn-primary btn-block">Save Changes</button>
      </div>
      <p class="cancel-hint" id="hintCancel">To cancel, close this window</p>
    </form>
  </div>

  <script>
    const WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/2c6416b1-32c6-4661-bd8f-b175d24fd035";
    
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // Theme Params integration (Optional enhancement)
    // if (tg.colorScheme === 'light') { ... } 

    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    const ownerId = urlParams.get('owner');
    const langParam = urlParams.get('lang') || urlParams.get('language') || 'it';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TRANSLATIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const translations = {
      it: {
        title: "‚úèÔ∏è Modifica Prodotto", subtitle: "Gestione dettagli e prezzi",
        secIdentity: "üìã Identit√†", secPricing: "üí∞ Pricing", secOps: "‚öôÔ∏è Operativit√†",
        lblName: "Nome Prodotto/Servizio", lblType: "Tipo", lblShort: "Descrizione Breve (max 100)",
        lblLong: "Descrizione Completa", lblInternal: "Note Interne (Staff)",
        lblPrice: "Prezzo Base", lblCurrency: "Valuta", lblUnit: "Unit√†", lblTax: "IVA (%)",
        chkBooking: "Prenotazione", chkInventory: "Inventario",
        lblSkills: "Skill Richieste (Invio per agg.)", lblKw: "Keywords (Invio per agg.)",
        btnSave: "üíæ Salva Modifiche", hintCancel: "Chiudi la finestra per annullare",
        optService: "Servizio", optProduct: "Prodotto",
        optItem: "Pezzo", optHour: "Ora", optDay: "Giorno", optProject: "Progetto", optMonth: "Mese",
        loading: "Caricamento...", saving: "Salvataggio...", saved: "‚úÖ Salvato!", error: "‚ùå Errore",
        phSkill: "Es: Senior, Junior", phKw: "Es: consulenza, setup"
      },
      en: {
        title: "‚úèÔ∏è Edit Product", subtitle: "Manage details and pricing",
        secIdentity: "üìã Identity", secPricing: "üí∞ Pricing", secOps: "‚öôÔ∏è Operations",
        lblName: "Product Name", lblType: "Type", lblShort: "Short Description",
        lblLong: "Full Description", lblInternal: "Internal Notes",
        lblPrice: "Base Price", lblCurrency: "Currency", lblUnit: "Unit", lblTax: "Tax (%)",
        chkBooking: "Booking", chkInventory: "Inventory",
        lblSkills: "Required Skills (Enter to add)", lblKw: "Keywords (Enter to add)",
        btnSave: "üíæ Save Changes", hintCancel: "Close window to cancel",
        optService: "Service", optProduct: "Product",
        optItem: "Item", optHour: "Hour", optDay: "Day", optProject: "Project", optMonth: "Month",
        loading: "Loading...", saving: "Saving...", saved: "‚úÖ Saved!", error: "‚ùå Error",
        phSkill: "E.g.: Senior, Junior", phKw: "E.g.: consulting"
      },
      fr: {
        title: "‚úèÔ∏è Modifier", subtitle: "D√©tails et prix",
        secIdentity: "üìã Identit√©", secPricing: "üí∞ Tarifs", secOps: "‚öôÔ∏è Op√©rations",
        lblName: "Nom", lblType: "Type", lblShort: "Desc. Courte",
        lblLong: "Desc. Compl√®te", lblInternal: "Notes Internes",
        lblPrice: "Prix", lblCurrency: "Devise", lblUnit: "Unit√©", lblTax: "TVA (%)",
        chkBooking: "R√©servation", chkInventory: "Inventaire",
        lblSkills: "Comp√©tences (Entr√©e)", lblKw: "Mots-cl√©s (Entr√©e)",
        btnSave: "üíæ Enregistrer", hintCancel: "Fermer pour annuler",
        optService: "Service", optProduct: "Produit",
        optItem: "Pi√®ce", optHour: "Heure", optDay: "Jour", optProject: "Projet", optMonth: "Mois",
        loading: "Chargement...", saving: "Enregistrement...", saved: "‚úÖ Enregistr√©!", error: "‚ùå Erreur",
        phSkill: "Ex: Senior", phKw: "Ex: conseil"
      },
      de: {
        title: "‚úèÔ∏è Bearbeiten", subtitle: "Details und Preise",
        secIdentity: "üìã Identit√§t", secPricing: "üí∞ Preise", secOps: "‚öôÔ∏è Betrieb",
        lblName: "Name", lblType: "Typ", lblShort: "Kurzbeschreibung",
        lblLong: "Beschreibung", lblInternal: "Interne Notizen",
        lblPrice: "Preis", lblCurrency: "W√§hrung", lblUnit: "Einheit", lblTax: "MwSt (%)",
        chkBooking: "Buchung", chkInventory: "Inventar",
        lblSkills: "Skills (Enter)", lblKw: "Keywords (Enter)",
        btnSave: "üíæ Speichern", hintCancel: "Schlie√üen zum Abbrechen",
        optService: "Dienst", optProduct: "Produkt",
        optItem: "St√ºck", optHour: "Stunde", optDay: "Tag", optProject: "Projekt", optMonth: "Monat",
        loading: "Laden...", saving: "Speichern...", saved: "‚úÖ Gespeichert!", error: "‚ùå Fehler",
        phSkill: "z.B.: Senior", phKw: "z.B.: Beratung"
      },
      es: {
        title: "‚úèÔ∏è Editar", subtitle: "Detalles y precios",
        secIdentity: "üìã Identidad", secPricing: "üí∞ Precios", secOps: "‚öôÔ∏è Operaciones",
        lblName: "Nombre", lblType: "Tipo", lblShort: "Desc. Corta",
        lblLong: "Desc. Completa", lblInternal: "Notas Internas",
        lblPrice: "Precio", lblCurrency: "Moneda", lblUnit: "Unidad", lblTax: "IVA (%)",
        chkBooking: "Reserva", chkInventory: "Inventario",
        lblSkills: "Habilidades (Enter)", lblKw: "Palabras clave (Enter)",
        btnSave: "üíæ Guardar", hintCancel: "Cerrar para cancelar",
        optService: "Servicio", optProduct: "Producto",
        optItem: "Pieza", optHour: "Hora", optDay: "D√≠a", optProject: "Proyecto", optMonth: "Mes",
        loading: "Cargando...", saving: "Guardando...", saved: "‚úÖ Guardado!", error: "‚ùå Error",
        phSkill: "Ej: Senior", phKw: "Ej: consultor√≠a"
      },
      pt: {
        title: "‚úèÔ∏è Editar", subtitle: "Detalhes e pre√ßos",
        secIdentity: "üìã Identidade", secPricing: "üí∞ Pre√ßos", secOps: "‚öôÔ∏è Opera√ß√µes",
        lblName: "Nome", lblType: "Tipo", lblShort: "Desc. Curta",
        lblLong: "Desc. Completa", lblInternal: "Notas Internas",
        lblPrice: "Pre√ßo", lblCurrency: "Moeda", lblUnit: "Unidade", lblTax: "Imposto (%)",
        chkBooking: "Reserva", chkInventory: "Estoque",
        lblSkills: "Habilidades (Enter)", lblKw: "Palavras-chave (Enter)",
        btnSave: "üíæ Salvar", hintCancel: "Fechar para cancelar",
        optService: "Servi√ßo", optProduct: "Produto",
        optItem: "Item", optHour: "Hora", optDay: "Dia", optProject: "Projeto", optMonth: "M√™s",
        loading: "Carregando...", saving: "Salvando...", saved: "‚úÖ Salvo!", error: "‚ùå Erro",
        phSkill: "Ex: Senior", phKw: "Ex: consultoria"
      }
    };

    const t = translations[langParam] || translations['it'];

    function applyTranslations() {
        document.title = t.title;
        document.getElementById('pageTitle').textContent = t.title;
        document.getElementById('pageSubtitle').textContent = t.subtitle;
        document.getElementById('lblIdentity').textContent = t.secIdentity;
        document.getElementById('lblPricing').textContent = t.secPricing;
        document.getElementById('lblOps').textContent = t.secOps;
        
        document.getElementById('lblItemName').textContent = t.lblName;
        document.getElementById('lblItemType').textContent = t.lblType;
        document.getElementById('lblShortDesc').textContent = t.lblShort;
        document.getElementById('lblLongDesc').textContent = t.lblLong;
        document.getElementById('lblInternalNotes').textContent = t.lblInternal;
        
        document.getElementById('lblPrice').textContent = t.lblPrice;
        document.getElementById('lblCurrency').textContent = t.lblCurrency;
        document.getElementById('lblUnit').textContent = t.lblUnit;
        document.getElementById('lblTax').textContent = t.lblTax;
        
        document.getElementById('chkBooking').textContent = t.chkBooking;
        document.getElementById('chkInventory').textContent = t.chkInventory;
        
        document.getElementById('lblSkills').textContent = t.lblSkills;
        document.getElementById('skillTagInput').placeholder = t.phSkill;
        
        document.getElementById('lblKeywords').textContent = t.lblKw;
        document.getElementById('keywordInput').placeholder = t.phKw;
        
        document.getElementById('saveBtn').textContent = t.btnSave;
        document.getElementById('hintCancel').textContent = t.hintCancel;
        document.getElementById('loadingText').textContent = t.loading;

        document.getElementById('optService').textContent = t.optService;
        document.getElementById('optProduct').textContent = t.optProduct;
        document.getElementById('optItem').textContent = t.optItem;
        document.getElementById('optHour').textContent = t.optHour;
        document.getElementById('optDay').textContent = t.optDay;
        document.getElementById('optProject').textContent = t.optProject;
        document.getElementById('optMonth').textContent = t.optMonth;
    }
    applyTranslations();

    let currentData = null;
    let skillTags = [];
    let keywords = [];

    // TAG MANAGEMENT FUNCTIONALITY
    function renderTags(container, tags, onRemove) {
      const input = container.querySelector('input');
      container.querySelectorAll('.tag').forEach(el => el.remove());
      
      tags.forEach((tag, idx) => {
        const tagEl = document.createElement('div');
        tagEl.className = 'tag';
        tagEl.innerHTML = `${tag} <span class="tag-remove" data-idx="${idx}">√ó</span>`;
        tagEl.querySelector('.tag-remove').onclick = () => onRemove(idx);
        container.insertBefore(tagEl, input);
      });
    }

    function setupTagInput(inputId, containerId, tagsArray) {
      const input = document.getElementById(inputId);
      const container = document.getElementById(containerId);
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          const val = input.value.trim();
          if (val && !tagsArray.includes(val)) {
            tagsArray.push(val);
            input.value = '';
            renderTags(container, tagsArray, (idx) => {
              tagsArray.splice(idx, 1);
              renderTags(container, tagsArray, arguments.callee);
            });
          }
        }
      });
      // Handle backspace to delete last tag if input is empty
      input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && input.value === '' && tagsArray.length > 0) {
              tagsArray.pop();
              renderTags(container, tagsArray, (idx) => {
                  tagsArray.splice(idx, 1);
                  renderTags(container, tagsArray, arguments.callee);
              });
          }
      });
    }

    // LOAD DATA
    async function loadProduct() {
      try {
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'GET', type: 'PRODUCT', id: productId, owner_id: ownerId })
        });

        let data;
        const text = await response.text();
        try { data = JSON.parse(text); } catch (e) { data = JSON.parse(text.replace(/^"|"$/g, '').replace(/\\"/g, '"')); }
        currentData = data;

        // Populate Form
        document.getElementById('itemName').value = data.identity.item_name;
        document.getElementById('itemSku').value = data.identity.item_sku;
        document.getElementById('itemType').value = data.identity.item_type;
        document.getElementById('descShort').value = data.identity.description.short;
        document.getElementById('descLong').value = data.identity.description.long || '';
        document.getElementById('internalNotes').value = data.identity.description.internal_notes || '';

        document.getElementById('basePrice').value = data.pricing.base_price;
        document.getElementById('currency').value = data.pricing.currency;
        document.getElementById('unitOfMeasure').value = data.pricing.unit_of_measure;
        document.getElementById('taxRate').value = data.pricing.tax_info.tax_rate_percentage;

        document.getElementById('requiresBooking').checked = data.operations.requires_booking;
        document.getElementById('requiresInventory').checked = data.operations.requires_inventory_check;

        skillTags = data.operations.provider_info.required_skill_tags || [];
        keywords = data.identity.keywords || [];

        renderTags(document.getElementById('skillTagsContainer'), skillTags, (idx) => {
          skillTags.splice(idx, 1);
          renderTags(document.getElementById('skillTagsContainer'), skillTags, arguments.callee);
        });
        
        renderTags(document.getElementById('keywordsContainer'), keywords, (idx) => {
          keywords.splice(idx, 1);
          renderTags(document.getElementById('keywordsContainer'), keywords, arguments.callee);
        });

        document.getElementById('pageTitle').textContent = `‚úèÔ∏è ${data.identity.item_name}`;
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');

      } catch (error) {
        console.error('Load error:', error);
        document.getElementById('loadingText').textContent = t.error;
      }
    }

    // SAVE DATA
    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const saveBtn = document.getElementById('saveBtn');
      const originalText = saveBtn.textContent;
      saveBtn.innerHTML = `<div class="spinner" style="width:16px;height:16px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></div> ${t.saving}`;
      saveBtn.disabled = true;

      currentData.identity.item_name = document.getElementById('itemName').value.trim();
      currentData.identity.item_type = document.getElementById('itemType').value;
      currentData.identity.description.short = document.getElementById('descShort').value.trim();
      currentData.identity.description.long = document.getElementById('descLong').value.trim();
      currentData.identity.description.internal_notes = document.getElementById('internalNotes').value.trim();
      currentData.identity.keywords = keywords;

      currentData.pricing.base_price = parseFloat(document.getElementById('basePrice').value);
      currentData.pricing.currency = document.getElementById('currency').value;
      currentData.pricing.unit_of_measure = document.getElementById('unitOfMeasure').value;
      currentData.pricing.tax_info.tax_rate_percentage = parseInt(document.getElementById('taxRate').value);

      currentData.operations.requires_booking = document.getElementById('requiresBooking').checked;
      currentData.operations.requires_inventory_check = document.getElementById('requiresInventory').checked;
      currentData.operations.provider_info.required_skill_tags = skillTags;

      try {
        await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'SAVE', type: 'PRODUCT', id: productId, owner_id: ownerId, payload: currentData
          })
        });

        saveBtn.textContent = t.saved;
        saveBtn.style.background = 'var(--success)';
        tg.HapticFeedback.notificationOccurred('success');
        setTimeout(() => tg.close(), 1200);

      } catch (error) {
        console.error('Save error:', error);
        tg.showAlert(t.error);
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }
    });

    // Initialize Tags
    setupTagInput('skillTagInput', 'skillTagsContainer', skillTags);
    setupTagInput('keywordInput', 'keywordsContainer', keywords);
    
    // Start
    loadProduct();
  </script>
</body>
</html>
