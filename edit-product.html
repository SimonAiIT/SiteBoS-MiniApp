<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Blueprint Editor</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-start: #4a5b8f; --bg-end: #2a3d5f; --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7); --border-color: rgba(255, 255, 255, 0.2);
      --input-bg: rgba(255, 255, 255, 0.08); --accent-color: #5B6FED; --error-color: #ff6b6b;
      --success-color: #4ade80; --stage-bg: rgba(91, 111, 237, 0.15);
      --hover-bg: rgba(255, 255, 255, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text-primary); padding: 20px; min-height: 100vh; padding-bottom: 120px;
    }
    .container { max-width: 700px; margin: 0 auto; }
    h1 { font-size: 24px; margin-bottom: 6px; font-weight: 600; }
    .subtitle { font-size: 13px; color: var(--text-secondary); margin-bottom: 24px; font-weight: 300; }
    .section-title { 
      font-size: 16px; font-weight: 600; margin: 28px 0 16px; 
      padding-bottom: 8px; border-bottom: 1px solid var(--border-color);
    }
    .form-group { margin-bottom: 18px; }
    label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; }
    label.disabled { opacity: 0.5; }
    input, textarea {
      width: 100%; padding: 12px 14px; border: 1px solid var(--border-color);
      border-radius: 12px; background: var(--input-bg); backdrop-filter: blur(10px);
      color: var(--text-primary); font-size: 15px; font-family: inherit;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:disabled { opacity: 0.5; cursor: not-allowed; }
    input:focus, textarea:focus { 
      outline: none; border-color: rgba(255, 255, 255, 0.5); 
      box-shadow: 0 0 15px rgba(91, 111, 237, 0.3); 
    }
    
    /* STAGES & STEPS */
    .stage-card {
      background: var(--stage-bg); border: 1px solid var(--border-color);
      border-radius: 16px; padding: 20px; margin-bottom: 24px;
      backdrop-filter: blur(10px); position: relative;
    }
    .stage-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);
    }
    .stage-title-wrapper { flex: 1; margin-right: 10px; }
    .stage-title-input {
      font-size: 18px; font-weight: 600; background: transparent;
      border: none; color: var(--text-primary); width: 100%;
      padding: 4px 0; margin-bottom: 4px;
    }
    .stage-title-input:focus { outline: none; border-bottom: 1px solid var(--accent-color); }
    
    .step-item {
      background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px; padding: 16px; margin-bottom: 12px; position: relative;
    }
    .step-header {
      display: flex; justify-content: space-between; align-items: start;
      margin-bottom: 10px;
    }
    .step-id { 
      background: rgba(255, 255, 255, 0.15); padding: 3px 8px; 
      border-radius: 6px; font-size: 10px; font-weight: 700; 
      font-family: monospace; margin-bottom: 6px; display: inline-block;
      color: var(--accent-color);
    }
    .step-name-input {
      font-size: 15px; font-weight: 600; margin-bottom: 6px;
      background: transparent; border: none; color: var(--text-primary);
      width: 100%; padding: 4px 0;
    }
    .step-name-input:focus { outline: none; border-bottom: 1px solid var(--accent-color); }
    
    .step-meta {
      display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px;
      color: var(--text-secondary); margin-top: 10px;
    }
    .meta-item {
      background: rgba(255, 255, 255, 0.08); padding: 4px 10px;
      border-radius: 8px; display: inline-flex; align-items: center; gap: 4px;
    }

    /* BUTTONS & CONTROLS */
    .btn-icon {
      background: transparent; border: none; cursor: pointer;
      font-size: 16px; padding: 8px; border-radius: 8px;
      transition: background 0.2s; color: var(--text-secondary);
      display: flex; align-items: center; justify-content: center;
    }
    .btn-icon:hover { background: var(--hover-bg); color: var(--text-primary); }
    .btn-delete { color: var(--error-color); }
    .btn-delete:hover { background: rgba(255, 107, 107, 0.15); }
    
    .btn-add-step {
      width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.05);
      border: 1px dashed var(--border-color); border-radius: 10px;
      color: var(--text-secondary); font-size: 13px; cursor: pointer;
      transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn-add-step:hover { background: rgba(255, 255, 255, 0.1); color: var(--text-primary); border-color: var(--text-secondary); }

    .btn-add-stage {
      width: 100%; padding: 16px; background: rgba(91, 111, 237, 0.1);
      border: 2px dashed var(--accent-color); border-radius: 16px;
      color: var(--accent-color); font-size: 15px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-add-stage:hover { background: rgba(91, 111, 237, 0.2); transform: translateY(-2px); }

    .collapsible-content { 
      max-height: 0; overflow: hidden; 
      transition: max-height 0.3s ease, padding 0.3s ease; 
    }
    .collapsible-content.open { max-height: 2000px; padding-top: 12px; }

    /* FOOTER ACTIONS */
    .button-container { 
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 12px; width: calc(100% - 40px); max-width: 700px;
      background: rgba(42, 61, 95, 0.9); backdrop-filter: blur(15px);
      padding: 12px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid var(--border-color); z-index: 100;
    }
    button.primary {
      flex: 1; padding: 14px; border: none; border-radius: 12px;
      font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s;
      background: var(--accent-color); color: var(--text-primary);
      box-shadow: 0 4px 15px rgba(91, 111, 237, 0.3);
    }
    button.primary:disabled { background: #555; cursor: not-allowed; opacity: 0.6; box-shadow: none; }
    button.primary.success { background: var(--success-color); box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3); color: #000; }
    
    .spinner { 
      border: 3px solid rgba(255,255,255,0.2); border-top: 3px solid #fff; 
      border-radius: 50%; width: 18px; height: 18px; 
      animation: spin 0.8s linear infinite; display: inline-block; margin-right: 8px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .loading-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(42, 61, 95, 0.95); display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 1000;
    }
    .loading-text { margin-top: 20px; font-size: 16px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
    <div class="loading-text" id="txtLoading">Loading...</div>
  </div>

  <div class="container" id="mainContent" style="display: none;">
    <h1 id="pageTitle">Blueprint</h1>
    <p class="subtitle" id="pageSubtitle">Definisci il processo.</p>
    
    <form id="blueprintForm">
      <div class="section-title" id="lblInfo">‚ÑπÔ∏è Info</div>
      
      <div class="form-group">
        <label class="disabled">Service SKU</label>
        <input type="text" id="serviceSku" disabled>
      </div>

      <div class="form-group">
        <label id="lblDesc">Descrizione</label>
        <textarea id="blueprintDesc" rows="2"></textarea>
      </div>

      <div class="section-title" id="lblStages">üéØ Fasi</div>
      <div id="stagesContainer"></div>

      <button type="button" class="btn-add-stage" onclick="addStage()">
        <span id="btnAddStage">‚ûï Aggiungi Fase</span>
      </button>

      <div class="button-container">
        <button type="submit" class="primary" id="saveBtn">üíæ Salva</button>
      </div>
    </form>
  </div>

  <script>
    const WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/e742c7c8-107e-4328-882e-c13459413424";
    
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LOCALIZATION SYSTEM (6 Languages)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const translations = {
      it: {
        title: "üìã Blueprint Operativo", subtitle: "Definisci il processo esatto di esecuzione.",
        lblInfo: "‚ÑπÔ∏è Informazioni Generali", lblDesc: "Descrizione Blueprint",
        lblStages: "üéØ Fasi Operative (Stages)",
        btnAddStage: "‚ûï Aggiungi Nuova Fase", btnSave: "üíæ Salva Modifiche",
        loading: "Caricamento Blueprint...", saving: "Salvataggio...", saved: "‚úÖ Salvato!", error: "‚ùå Errore",
        phDesc: "A cosa serve questo processo?",
        phStageDesc: "Descrizione della fase...", phStepInstr: "Istruzioni operative...",
        lblQC: "Controllo Qualit√†", phQC: "Cosa verificare?",
        lblSkills: "Skill Richieste (CSV)", phSkills: "Es: Developer, Legal...",
        newStageDefault: "Nuova Fase Operativa", newStepDefault: "Nuovo Step",
        confirmDelStage: "Sei sicuro di voler eliminare questa intera fase e tutti i suoi step?",
        confirmDelStep: "Eliminare questo step?",
        btnAddStep: "‚ûï Aggiungi Step in questa fase",
        min: "min"
      },
      en: {
        title: "üìã Operational Blueprint", subtitle: "Define the exact execution process.",
        lblInfo: "‚ÑπÔ∏è General Information", lblDesc: "Blueprint Description",
        lblStages: "üéØ Operational Stages",
        btnAddStage: "‚ûï Add New Stage", btnSave: "üíæ Save Changes",
        loading: "Loading Blueprint...", saving: "Saving...", saved: "‚úÖ Saved!", error: "‚ùå Error",
        phDesc: "What is this process for?",
        phStageDesc: "Stage description...", phStepInstr: "Operating instructions...",
        lblQC: "Quality Check", phQC: "What to verify?",
        lblSkills: "Required Skills (CSV)", phSkills: "E.g.: Developer, Legal...",
        newStageDefault: "New Operational Stage", newStepDefault: "New Step",
        confirmDelStage: "Are you sure you want to delete this entire stage and all its steps?",
        confirmDelStep: "Delete this step?",
        btnAddStep: "‚ûï Add Step here",
        min: "min"
      },
      fr: {
        title: "üìã Blueprint Op√©rationnel", subtitle: "D√©finir le processus d'ex√©cution exact.",
        lblInfo: "‚ÑπÔ∏è Informations G√©n√©rales", lblDesc: "Description du Blueprint",
        lblStages: "üéØ Phases Op√©rationnelles",
        btnAddStage: "‚ûï Ajouter Nouvelle Phase", btnSave: "üíæ Enregistrer",
        loading: "Chargement...", saving: "Enregistrement...", saved: "‚úÖ Enregistr√© !", error: "‚ùå Erreur",
        phDesc: "√Ä quoi sert ce processus ?",
        phStageDesc: "Description de la phase...", phStepInstr: "Instructions op√©rationnelles...",
        lblQC: "Contr√¥le Qualit√©", phQC: "Quoi v√©rifier ?",
        lblSkills: "Comp√©tences Requises (CSV)", phSkills: "Ex: D√©veloppeur, Juriste...",
        newStageDefault: "Nouvelle Phase", newStepDefault: "Nouvelle √âtape",
        confirmDelStage: "Voulez-vous vraiment supprimer cette phase enti√®re et toutes ses √©tapes ?",
        confirmDelStep: "Supprimer cette √©tape ?",
        btnAddStep: "‚ûï Ajouter √âtape",
        min: "min"
      },
      de: {
        title: "üìã Operativer Blueprint", subtitle: "Definieren Sie den genauen Ausf√ºhrungsprozess.",
        lblInfo: "‚ÑπÔ∏è Allgemeine Informationen", lblDesc: "Blueprint-Beschreibung",
        lblStages: "üéØ Operative Phasen",
        btnAddStage: "‚ûï Neue Phase hinzuf√ºgen", btnSave: "üíæ √Ñnderungen speichern",
        loading: "Laden...", saving: "Speichern...", saved: "‚úÖ Gespeichert!", error: "‚ùå Fehler",
        phDesc: "Wozu dient dieser Prozess?",
        phStageDesc: "Beschreibung der Phase...", phStepInstr: "Arbeitsanweisungen...",
        lblQC: "Qualit√§tspr√ºfung", phQC: "Was ist zu √ºberpr√ºfen?",
        lblSkills: "Erforderliche F√§higkeiten (CSV)", phSkills: "Z.B.: Entwickler, Anwalt...",
        newStageDefault: "Neue Operative Phase", newStepDefault: "Neuer Schritt",
        confirmDelStage: "Sind Sie sicher, dass Sie diese gesamte Phase und alle Schritte l√∂schen m√∂chten?",
        confirmDelStep: "Diesen Schritt l√∂schen?",
        btnAddStep: "‚ûï Schritt hinzuf√ºgen",
        min: "Min"
      },
      es: {
        title: "üìã Blueprint Operativo", subtitle: "Defina el proceso exacto de ejecuci√≥n.",
        lblInfo: "‚ÑπÔ∏è Informaci√≥n General", lblDesc: "Descripci√≥n del Blueprint",
        lblStages: "üéØ Fases Operativas",
        btnAddStage: "‚ûï A√±adir Nueva Fase", btnSave: "üíæ Guardar Cambios",
        loading: "Cargando...", saving: "Guardando...", saved: "‚úÖ ¬°Guardado!", error: "‚ùå Error",
        phDesc: "¬øPara qu√© sirve este proceso?",
        phStageDesc: "Descripci√≥n de la fase...", phStepInstr: "Instrucciones operativas...",
        lblQC: "Control de Calidad", phQC: "¬øQu√© verificar?",
        lblSkills: "Habilidades Requeridas (CSV)", phSkills: "Ej: Desarrollador, Legal...",
        newStageDefault: "Nueva Fase Operativa", newStepDefault: "Nuevo Paso",
        confirmDelStage: "¬øEst√° seguro de que desea eliminar esta fase entera y todos sus pasos?",
        confirmDelStep: "¬øEliminar este paso?",
        btnAddStep: "‚ûï A√±adir Paso aqu√≠",
        min: "min"
      },
      pt: {
        title: "üìã Blueprint Operacional", subtitle: "Defina o processo exato de execu√ß√£o.",
        lblInfo: "‚ÑπÔ∏è Informa√ß√µes Gerais", lblDesc: "Descri√ß√£o do Blueprint",
        lblStages: "üéØ Fases Operacionais",
        btnAddStage: "‚ûï Adicionar Nova Fase", btnSave: "üíæ Salvar Altera√ß√µes",
        loading: "Carregando...", saving: "Salvando...", saved: "‚úÖ Salvo!", error: "‚ùå Erro",
        phDesc: "Para que serve este processo?",
        phStageDesc: "Descri√ß√£o da fase...", phStepInstr: "Instru√ß√µes operacionais...",
        lblQC: "Controle de Qualidade", phQC: "O que verificar?",
        lblSkills: "Habilidades Necess√°rias (CSV)", phSkills: "Ex: Desenvolvedor, Legal...",
        newStageDefault: "Nova Fase Operacional", newStepDefault: "Novo Passo",
        confirmDelStage: "Tem certeza que deseja excluir esta fase inteira e todos os seus passos?",
        confirmDelStep: "Excluir este passo?",
        btnAddStep: "‚ûï Adicionar Passo aqui",
        min: "min"
      }
    };

    const urlParams = new URLSearchParams(window.location.search);
    const blueprintId = urlParams.get('id');
    const ownerId = urlParams.get('owner');
    const langParam = urlParams.get('lang') || urlParams.get('language') || 'it';
    
    // Select language (fallback to 'it')
    const t = translations[langParam] || translations['it'];

    let currentData = null;

    // Apply static translations
    function applyTranslations() {
        document.title = t.title;
        document.getElementById('pageTitle').textContent = t.title;
        document.getElementById('pageSubtitle').textContent = t.subtitle;
        document.getElementById('lblInfo').textContent = t.lblInfo;
        document.getElementById('lblDesc').textContent = t.lblDesc;
        document.getElementById('blueprintDesc').placeholder = t.phDesc;
        document.getElementById('lblStages').textContent = t.lblStages;
        document.getElementById('btnAddStage').textContent = t.btnAddStage;
        document.getElementById('saveBtn').textContent = t.btnSave;
        document.getElementById('txtLoading').textContent = t.loading;
    }
    applyTranslations();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LOGIC: RE-INDEXING & UPDATES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateIndexes() {
      if (!currentData || !currentData.stages) return;
      
      let totalMinutes = 0;

      currentData.stages.forEach((stage, sIdx) => {
        stage.stage_order = sIdx + 1;
        stage.stage_id = `STAGE_${String(sIdx + 1).padStart(2, '0')}`;
        if (!stage.steps) stage.steps = [];

        stage.steps.forEach((step, stIdx) => {
          step.step_order = stIdx + 1;
          step.step_id = `STEP_${String(sIdx + 1).padStart(2, '0')}_${String(stIdx + 1).padStart(2, '0')}`;
          totalMinutes += parseInt(step.estimated_time_minutes || 0);
        });
      });

      if (!currentData.summary) currentData.summary = {};
      currentData.summary.estimated_total_time_minutes = totalMinutes;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ACTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.addStage = function() {
      const newStage = {
        stage_id: "", 
        stage_order: 0,
        stage_name: t.newStageDefault,
        description: "",
        steps: []
      };
      currentData.stages.push(newStage);
      updateIndexes();
      renderStages(currentData.stages);
      setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
    };

    window.removeStage = function(index) {
      if(confirm(t.confirmDelStage)) {
        currentData.stages.splice(index, 1);
        updateIndexes();
        renderStages(currentData.stages);
      }
    };

    window.addStep = function(stageIndex) {
      const newStep = {
        step_id: "",
        step_order: 0,
        step_name: t.newStepDefault,
        instructions: "",
        estimated_time_minutes: 15,
        resources_needed: { labor: { required_skill_tags: [] }, materials: [], assets: [] },
        quality_check: null
      };
      currentData.stages[stageIndex].steps.push(newStep);
      updateIndexes();
      renderStages(currentData.stages);
    };

    window.removeStep = function(stageIndex, stepIndex) {
      if(confirm(t.confirmDelStep)) {
        currentData.stages[stageIndex].steps.splice(stepIndex, 1);
        updateIndexes();
        renderStages(currentData.stages);
      }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UI RENDERER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderStages(stages) {
      const container = document.getElementById('stagesContainer');
      container.innerHTML = '';

      stages.forEach((stage, stageIdx) => {
        const stageCard = document.createElement('div');
        stageCard.className = 'stage-card';
        
        // STAGE HEADER
        const stageHeader = document.createElement('div');
        stageHeader.className = 'stage-header';
        stageHeader.innerHTML = `
          <div class="stage-title-wrapper">
            <div style="font-size: 10px; color: var(--accent-color); font-weight:bold; margin-bottom:4px;">${stage.stage_id}</div>
            <input type="text" class="stage-title-input" value="${stage.stage_name}" 
                   onchange="updateData('stages[${stageIdx}].stage_name', this.value)">
            <textarea style="width: 100%; margin-top: 4px; min-height: 40px; font-size: 13px; color: var(--text-secondary); background: transparent; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px;"
                      onchange="updateData('stages[${stageIdx}].description', this.value)" placeholder="${t.phStageDesc}">${stage.description || ''}</textarea>
          </div>
          <button type="button" class="btn-icon btn-delete" onclick="removeStage(${stageIdx})">
            üóëÔ∏è
          </button>
        `;
        stageCard.appendChild(stageHeader);

        // STEPS LIST
        if (stage.steps && stage.steps.length > 0) {
          stage.steps.forEach((step, stepIdx) => {
            const stepItem = document.createElement('div');
            stepItem.className = 'step-item';
            
            stepItem.innerHTML = `
              <div class="step-header">
                <div style="flex: 1; padding-right: 10px;">
                  <div class="step-id">${step.step_id}</div>
                  <input type="text" class="step-name-input" value="${step.step_name}"
                         onchange="updateData('stages[${stageIdx}].steps[${stepIdx}].step_name', this.value)">
                  
                  <textarea style="width: 100%; background: transparent; border: none; color: var(--text-secondary); padding: 4px 0; min-height: 50px; font-size: 13px; line-height: 1.4;"
                            onchange="updateData('stages[${stageIdx}].steps[${stepIdx}].instructions', this.value)" placeholder="${t.phStepInstr}">${step.instructions || ''}</textarea>
                  
                  <div class="step-meta">
                    <span class="meta-item">
                      ‚è±Ô∏è <input type="number" min="0" style="width: 40px; background: transparent; border: none; color: white; padding: 0; text-align: center;"
                               value="${step.estimated_time_minutes || 0}"
                               onchange="updateData('stages[${stageIdx}].steps[${stepIdx}].estimated_time_minutes', this.value)"> ${t.min}
                    </span>
                  </div>
                </div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                  <button type="button" class="btn-icon btn-delete" onclick="removeStep(${stageIdx}, ${stepIdx})">üóëÔ∏è</button>
                  <button type="button" class="btn-icon" onclick="toggleStep(${stageIdx}, ${stepIdx})">
                    ${step.quality_check ? 'üìã' : '‚öôÔ∏è'}
                  </button>
                </div>
              </div>

              <div class="collapsible-content" id="step-${stageIdx}-${stepIdx}">
                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; margin-top:8px;">
                  <div style="margin-bottom: 12px;">
                    <div style="font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">${t.lblQC}</div>
                    <textarea style="width: 100%; min-height: 50px; font-size: 12px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; color: var(--text-primary);"
                              onchange="updateNestedData(${stageIdx}, ${stepIdx}, 'quality_check.check_description', this.value)"
                              placeholder="${t.phQC}">${step.quality_check?.check_description || ''}</textarea>
                  </div>
                  <div>
                    <div style="font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">${t.lblSkills}</div>
                    <input type="text" style="font-size: 12px; padding: 8px;" 
                           value="${(step.resources_needed?.labor?.required_skill_tags || []).join(', ')}"
                           onchange="updateSkills(${stageIdx}, ${stepIdx}, this.value)"
                           placeholder="${t.phSkills}">
                  </div>
                </div>
              </div>
            `;
            stageCard.appendChild(stepItem);
          });
        }

        // ADD STEP BUTTON
        const addStepBtn = document.createElement('button');
        addStepBtn.type = 'button';
        addStepBtn.className = 'btn-add-step';
        addStepBtn.innerHTML = `<span>${t.btnAddStep}</span>`;
        addStepBtn.onclick = () => addStep(stageIdx);
        stageCard.appendChild(addStepBtn);

        container.appendChild(stageCard);
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DATA UPDATERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.updateData = function(path, value) {
        let obj = currentData;
        const keys = path.replace(/\]/g, '').split(/[\[\.]/); 
        
        keys.forEach((key, index) => {
            if (index === keys.length - 1) {
                if (key === 'estimated_time_minutes') value = parseInt(value) || 0;
                obj[key] = value;
            } else {
                obj = obj[key];
            }
        });
        if(path.includes('estimated_time_minutes')) updateIndexes(); 
    };

    window.updateNestedData = function(sIdx, stIdx, keyPath, value) {
        let target = currentData.stages[sIdx].steps[stIdx];
        const keys = keyPath.split('.');
        if (keys[0] === 'quality_check' && !target.quality_check) target.quality_check = {};
        keys.forEach((key, index) => {
            if (index === keys.length - 1) target[key] = value;
            else target = target[key];
        });
    };

    window.updateSkills = function(sIdx, stIdx, value) {
        const tags = value.split(',').map(t => t.trim()).filter(t => t);
        if (!currentData.stages[sIdx].steps[stIdx].resources_needed) currentData.stages[sIdx].steps[stIdx].resources_needed = { labor: {} };
        if (!currentData.stages[sIdx].steps[stIdx].resources_needed.labor) currentData.stages[sIdx].steps[stIdx].resources_needed.labor = {};
        currentData.stages[sIdx].steps[stIdx].resources_needed.labor.required_skill_tags = tags;
    };

    window.toggleStep = function(stageIdx, stepIdx) {
      const el = document.getElementById(`step-${stageIdx}-${stepIdx}`);
      el.classList.toggle('open');
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LOAD & SAVE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadBlueprint() {
      try {
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'GET', type: 'BLUEPRINT', id: blueprintId, owner_id: ownerId })
        });

        let data;
        const text = await response.text();
        try { data = JSON.parse(text); } catch (e) { data = JSON.parse(text.replace(/^"|"$/g, '').replace(/\\"/g, '"')); }

        currentData = data;
        document.getElementById('serviceSku').value = data.service_sku || '';
        document.getElementById('blueprintDesc').value = data.blueprint_description || '';
        
        updateIndexes();
        renderStages(data.stages);

        document.getElementById('pageTitle').textContent = `üìã ${data.service_sku}`;
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('mainContent').style.display = 'block';

      } catch (error) {
        console.error(error);
        document.getElementById('txtLoading').textContent = t.error;
      }
    }

    document.getElementById('blueprintForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.innerHTML = `<div class="spinner"></div> ${t.saving}`;
      saveBtn.disabled = true;

      currentData.blueprint_description = document.getElementById('blueprintDesc').value.trim();
      updateIndexes();

      try {
        await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'SAVE', type: 'BLUEPRINT', id: blueprintId, owner_id: ownerId, payload: currentData })
        });

        saveBtn.textContent = t.saved;
        saveBtn.classList.add('success');
        setTimeout(() => tg.close(), 1000);
      } catch (error) {
        saveBtn.textContent = t.error;
        saveBtn.disabled = false;
      }
    });

    loadBlueprint();
  </script>
</body>
</html>
