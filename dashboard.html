<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Manager Desk</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Stili specifici per la Dashboard */
    .dashboard-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border);
    }
    .welcome-text h1 { font-size: 20px; margin: 0; }
    .welcome-text small { color: var(--text-muted); }
    .status-badge { 
      padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold;
      background: rgba(76, 217, 100, 0.2); color: var(--success); border: 1px solid var(--success);
    }

    /* Grid Dashboard */
    .dash-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;
    }
    .dash-card {
      background: var(--card-bg); border: 1px solid var(--glass-border);
      border-radius: var(--radius-md); padding: 20px;
      display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px;
      transition: transform 0.2s, background 0.2s; cursor: pointer;
    }
    .dash-card:hover { transform: translateY(-3px); background: var(--hover-bg); }
    .dash-icon {
      width: 45px; height: 45px; border-radius: 50%;
      background: rgba(91, 111, 237, 0.15); color: var(--primary);
      display: flex; align-items: center; justify-content: center; font-size: 20px;
    }
    .dash-label { font-size: 14px; font-weight: 600; color: #fff; }
    .dash-stat { font-size: 11px; color: var(--text-muted); }

    /* Notification Area (Feed) */
    .feed-section { margin-top: 30px; }
    .feed-item {
      display: flex; align-items: center; gap: 15px;
      padding: 15px; background: rgba(0,0,0,0.2); border-radius: var(--radius-sm);
      margin-bottom: 10px; border-left: 3px solid var(--primary);
    }
    .feed-item.urgent { border-left-color: var(--error); background: rgba(255, 107, 107, 0.05); }
    .feed-icon { color: var(--text-muted); font-size: 16px; }
    .feed-content h4 { margin: 0; font-size: 14px; }
    .feed-content p { margin: 0; font-size: 12px; color: var(--text-muted); }
    .feed-time { margin-left: auto; font-size: 10px; color: var(--text-secondary); }

    /* Quick Actions FAB */
    .fab-container {
      position: fixed; bottom: 20px; right: 20px; z-index: 100;
    }
    .fab-main {
      width: 56px; height: 56px; border-radius: 50%; background: var(--primary);
      color: #fff; border: none; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="loader"><div class="spinner"></div></div>

  <div id="app-content" class="hidden">
    
    <!-- HEADER -->
    <div class="dashboard-header">
      <div class="welcome-text">
        <h1 id="companyName">Caricamento...</h1>
        <small id="vatDisplay">P.IVA: ...</small>
      </div>
      <div class="status-badge" id="aiStatus">AI ACTIVE</div>
    </div>

    <!-- MAIN METRICS (Optional - Placeholder for now) -->
    <!-- <div class="row">
       <div class="col card text-center"><h3>12</h3><small>Appuntamenti</small></div>
       <div class="col card text-center"><h3>5</h3><small>Ordini</small></div>
    </div> -->

    <!-- NAVIGATION GRID -->
    <div class="section-title">Gestione Operativa</div>
    <div class="dash-grid">
      
      <!-- 1. Knowledge Base (Honeypot) -->
      <div class="dash-card" onclick="navTo('honeypot_editor.html')">
        <div class="dash-icon"><i class="fas fa-brain"></i></div>
        <div class="dash-label">Cervello AI</div>
        <div class="dash-stat">Gestisci Risposte</div>
      </div>

      <!-- 2. Prodotti / Servizi -->
      <div class="dash-card" onclick="navTo('add-product.html')"> <!-- O una lista prodotti -->
        <div class="dash-icon"><i class="fas fa-box-open"></i></div>
        <div class="dash-label">Catalogo</div>
        <div class="dash-stat">Prodotti & Servizi</div>
      </div>

      <!-- 3. Agenda / Calendario -->
      <div class="dash-card" onclick="navTo('calendar.html')">
        <div class="dash-icon"><i class="fas fa-calendar-alt"></i></div>
        <div class="dash-label">Agenda</div>
        <div class="dash-stat">Appuntamenti</div>
      </div>

      <!-- 4. Blueprints (Processi) -->
      <div class="dash-card" onclick="navTo('edit-blueprint.html')"> 
        <div class="dash-icon"><i class="fas fa-project-diagram"></i></div>
        <div class="dash-label">Processi</div>
        <div class="dash-stat">Workflow</div>
      </div>

      <!-- 5. Configurazione Azienda -->
      <div class="dash-card" onclick="navTo('edit_owner.html')">
        <div class="dash-icon"><i class="fas fa-cogs"></i></div>
        <div class="dash-label">Configurazione</div>
        <div class="dash-stat">Dati & Orari</div>
      </div>

      <!-- 6. Public View (Preview) -->
      <div class="dash-card" onclick="navTo('SiteBos.html')">
        <div class="dash-icon"><i class="fas fa-eye"></i></div>
        <div class="dash-label">Anteprima</div>
        <div class="dash-stat">Vista Cliente</div>
      </div>

    </div>

    <!-- LIVE FEED (Notifiche Recenti) -->
    <div class="section-title">Attivit√† Recenti</div>
    <div id="feed-container" class="feed-section">
      <!-- Populated via JS -->
      <div class="text-center" style="color:var(--text-secondary); font-size:12px;">Nessuna nuova notifica.</div>
    </div>

  </div>

  <!-- FAB per azioni rapide -->
  <div class="fab-container">
    <button class="fab-main" onclick="tg.showPopup({message:'Presto potrai creare note veloci da qui!'})">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    // PARAMETRI URL
    const urlParams = new URLSearchParams(window.location.search);
    const vat = urlParams.get('vat');
    const ownerId = urlParams.get('owner');

    // N8N WEBHOOK per recuperare i dati Dashboard (Statistiche, Nome azienda, ecc.)
    // Usa lo stesso webhook iniziale, ma con action 'get_dashboard_data'
    const DASHBOARD_API = "https://trinai.api.workflow.dcmake.it/webhook/ef4aece4-9ec0-4026-a7a7-328562bcbdf6"; 

    async function init() {
      if(!vat) {
        document.body.innerHTML = "<h3 style='text-align:center; margin-top:50px;'>Errore: Nessuna P.IVA specificata. Avvia dal Bot Telegram.</h3>";
        return;
      }

      try {
        // Simuliamo caricamento dati dashboard (o fai la fetch reale)
        const res = await fetch(DASHBOARD_API, {
           method: 'POST',
           headers: {'Content-Type': 'application/json'},
           body: JSON.stringify({ action: 'get_dashboard_data', vat_number: vat, chat_id: ownerId })
        });
        
        // Se non hai ancora il backend pronto per questo, usa dati mock per ora:
        /*
        const data = await res.json(); 
        */
        // MOCK DATA per visualizzare l'UI
        const data = {
            company_name: urlParams.get('ragione_sociale') || "La Mia Azienda",
            vat_number: vat,
            notifications: [
                { title: "Nuovo Ordine", text: "Cliente Rossi ha ordinato un servizio.", time: "10:30", type: "urgent" },
                { title: "AI Training", text: "Analisi documenti completata.", time: "09:15", type: "info" }
            ]
        };

        // RENDER
        document.getElementById('companyName').innerText = data.company_name;
        document.getElementById('vatDisplay').innerText = `P.IVA: ${data.vat_number}`;
        
        const feed = document.getElementById('feed-container');
        if(data.notifications && data.notifications.length > 0) {
            feed.innerHTML = data.notifications.map(n => `
                <div class="feed-item ${n.type === 'urgent' ? 'urgent' : ''}">
                    <div class="feed-icon"><i class="fas fa-${n.type === 'urgent' ? 'bell' : 'info-circle'}"></i></div>
                    <div class="feed-content">
                        <h4>${n.title}</h4>
                        <p>${n.text}</p>
                    </div>
                    <div class="feed-time">${n.time}</div>
                </div>
            `).join('');
        }

        document.getElementById('loader').classList.add('hidden');
        document.getElementById('app-content').classList.remove('hidden');

      } catch (e) {
        console.error(e);
        tg.showAlert("Errore caricamento Dashboard.");
      }
    }

    // Navigazione intelligente: passa sempre i parametri di contesto (vat, owner, lang)
    window.navTo = function(page) {
      const currentParams = new URLSearchParams(window.location.search);
      // Assicuriamoci che i parametri chiave siano presenti
      if(!currentParams.has('vat')) currentParams.set('vat', vat);
      if(!currentParams.has('owner')) currentParams.set('owner', ownerId);
      
      // Mappatura per i file specifici che usano nomi parametri diversi (legacy)
      // Esempio: honeypot usa 'vat', edit-product usa 'owner_id' etc.
      // Per sicurezza passiamo tutto.
      
      let targetUrl = `${page}?${currentParams.toString()}`;
      
      // Fix specifici per le tue pagine esistenti se necessario:
      if(page === 'SiteBos.html') targetUrl += `&vat_number=${vat}`; // SiteBos usa vat_number
      
      window.location.href = targetUrl;
    }

    init();
  </script>
</body>
</html>
