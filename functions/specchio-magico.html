<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Specchio Magico AI - SiteBoS</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../styles.css">
  <style>
    .camera-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
    }
    
    #video-preview {
      width: 100%;
      display: block;
    }
    
    #canvas-preview {
      display: none;
    }
    
    .camera-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .capture-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: white;
      border: 4px solid var(--primary);
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .capture-btn:active {
      transform: scale(0.95);
    }
    
    .camera-toggle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      border: 2px solid white;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .camera-toggle:active {
      transform: scale(0.95);
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .info-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      border: 1px solid var(--glass-border);
    }
    
    .info-item i {
      font-size: 20px;
    }
    
    .info-content .label {
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
      display: block;
    }
    
    .info-content .value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .color-swatches {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    
    .color-swatch {
      width: 45px;
      height: 45px;
      border-radius: 10px;
      border: 2px solid var(--glass-border);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .color-swatch:hover {
      transform: scale(1.1);
      border-color: var(--primary);
    }
    
    .share-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    
    .share-btn {
      padding: 12px;
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    
    .share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    
    .share-btn i {
      font-size: 24px;
    }
  </style>
</head>
<body>

  <div id="loader" class="hidden">
    <div class="spinner-ring"></div>
    <div style="margin-top:10px; opacity:0.7; text-align:center;" id="loader-text">Caricamento...</div>
  </div>

  <div class="container" id="app-content">
    
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border);">
        <div>
            <h1 style="font-size: 22px; margin: 0;">
                <i class="fas fa-magic" style="color: var(--warning);"></i>
                Specchio Magico AI
            </h1>
            <p class="subtitle">Analisi look personalizzata</p>
        </div>
    </div>

    <div id="unlock-check" class="card">
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 64px; color: var(--warning); margin-bottom: 20px;">
                <i class="fas fa-magic"></i>
            </div>
            <h2 style="margin-bottom: 15px;">Sblocca Specchio Magico AI</h2>
            <p style="color: var(--text-muted); line-height: 1.6; max-width: 400px; margin: 0 auto 30px;">
                Analisi illimitate del look dei tuoi clienti con intelligenza artificiale.
            </p>
            
            <div class="note note-warning" style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;">
                    15.000 crediti
                </div>
                <div style="font-size: 12px; text-transform: uppercase;">
                    Sblocco Permanente (~33â‚¬)
                </div>
            </div>
            
            <button class="btn" onclick="unlockFeature()">
                <i class="fas fa-unlock"></i> Sblocca Ora
            </button>
        </div>
    </div>

    <div id="camera-section" class="hidden">
        <div class="note" style="margin-bottom: 20px;">
            <i class="fas fa-info-circle"></i> <strong>Consigli:</strong> Viso frontale, buona illuminazione, sfondo neutro
        </div>
        
        <div class="card">
            <div class="camera-container">
                <video id="video-preview" autoplay playsinline></video>
                <canvas id="canvas-preview"></canvas>
                
                <div class="camera-controls">
                    <button class="camera-toggle" onclick="toggleCamera()" title="Cambia Camera">
                        <i class="fas fa-sync-alt" style="font-size: 20px;"></i>
                    </button>
                    
                    <button class="capture-btn" onclick="capturePhoto()" title="Scatta Foto">
                        <i class="fas fa-camera" style="font-size: 28px; color: var(--primary);"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <button class="btn btn-secondary" onclick="stopCamera()" style="margin-top: 15px; width: 100%;">
            <i class="fas fa-times"></i> Annulla
        </button>
    </div>

    <div id="preview-section" class="hidden">
        <div class="card">
            <img id="photo-preview" style="width: 100%; border-radius: 12px; margin-bottom: 20px;">
            
            <div class="btn-container">
                <button class="btn btn-secondary" onclick="retakePhoto()">
                    <i class="fas fa-redo"></i> Riscatta
                </button>
                <button class="btn" onclick="analyzePhoto()">
                    <i class="fas fa-sparkles"></i> Analizza
                </button>
            </div>
        </div>
    </div>

    <div id="results-section" class="hidden">
        <div class="card">
            <canvas id="before-after-canvas" style="display: none;"></canvas>
            <img id="before-after-img" style="width: 100%; border-radius: 12px;">
        </div>
        
        <div class="card" style="margin-top: 15px;">
            <h3 style="margin: 0 0 15px 0;">ðŸ“Š Analisi Professionale</h3>
            
            <div class="info-grid">
                <div class="info-item">
                    <i class="fas fa-user-circle" style="color: var(--primary);"></i>
                    <div class="info-content">
                        <span class="label">Forma Viso</span>
                        <span class="value" id="face-shape">...</span>
                    </div>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-cut" style="color: var(--warning);"></i>
                    <div class="info-content">
                        <span class="label">Tipo Capelli</span>
                        <span class="value" id="hair-type">...</span>
                    </div>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-ruler-vertical" style="color: var(--info);"></i>
                    <div class="info-content">
                        <span class="label">Lunghezza</span>
                        <span class="value" id="hair-length">...</span>
                    </div>
                </div>
                
                <div class="info-item">
                    <i class="fas fa-palette" style="color: var(--success);"></i>
                    <div class="info-content">
                        <span class="label">Carnagione</span>
                        <span class="value" id="skin-tone">...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-top: 15px;">
            <h3 style="margin: 0 0 15px 0;">
                <i class="fas fa-star" style="color: var(--warning);"></i> Look Consigliato
            </h3>
            
            <h4 id="recommended-cut" style="margin: 0 0 10px 0; font-size: 18px;">...</h4>
            <p id="recommendation-desc" style="margin: 0 0 15px 0; color: var(--text-muted); font-size: 14px; line-height: 1.6;">...</p>
            
            <div style="padding-top: 15px; border-top: 1px solid var(--glass-border);">
                <span style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600;">Palette Colori</span>
                <div id="color-swatches" class="color-swatches"></div>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <div class="btn-container" style="grid-template-columns: 1fr 1fr 1fr;">
                <button class="btn btn-secondary" onclick="newAnalysis()">
                    <i class="fas fa-camera"></i> Nuova
                </button>
                
                <button class="btn" onclick="downloadImage()">
                    <i class="fas fa-download"></i> Salva
                </button>
                
                <button class="btn" onclick="openShareMenu()">
                    <i class="fas fa-share-alt"></i> Condividi
                </button>
            </div>
        </div>
    </div>

  </div>

  <div id="share-overlay" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 450px;">
      <h3 style="margin-bottom: 20px; text-align: center;">
        <i class="fas fa-share-alt"></i> Condividi Risultato
      </h3>
      
      <div class="share-buttons">
        <button class="share-btn" onclick="shareToWhatsApp()" style="background: #25D366;">
          <i class="fab fa-whatsapp"></i>
          <span>WhatsApp</span>
        </button>
        
        <button class="share-btn" onclick="shareToTelegram()" style="background: #0088cc;">
          <i class="fab fa-telegram"></i>
          <span>Telegram</span>
        </button>
        
        <button class="share-btn" onclick="shareToFacebook()" style="background: #1877F2;">
          <i class="fab fa-facebook"></i>
          <span>Facebook</span>
        </button>
        
        <button class="share-btn" onclick="shareToInstagram()" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);">
          <i class="fab fa-instagram"></i>
          <span>Instagram</span>
        </button>
        
        <button class="share-btn" onclick="copyImageLink()" style="background: var(--primary);">
          <i class="fas fa-link"></i>
          <span>Copia</span>
        </button>
        
        <button class="share-btn" onclick="shareNative()" style="background: var(--info);">
          <i class="fas fa-share"></i>
          <span>Altro</span>
        </button>
      </div>
      
      <button class="btn btn-secondary" onclick="closeShareMenu()" style="margin-top: 20px; width: 100%;">
        <i class="fas fa-times"></i> Chiudi
      </button>
    </div>
  </div>

  <div class="fab-container">
    <button class="fab-btn fab-secondary" onclick="goBack()" title="Torna Indietro">
      <i class="fas fa-arrow-left"></i>
    </button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    let currentStream = null;
    let capturedBlob = null;
    let analysisResult = null;
    let facingMode = 'environment';

    function unlockFeature() {
      showLoader('Elaborazione pagamento...');
      setTimeout(() => {
        hideLoader();
        document.getElementById('unlock-check').classList.add('hidden');
        startCamera();
      }, 2000);
    }

    async function startCamera() {
      document.getElementById('camera-section').classList.remove('hidden');
      try {
        currentStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: facingMode,
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          } 
        });
        const video = document.getElementById('video-preview');
        video.srcObject = currentStream;
        
        if (facingMode === 'user') {
          video.style.transform = 'scaleX(-1)';
        } else {
          video.style.transform = 'scaleX(1)';
        }
      } catch (err) {
        console.error('Camera error:', err);
        showToast('Errore accesso camera');
      }
    }

    async function toggleCamera() {
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      
      stopCamera();
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      await startCamera();
    }

    function capturePhoto() {
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
      const video = document.getElementById('video-preview');
      const canvas = document.getElementById('canvas-preview');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      
      if (facingMode === 'user') {
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
      }
      
      ctx.drawImage(video, 0, 0);
      
      canvas.toBlob((blob) => {
        capturedBlob = blob;
        document.getElementById('photo-preview').src = URL.createObjectURL(blob);
        stopCamera();
        document.getElementById('camera-section').classList.add('hidden');
        document.getElementById('preview-section').classList.remove('hidden');
      }, 'image/jpeg', 0.85);
    }

    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
    }

    function retakePhoto() {
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      document.getElementById('preview-section').classList.add('hidden');
      startCamera();
    }

    async function analyzePhoto() {
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
      showLoader('Analizzo il tuo look...');
      document.getElementById('preview-section').classList.add('hidden');
      
      setTimeout(() => {
        analysisResult = {
          analysis: { faceShape: 'Ovale', hairType: 'Mossi', hairLength: 'Medio', skinTone: 'Caldo' },
          recommendations: [{
            cutName: 'Textured Lob',
            description: 'Un long bob scalato che valorizza la tua forma ovale. Le texture morbide donano movimento e modernitÃ .',
            colors: ['#8b6f47', '#a0826d', '#c19a6b']
          }]
        };
        generateBeforeAfter();
        displayResults();
        hideLoader();
      }, 3000);
    }

    function generateBeforeAfter() {
      const canvas = document.getElementById('before-after-canvas');
      canvas.width = 1600;
      canvas.height = 800;
      const ctx = canvas.getContext('2d');
      const img = new Image();
      img.onload = () => {
        ctx.drawImage(img, 0, 0, 800, 800);
        ctx.fillStyle = 'rgba(0,0,0,0.85)';
        ctx.fillRect(0, 0, 800, 60);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 28px Inter';
        ctx.fillText('ðŸ‘¤ Prima', 30, 42);
        
        ctx.fillStyle = '#1a1a2e';
        ctx.fillRect(800, 0, 800, 800);
        ctx.fillStyle = '#f59e0b';
        ctx.font = 'bold 48px Inter';
        ctx.textAlign = 'center';
        ctx.fillText('Look Suggerito', 1200, 380);
        ctx.font = '24px Inter';
        ctx.fillStyle = '#888';
        ctx.fillText(analysisResult.recommendations[0].cutName, 1200, 430);
        
        ctx.textAlign = 'left';
        ctx.fillStyle = 'rgba(0,0,0,0.85)';
        ctx.fillRect(800, 0, 800, 60);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 28px Inter';
        ctx.fillText('âœ¨ Dopo', 830, 42);
        
        ctx.fillStyle = '#4cd964';
        ctx.font = 'bold 80px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('â†’', 800, 440);
        
        document.getElementById('before-after-img').src = canvas.toDataURL('image/jpeg', 0.90);
      };
      img.src = document.getElementById('photo-preview').src;
    }

    function displayResults() {
      document.getElementById('face-shape').textContent = analysisResult.analysis.faceShape;
      document.getElementById('hair-type').textContent = analysisResult.analysis.hairType;
      document.getElementById('hair-length').textContent = analysisResult.analysis.hairLength;
      document.getElementById('skin-tone').textContent = analysisResult.analysis.skinTone;
      
      const reco = analysisResult.recommendations[0];
      document.getElementById('recommended-cut').textContent = reco.cutName;
      document.getElementById('recommendation-desc').textContent = reco.description;
      
      const swatches = document.getElementById('color-swatches');
      swatches.innerHTML = '';
      reco.colors.forEach(color => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.background = color;
        swatches.appendChild(swatch);
      });
      
      document.getElementById('results-section').classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function newAnalysis() {
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      document.getElementById('results-section').classList.add('hidden');
      startCamera();
    }

    function downloadImage() {
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
      const canvas = document.getElementById('before-after-canvas');
      const link = document.createElement('a');
      link.download = `specchio-magico-${Date.now()}.jpg`;
      link.href = canvas.toDataURL('image/jpeg', 0.90);
      link.click();
      showToast('Immagine salvata!');
    }

    function openShareMenu() {
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      document.getElementById('share-overlay').classList.remove('hidden');
    }

    function closeShareMenu() {
      document.getElementById('share-overlay').classList.add('hidden');
    }

    async function shareNative() {
      const canvas = document.getElementById('before-after-canvas');
      canvas.toBlob(async (blob) => {
        const file = new File([blob], 'specchio-magico.jpg', { type: 'image/jpeg' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try {
            await navigator.share({ title: 'Il mio nuovo look!', files: [file] });
            if (tg?.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            closeShareMenu();
          } catch (err) {
            if (err.name !== 'AbortError') console.error(err);
          }
        } else {
          showToast('Condivisione non supportata');
        }
      }, 'image/jpeg', 0.90);
    }

    function shareToWhatsApp() { showToast('Coming soon'); closeShareMenu(); }
    function shareToTelegram() { showToast('Coming soon'); closeShareMenu(); }
    function shareToFacebook() { showToast('Coming soon'); closeShareMenu(); }
    function shareToInstagram() { shareNative(); }
    function copyImageLink() { showToast('Coming soon'); closeShareMenu(); }

    function goBack() {
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      const params = new URLSearchParams(window.location.search);
      window.location.href = `index.html?${params.toString()}`;
    }

    function showLoader(text = 'Caricamento...') {
      document.getElementById('loader-text').textContent = text;
      document.getElementById('loader').classList.remove('hidden');
    }

    function hideLoader() {
      document.getElementById('loader').classList.add('hidden');
    }

    function showToast(message) {
      if (tg?.showPopup) {
        tg.showPopup({ message });
      } else {
        alert(message);
      }
    }

    document.getElementById('share-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'share-overlay') closeShareMenu();
    });
  </script>

</body>
</html>