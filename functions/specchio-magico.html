<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Specchio Magico AI - SiteBoS</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="./specchio-magico-styles.css">
</head>
<body>

  <!-- LOADER -->
  <div id="loader" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
    <div class="spinner-ring"></div>
    <div style="margin-top:15px; opacity:0.8; text-align:center; font-size: 14px;" id="loader-text">Caricamento...</div>
  </div>

  <div class="container" id="app-content">
    
    <!-- HEADER -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border);">
        <div>
            <h1 style="font-size: 22px; margin: 0;">
                <i class="fas fa-magic" style="color: var(--warning);"></i>
                Specchio Magico AI
            </h1>
            <p class="subtitle">Sistema colorimetria professionale multi-brand</p>
        </div>
    </div>

    <!-- ========================================
         FASE 1: BRAND SELECTION (INIZIO DIRETTO)
         ======================================== -->
    <div id="brand-selection">
        <div class="card">
            <h2 style="margin: 0 0 10px 0;">üéØ Configurazione Colorimetria</h2>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 25px;">
                Seleziona il sistema di numerazione del tuo salone
            </p>

            <div class="brand-system-grid">
                <!-- SISTEMA STANDARD -->
                <div class="brand-system-card" onclick="selectSystem('standard')">
                    <div class="system-badge" style="background: var(--primary);">Standard</div>
                    <h3>üåç Sistema Internazionale</h3>
                    <div class="system-example">
                        <div class="example-code">7.2</div>
                        <div class="example-label">Biondo Viola</div>
                    </div>
                    <div class="brand-logos">
                        <span class="brand-tag">L'Or√©al</span>
                        <span class="brand-tag">Inoa</span>
                        <span class="brand-tag">Alfaparf</span>
                        <span class="brand-tag">Fanola</span>
                        <span class="brand-tag">Farmagan</span>
                        <span class="brand-tag">Davines</span>
                    </div>
                    <div class="system-key">
                        <strong>Logica:</strong> .2 = Viola | .6 = Rosso | .7 = Mat
                    </div>
                </div>

                <!-- SISTEMA TEDESCO -->
                <div class="brand-system-card" onclick="selectSystem('german')">
                    <div class="system-badge" style="background: var(--warning);">Tedesco</div>
                    <h3>üá©üá™ Sistema Invertito</h3>
                    <div class="system-example">
                        <div class="example-code">7/6</div>
                        <div class="example-label">Biondo Viola</div>
                    </div>
                    <div class="brand-logos">
                        <span class="brand-tag">Wella</span>
                        <span class="brand-tag">Schwarzkopf</span>
                        <span class="brand-tag">Londa</span>
                        <span class="brand-tag">Kadus</span>
                        <span class="brand-tag">Igora</span>
                    </div>
                    <div class="system-key">
                        <strong>‚ö†Ô∏è Critico:</strong> /6 = Viola | /4 = Rosso | /2 = Mat
                    </div>
                </div>

                <!-- SISTEMA ALFABETICO -->
                <div class="brand-system-card" onclick="selectSystem('alphabetic')">
                    <div class="system-badge" style="background: var(--success);">Alfabetico</div>
                    <h3>üá∫üá∏ Sistema Letterale (USA)</h3>
                    <div class="system-example">
                        <div class="example-code">7V</div>
                        <div class="example-label">Biondo Viola</div>
                    </div>
                    <div class="brand-logos">
                        <span class="brand-tag">Matrix</span>
                        <span class="brand-tag">Redken</span>
                        <span class="brand-tag">Goldwell</span>
                        <span class="brand-tag">Joico</span>
                        <span class="brand-tag">Aveda</span>
                    </div>
                    <div class="system-key">
                        <strong>Logica:</strong> V = Violet | R = Red | M = Matte
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         FASE 2: GENDER SELECTION
         ======================================== -->
    <div id="gender-section" class="hidden">
        <div class="card">
            <h3 style="margin: 0 0 15px 0;">üë§ Seleziona Genere Cliente</h3>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">
                Determina le opzioni di styling disponibili
            </p>
            
            <div class="gender-grid">
                <div class="gender-btn" onclick="selectGender('F')" id="gender-f">
                    <i class="fas fa-venus" style="color: var(--warning);"></i>
                    <span class="label">Donna</span>
                </div>
                
                <div class="gender-btn" onclick="selectGender('M')" id="gender-m">
                    <i class="fas fa-mars" style="color: var(--primary);"></i>
                    <span class="label">Uomo</span>
                </div>
                
                <div class="gender-btn" onclick="selectGender('X')" id="gender-x">
                    <i class="fas fa-rainbow" style="color: var(--success);"></i>
                    <span class="label">Fluid</span>
                    <span style="font-size: 10px; color: var(--text-muted); margin-top: 5px;">Creative Colors</span>
                </div>
            </div>

            <div style="margin-top: 25px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; text-align: center;">
                <p style="margin: 0 0 5px 0; font-size: 12px; color: var(--text-secondary);">Sistema configurato:</p>
                <p style="margin: 0; font-size: 16px; color: var(--primary); font-weight: bold;" id="current-system-label">-</p>
                <p style="margin: 10px 0 5px 0; font-size: 12px; color: var(--text-secondary);">Genere selezionato:</p>
                <p style="margin: 0; font-size: 16px; color: var(--warning); font-weight: bold;" id="selected-gender-label">-</p>
            </div>
        </div>
        
        <button class="btn" onclick="startCamera()" style="margin-top: 15px; width: 100%;" id="btn-start-camera" disabled>
            <i class="fas fa-camera"></i> Scatta Foto Cliente
        </button>
    </div>

    <!-- ========================================
         FASE 3: CAMERA
         ======================================== -->
    <div id="camera-section" class="hidden">
        <div class="note" style="margin-bottom: 20px;">
            <i class="fas fa-info-circle"></i> <strong>Consigli:</strong> Viso frontale, buona illuminazione, sfondo neutro
        </div>
        
        <div class="card" style="padding: 0; overflow: hidden;">
            <div class="camera-container">
                <video id="video-preview" autoplay playsinline></video>
                <canvas id="canvas-preview" style="display: none;"></canvas>
                
                <div class="camera-controls">
                    <button class="camera-toggle" onclick="toggleCamera()" title="Cambia Camera">
                        <i class="fas fa-sync-alt" style="font-size: 18px;"></i>
                    </button>
                    
                    <button class="capture-btn" onclick="capturePhoto()" title="Scatta">
                        <i class="fas fa-camera" style="font-size: 24px; color: var(--primary);"></i>
                    </button>
                    
                    <button class="camera-toggle" onclick="cancelCamera()" title="Annulla">
                        <i class="fas fa-times" style="font-size: 18px;"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         FASE 4A: CLASSIC CONFIGURATION (Donna/Uomo)
         ======================================== -->
    <div id="config-section" class="hidden">
        <!-- Foto Cliente -->
        <div class="card">
            <img id="client-photo" style="width: 100%; border-radius: 12px; display: block;">
        </div>

        <!-- Main Config Card -->
        <div class="card" style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h3 style="margin: 0;">üé® Configurazione Look</h3>
                    <p style="color: var(--text-muted); font-size: 13px; margin: 5px 0 0 0;">
                        Genere: <strong id="selected-gender-label">-</strong>
                    </p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Sistema</div>
                    <div style="font-size: 13px; font-weight: 600; color: var(--primary);" id="current-system-label">-</div>
                </div>
            </div>

            <!-- CAPELLI -->
            <div class="section-header">
                <i class="fas fa-cut" style="color: var(--warning);"></i>
                <h4>Capelli</h4>
            </div>

            <!-- PILASTRO 1: TEXTURE -->
            <label class="input-label">
                <i class="fas fa-spa"></i> Texture Capelli
            </label>
            <select id="hair-texture" class="input">
                <!-- Popolato dinamicamente da JS -->
            </select>

            <!-- Stili Protettivi (mostra solo se Texture = Afro/Coily) -->
            <div id="protective-styles-section" class="hidden" style="margin-top: 15px;">
                <label class="input-label">
                    <i class="fas fa-braid"></i> Stili Protettivi (Opzionale)
                </label>
                <select id="protective-style" class="input">
                    <option value="none">Nessuno (Naturale)</option>
                    <!-- PROTECTIVE_STYLES iniettati da JS -->
                </select>
            </div>

            <label class="input-label" style="margin-top: 15px;">Taglio Desiderato</label>
            <select id="haircut" class="input"></select>

            <!-- NUOVO: STYLING FINISH -->
            <div style="margin-top: 15px;">
                <label class="input-label">
                    <i class="fas fa-wind"></i> Styling & Piega (Il Finish)
                </label>
                <select id="styling-finish" class="input">
                    <!-- STYLING_OPTIONS iniettati da JS -->
                </select>
                <div style="margin-top: 5px; font-size: 12px; color: var(--text-muted);">
                    üí° Definisci come verranno asciugati/acconciati i capelli
                </div>
            </div>

            <!-- NUOVO: EXTENSIONS & INFOLTIMENTO -->
            <div style="margin-top: 15px;">
                <label class="input-label">
                    <i class="fas fa-plus-circle"></i> Extension / Infoltimento (Opzionale)
                </label>
                <select id="extensions-type" class="input">
                    <!-- EXTENSIONS iniettati da JS -->
                </select>
                <div style="margin-top: 5px; font-size: 12px; color: var(--text-muted);">
                    üí° Le extension aumentano la massa colore necessaria
                </div>
            </div>

            <!-- SLIDER TONO BASE -->
            <div class="color-composer" style="margin-top: 25px;">
                <label class="input-label">Tono Base (Livello Schiaritura)</label>
                <div class="tone-slider-container">
                    <div class="tone-display" id="tone-display">7</div>
                    <input type="range" id="base-tone" class="tone-slider" min="1" max="10" value="7" oninput="updateToneDisplay()">
                    <div class="tone-labels">
                        <span>1<br>Nero</span>
                        <span>3<br>Bruno</span>
                        <span>5<br>Castano</span>
                        <span>7<br>Biondo</span>
                        <span>9<br>Chiaris.</span>
                        <span>10<br>Plat.</span>
                    </div>
                </div>
            </div>

            <!-- PALETTE RIFLESSI -->
            <div style="margin-top: 25px;">
                <label class="input-label">Riflessi (Tap = Seleziona | Double Tap = Intenso)</label>
                <div id="reflect-palette" class="reflect-palette">
                    <!-- renderReflectPalette() inietta qui i bottoni -->
                </div>
            </div>

            <!-- PILASTRO 2: TECNICA DI APPLICAZIONE COLORE -->
            <div style="margin-top: 20px;">
                <label class="input-label">
                    <i class="fas fa-paint-roller"></i> Tecnica di Applicazione Colore
                </label>
                <select id="color-technique" class="input">
                    <!-- COLOR_TECHNIQUES iniettati da JS -->
                </select>
            </div>

            <!-- FORMULA DISPLAY - Live Update -->
            <div class="formula-display" style="margin-top: 20px;">
                <div class="formula-label">FORMULA COLORE</div>
                <div class="formula-code" id="formula-code">7.0</div>
                <div class="formula-meta">
                    <span class="temp-badge temp-neutral" id="formula-temp">NEUTRO</span>
                    <span style="font-size: 13px; color: var(--text-secondary);" id="formula-name">Naturale</span>
                </div>
            </div>

            <!-- MAKEUP (Solo F/X) -->
            <div id="makeup-section" class="hidden" style="margin-top: 25px;">
                <div class="section-header">
                    <i class="fas fa-paint-brush" style="color: var(--warning);"></i>
                    <h4>Trucco</h4>
                </div>

                <label class="input-label">Trucco Occhi</label>
                <select id="eye-makeup" class="input">
                    <option value="Nessuno">Nessuno</option>
                    <option value="Naturale">Naturale Nude</option>
                    <option value="Soft Glam">Soft Glam</option>
                    <option value="Smokey Eyes">Smokey Eyes</option>
                    <option value="Cat Eye">Cat Eye</option>
                    <option value="Glitter">Glitter</option>
                    <option value="Cut Crease">Cut Crease</option>
                </select>

                <label class="input-label" style="margin-top: 15px;">Colore Labbra</label>
                <div class="makeup-grid" id="lip-colors">
                    <!-- renderLipColors() inietta qui -->
                </div>
            </div>

            <!-- BARBA (Solo M/X) -->
            <div id="beard-section" class="hidden" style="margin-top: 25px;">
                <div class="section-header">
                    <i class="fas fa-user-tie" style="color: var(--primary);"></i>
                    <h4>Barba</h4>
                </div>

                <label class="input-label">Stile Barba</label>
                <select id="beard-style" class="input">
                    <option value="none">Rasato</option>
                    <option value="Stubble 1-2 giorni">Stubble 1-2 giorni</option>
                    <option value="Stubble 3-5 giorni">Stubble 3-5 giorni</option>
                    <option value="Barba Corta">Barba Corta (5-15mm)</option>
                    <option value="Barba Media">Barba Media (15-25mm)</option>
                    <option value="Barba Piena">Barba Piena (25mm+)</option>
                    <option value="Pizzetto">Pizzetto</option>
                    <option value="Van Dyke">Van Dyke</option>
                </select>

                <!-- PILASTRO 3: SFUMATURE AVANZATE -->
                <div style="margin-top: 15px;">
                    <label class="input-label">
                        <i class="fas fa-layer-group"></i> Sfumatura Tecnica (Fade)
                    </label>
                    <select id="fade-type" class="input">
                        <option value="none">Nessuna (Lunghezza Uniforme)</option>
                        <!-- ADVANCED_FADES iniettati da JS -->
                    </select>
                </div>

                <label class="input-label" style="margin-top: 15px;">Colore Barba</label>
                <div class="makeup-grid" id="beard-colors">
                    <!-- renderBeardColors() inietta qui -->
                </div>
            </div>

            <button class="btn" onclick="generatePreview()" style="margin-top: 30px; width: 100%;">
                <i class="fas fa-wand-magic-sparkles"></i> Genera Anteprima AI
            </button>
        </div>
    </div>

    <!-- ========================================
         FASE 4B: FLUID CREATIVE COLORS (Genere X)
         ======================================== -->
    <div id="fluid-config-section" class="hidden">
        <!-- Foto Cliente -->
        <div class="card">
            <img id="client-photo" style="width: 100%; border-radius: 12px; display: block;">
        </div>

        <!-- Creative Colors Composer -->
        <div class="card" style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h3 style="margin: 0;">üåà Creative Color Lab</h3>
                    <p style="color: var(--text-muted); font-size: 13px; margin: 5px 0 0 0;">
                        Sistema pigmentazione diretta multi-tono
                    </p>
                </div>
            </div>

            <!-- BASE HAIR COLOR -->
            <label class="input-label">
                <i class="fas fa-palette"></i> Colore Base Capelli (per calcolo quantit√†)
            </label>
            <select id="base-hair-color-fluid" class="input">
                <option value="virgin-light">Naturali Chiari (Biondo)</option>
                <option value="virgin-medium">Naturali Medi (Castano)</option>
                <option value="virgin-dark">Naturali Scuri (Bruno/Nero)</option>
                <option value="bleached" selected>Pre-decolorati (Platino)</option>
                <option value="colored">Gi√† Colorati</option>
            </select>

            <!-- CATEGORY TABS -->
            <div class="section-header" style="margin-top: 25px;">
                <i class="fas fa-rainbow"></i>
                <h4>Seleziona Colori (Multi-Tono)</h4>
            </div>

            <div class="creative-category-tabs">
                <button class="category-tab active" data-category="all">Tutti</button>
                <button class="category-tab" data-category="pastel">Pastels</button>
                <button class="category-tab" data-category="vivid">Vivid</button>
                <button class="category-tab" data-category="metallic">Metallic</button>
                <button class="category-tab" data-category="dark">Dark Fantasy</button>
            </div>

            <!-- CREATIVE COLORS PALETTE -->
            <div id="creative-colors-palette" class="creative-palette">
                <!-- renderCreativeColorsPalette() inietta qui -->
            </div>

            <!-- SELECTED COLORS DISPLAY -->
            <div id="selected-colors-display" class="hidden" style="margin-top: 20px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: var(--text-secondary);">Colori Selezionati</h4>
                <div id="selected-colors-list">
                    <!-- updateSelectedColorsDisplay() inietta qui -->
                </div>
            </div>

            <!-- PLACEMENT TECHNIQUE -->
            <div style="margin-top: 20px;">
                <label class="input-label">
                    <i class="fas fa-layer-group"></i> Tecnica Applicazione
                </label>
                <select id="creative-placement-technique" class="input">
                    <!-- popolato da populateFluidUI() -->
                </select>
            </div>

            <!-- FLUID MAKEUP SECTION -->
            <div id="fluid-makeup-section" class="hidden" style="margin-top: 25px;">
                <!-- Clonato da makeup-section -->
            </div>

            <!-- FLUID BEARD SECTION -->
            <div id="fluid-beard-section" class="hidden" style="margin-top: 25px;">
                <!-- Clonato da beard-section -->
            </div>

            <button class="btn" onclick="generateFluidPreview()" style="margin-top: 30px; width: 100%;">
                <i class="fas fa-wand-magic-sparkles"></i> Genera Anteprima Creative
            </button>
        </div>
    </div>

    <!-- ========================================
         FASE 5: RESULTS
         ======================================== -->
    <div id="results-section" class="hidden">
        <div class="card">
            <h3 style="margin: 0 0 20px 0; text-align: center;">
                <i class="fas fa-check-circle" style="color: var(--success);"></i> Risultato
            </h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div>
                    <div class="preview-label">Prima</div>
                    <img id="before-img" class="preview-image">
                </div>
                <div>
                    <div class="preview-label">Dopo (AI)</div>
                    <img id="after-img" class="preview-image">
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">üìã Riepilogo Look</h3>
            </div>
            <div id="summary-content">
                <!-- displayResults() o displayFluidResults() inietta qui -->
            </div>
        </div>

        <div class="btn-container" style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn btn-secondary" onclick="backToConfig()">
                <i class="fas fa-edit"></i> Modifica
            </button>
            
            <button class="btn" onclick="translateFormula()">
                <i class="fas fa-language"></i> Traduci
            </button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <button class="btn btn-success" onclick="saveLook()">
                <i class="fas fa-save"></i> Salva
            </button>
            
            <button class="btn btn-outline" onclick="shareLook()">
                <i class="fas fa-share-alt"></i> Condividi
            </button>
        </div>
    </div>

  </div>

  <!-- ========================================
       MODAL: TRANSLATION
       ======================================== -->
  <div id="translation-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 500px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">üåé Traduttore Universale</h3>
        <button class="btn-icon" onclick="closeTranslationModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="translation-card">
        <div class="translation-label">La tua formula</div>
        <div class="translation-code" id="your-formula">-</div>
        <div class="translation-system" id="your-system">-</div>
      </div>

      <div style="text-align: center; margin: 20px 0;">
        <i class="fas fa-arrows-up-down" style="font-size: 28px; color: var(--primary);"></i>
      </div>

      <div class="translation-card">
        <div class="translation-label">Traduzione universale</div>
        <div class="translation-code" id="universal-formula" style="color: var(--warning);">-</div>
        <div class="translation-desc" id="universal-desc">-</div>
      </div>

      <div style="margin-top: 20px;" id="alternative-systems">
        <!-- translateFormula() inietta qui -->
      </div>
    </div>
  </div>

  <!-- ========================================
       FAB BUTTONS (Fixed Bottom)
       ======================================== -->
  <div class="fab-container" style="position: fixed; bottom: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: flex-end; pointer-events: none; z-index: 1000;">
    <!-- Back Button (Left) - Naviga sezioni interne -->
    <button class="fab-btn fab-secondary" onclick="goBack()" title="Torna Indietro" style="pointer-events: auto; width: 56px; height: 56px; border-radius: 50%; background: var(--secondary); border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center;">
      <i class="fas fa-arrow-left" style="color: white; font-size: 20px;"></i>
    </button>

    <!-- Menu Button (Right) - Torna a functions/index.html -->
    <button class="fab-btn fab-primary" onclick="goToFunctionsIndex()" title="Menu Servizi" style="pointer-events: auto; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center;">
      <i class="fas fa-th" style="color: white; font-size: 20px;"></i>
    </button>
  </div>

  <!-- ========================================
       JAVASCRIPT ENGINE
       ======================================== -->
  <!-- CRITICAL: Load URL manager FIRST -->
  <script src="../url-params-manager.js"></script>
  
  <!-- Then load pillars, main JS, and creative system -->
  <script src="./specchio-magico-pillars.js"></script>
  <script src="./specchio-magico.js"></script>
  <script src="./specchio-magico-creative.js"></script>

  <script>
    // ========================================
    // NAVIGATION: Menu FAB to functions/index.html
    // ========================================
    function goToFunctionsIndex() {
      navigateWithParams('./index.html', {
        from: 'specchio-magico',
        system: currentSystem || 'standard',
        gender: selectedGender || 'F'
      });
    }
  </script>

</body>
</html>