<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connessione Sicura - SiteBoS</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="card" style="text-align: center; margin-top: 50px;">
            <div style="font-size: 64px; margin-bottom: 20px;">
                ü§ù
            </div>
            <h1 style="margin-bottom: 15px;">Benvenuto!</h1>
            <p style="font-size: 16px; color: var(--text-muted); margin-bottom: 30px;">
                Stai per connetterti in modo sicuro con il tuo operatore.
            </p>

            <div id="status-container">
                <!-- Status messages will be injected here -->
            </div>

            <div class="note note-success" style="margin-top: 30px;">
                <i class="fas fa-shield-alt"></i>
                <strong>Privacy Garantita</strong><br>
                I tuoi dati sono protetti secondo il GDPR. Il consenso viene acquisito automaticamente durante la connessione.
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--glass-border);">
                <p style="font-size: 11px; color: var(--text-secondary);">
                    Token di invito: <span id="invite-token" style="font-family: monospace; color: var(--primary);">---</span>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Extract invite token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const inviteToken = urlParams.get('invite');

        const statusContainer = document.getElementById('status-container');
        const tokenDisplay = document.getElementById('invite-token');

        if (inviteToken) {
            tokenDisplay.textContent = inviteToken;
            
            // Show processing status
            statusContainer.innerHTML = `
                <div class="spinner-ring" style="margin: 20px auto;"></div>
                <p style="color: var(--text-muted); font-size: 14px;">
                    Connessione in corso...
                </p>
            `;

            // Simulate connection process (in production, this will call the webhook)
            setTimeout(() => {
                statusContainer.innerHTML = `
                    <div style="padding: 20px; background: rgba(76, 217, 100, 0.15); border-radius: 12px; border: 1px solid var(--success);">
                        <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success);"></i>
                        <h3 style="color: var(--success); margin: 15px 0 5px 0;">Connessione Stabilita!</h3>
                        <p style="font-size: 13px; color: var(--text-muted);">
                            L'operatore √® stato notificato. Puoi chiudere questa pagina.
                        </p>
                    </div>
                `;

                // In production: send confirmation to webhook
                // notifyOperator(inviteToken);
            }, 2000);
        } else {
            // No token provided
            statusContainer.innerHTML = `
                <div class="note note-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Errore</strong><br>
                    Link di invito non valido o mancante.
                </div>
            `;
        }

        // Future function to notify operator via webhook
        async function notifyOperator(token) {
            try {
                const response = await fetch('https://trinai.api.workflow.dcmake.it/webhook/d253f855-ce1a-43ee-81aa-38fa11a9d639', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'confirm_handshake',
                        session_id: token,
                        client: {
                            name: 'Cliente Demo', // In production, collect from form
                            email: 'cliente@example.com',
                            consent: true
                        }
                    })
                });

                if (!response.ok) throw new Error('Notifica fallita');
                console.log('Operatore notificato con successo');
            } catch (error) {
                console.error('Errore notifica operatore:', error);
            }
        }
    </script>
</body>
</html>