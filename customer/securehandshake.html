<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connessione Sicura - SiteBoS</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Session Management Utilities -->
    <script src="session_utils.js"></script>
</head>
<body>
    <div class="container">
        <div class="card" style="text-align: center; margin-top: 50px;">
            <div style="font-size: 64px; margin-bottom: 20px;">
                ü§ù
            </div>
            <h1 style="margin-bottom: 15px;">Benvenuto!</h1>
            <p style="font-size: 16px; color: var(--text-muted); margin-bottom: 30px;">
                Stai per connetterti in modo sicuro con il tuo operatore.
            </p>

            <div id="status-container">
                <!-- Status messages will be injected here -->
            </div>

            <div class="note note-success" style="margin-top: 30px;">
                <i class="fas fa-shield-alt"></i>
                <strong>Privacy Garantita</strong><br>
                I tuoi dati sono protetti secondo il GDPR. Il consenso viene acquisito automaticamente durante la connessione.
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--glass-border);">
                <p style="font-size: 11px; color: var(--text-secondary);">
                    Token di invito: <span id="invite-token" style="font-family: monospace; color: var(--primary);">---</span>
                </p>
                <p style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                    Operatore: <span id="operator-id" style="font-family: monospace; color: var(--info);">---</span>
                </p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // HANDSHAKE PAGE - Using Session Utilities
        // ============================================
        
        const statusContainer = document.getElementById('status-container');
        const tokenDisplay = document.getElementById('invite-token');
        const operatorDisplay = document.getElementById('operator-id');

        // Initialize session from URL (source of truth)
        const session = initSession();

        if (session && session.fullToken) {
            // Valid session initialized from URL
            tokenDisplay.textContent = session.fullToken;
            operatorDisplay.textContent = session.operatorId;
            
            // Show processing status
            statusContainer.innerHTML = `
                <div class="spinner-ring" style="margin: 20px auto;"></div>
                <p style="color: var(--text-muted); font-size: 14px;">
                    Connessione in corso...
                </p>
            `;

            // Notify operator via webhook
            notifyOperator(session).then(success => {
                if (success) {
                    // Success - show connected state
                    statusContainer.innerHTML = `
                        <div style="padding: 20px; background: rgba(76, 217, 100, 0.15); border-radius: 12px; border: 1px solid var(--success);">
                            <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success);"></i>
                            <h3 style="color: var(--success); margin: 15px 0 5px 0;">Connessione Stabilita!</h3>
                            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                                L'operatore √® stato notificato.
                            </p>
                            <button class="btn btn-primary" onclick="goToHub()">
                                <i class="fas fa-home"></i> Vai alla Dashboard
                            </button>
                        </div>
                    `;
                } else {
                    // Webhook failed but session is valid (offline-first)
                    statusContainer.innerHTML = `
                        <div style="padding: 20px; background: rgba(245, 158, 11, 0.15); border-radius: 12px; border: 1px solid var(--warning);">
                            <i class="fas fa-info-circle" style="font-size: 48px; color: var(--warning);"></i>
                            <h3 style="color: var(--warning); margin: 15px 0 5px 0;">Modalit√† Offline</h3>
                            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                                Connessione salvata localmente. Sincronizzazione avverr√† quando torner√† la rete.
                            </p>
                            <button class="btn btn-secondary" onclick="goToHub()">
                                <i class="fas fa-home"></i> Continua Offline
                            </button>
                        </div>
                    `;
                }
            });
            
        } else {
            // No valid session from URL - check if already exists in storage
            const existingSession = getSession();
            
            if (existingSession && isSessionValid()) {
                // Session exists and is valid
                statusContainer.innerHTML = `
                    <div class="note note-success">
                        <i class="fas fa-info-circle"></i>
                        <strong>Sessione Esistente</strong><br>
                        Sei gi√† connesso. 
                        <button class="btn btn-sm btn-primary" onclick="goToHub()" style="margin-top: 10px;">
                            <i class="fas fa-home"></i> Vai alla Dashboard
                        </button>
                    </div>
                `;
                tokenDisplay.textContent = existingSession.fullToken.substring(0, 20) + '...';
                operatorDisplay.textContent = existingSession.operatorId || '---';
            } else {
                // No valid session anywhere
                statusContainer.innerHTML = `
                    <div class="note note-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Errore</strong><br>
                        Link di invito non valido o mancante. Richiedi un nuovo link al tuo operatore.
                    </div>
                `;
            }
        }

        // ============================================
        // WEBHOOK NOTIFICATION
        // ============================================
        
        async function notifyOperator(sessionData) {
            try {
                const response = await fetch('https://trinai.api.workflow.dcmake.it/webhook/d253f855-ce1a-43ee-81aa-38fa11a9d639', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'confirm_handshake',
                        session_id: sessionData.fullToken,
                        operator_id: sessionData.operatorId,
                        vat_id: sessionData.vatId,
                        client: {
                            name: 'Cliente Web', // TODO: Collect from form
                            email: 'temp@example.com',
                            consent: true,
                            connected_at: new Date().toISOString()
                        }
                    })
                });

                if (!response.ok) throw new Error('Webhook failed');
                console.log('‚úÖ Operatore notificato con successo');
                return true;
            } catch (error) {
                console.warn('‚ö†Ô∏è Webhook notification failed (non-critical):', error);
                return false; // Don't block user flow
            }
        }

        // ============================================
        // NAVIGATION (Using session utilities)
        // ============================================
        
        function goToHub() {
            // Navigate with session context preserved
            navigateWithContext('../customer_hub.html');
        }

        // Debug session state (development only)
        debugSession();
    </script>
</body>
</html>