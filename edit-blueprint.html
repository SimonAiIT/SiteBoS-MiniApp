<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blueprint Editor</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --input: #334155; --text: #e2e8f0; --accent: #10b981; }
        body { background: var(--bg); color: var(--text); font-family: monospace; padding: 15px; padding-bottom: 80px; }
        
        h1 { font-size: 1.2rem; margin-bottom: 5px; color: var(--accent); }
        .meta { font-size: 0.8rem; opacity: 0.7; margin-bottom: 20px; }

        /* STAGE CARD */
        .stage { border-left: 4px solid var(--accent); padding-left: 15px; margin-bottom: 30px; }
        .stage-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; color: #fff; }

        /* STEP CARD */
        .step { background: var(--card); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #334155; }
        .step-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; font-weight: bold; }
        
        label { display: block; font-size: 0.75rem; opacity: 0.6; margin-top: 10px; margin-bottom: 4px; text-transform: uppercase; }
        textarea, input { width: 100%; background: var(--input); color: white; border: none; padding: 8px; border-radius: 4px; font-family: inherit; font-size: 0.9rem; }
        textarea { resize: vertical; }

        .fab { position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--accent); color: black; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div id="app">
        <h1 id="bpName">Caricamento...</h1>
        <div class="meta" id="bpMeta"></div>
        <div id="stagesContainer"></div>
    </div>

    <div class="fab" id="btnSave">üíæ SAVE BLUEPRINT</div>

    <script>
        const API_URL = "https://trinai.api.workflow.dcmake.it/webhook/e742c7c8-107e-4328-882e-c13459413424";
        const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
        const p = new URLSearchParams(location.search);
        
        let blueprintData = null;

        async function load() {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "GET", type: "BLUEPRINT", id: p.get('id'), owner_id: p.get('owner') })
                });
                blueprintData = await res.json();
                render();
            } catch(e) { document.getElementById('bpName').innerText = "Errore Caricamento"; }
        }

        function render() {
            document.getElementById('bpName').innerText = blueprintData.identity.blueprint_name;
            document.getElementById('bpMeta').innerText = `${blueprintData.identity.blueprint_type} ‚Ä¢ Costo Tot: ${blueprintData.summary.estimated_total_cost}‚Ç¨`;
            
            const container = document.getElementById('stagesContainer');
            container.innerHTML = '';

            blueprintData.stages.forEach((stage, stageIdx) => {
                const stageDiv = document.createElement('div');
                stageDiv.className = 'stage';
                stageDiv.innerHTML = `<div class="stage-title">FASE ${stage.stage_order}: ${stage.stage_name}</div>`;

                stage.steps.forEach((step, stepIdx) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step';
                    stepDiv.innerHTML = `
                        <div class="step-header">
                            <span>STEP ${step.step_order}</span>
                            <span>‚è±Ô∏è <input type="number" value="${step.estimated_time_minutes}" style="width: 50px; display:inline;" onchange="updateTime(${stageIdx}, ${stepIdx}, this.value)"> min</span>
                        </div>
                        <label>Nome Step</label>
                        <input type="text" value="${step.step_name}" onchange="updateName(${stageIdx}, ${stepIdx}, this.value)">
                        
                        <label>Istruzioni Operative</label>
                        <textarea rows="3" onchange="updateInstr(${stageIdx}, ${stepIdx}, this.value)">${step.instructions}</textarea>
                        
                        <label>Skill Richieste</label>
                        <input type="text" value="${step.resources_needed?.labor?.required_skill_tags?.join(', ') || ''}" onchange="updateSkills(${stageIdx}, ${stepIdx}, this.value)">
                    `;
                    stageDiv.appendChild(stepDiv);
                });
                container.appendChild(stageDiv);
            });
        }

        // UPDARE LOGIC (In-Memory)
        window.updateTime = (sI, stI, val) => blueprintData.stages[sI].steps[stI].estimated_time_minutes = parseInt(val);
        window.updateName = (sI, stI, val) => blueprintData.stages[sI].steps[stI].step_name = val;
        window.updateInstr = (sI, stI, val) => blueprintData.stages[sI].steps[stI].instructions = val;
        window.updateSkills = (sI, stI, val) => {
            if(!blueprintData.stages[sI].steps[stI].resources_needed) blueprintData.stages[sI].steps[stI].resources_needed = { labor: {} };
            blueprintData.stages[sI].steps[stI].resources_needed.labor.required_skill_tags = val.split(',').map(s=>s.trim());
        };

        // SAVE
        document.getElementById('btnSave').onclick = async () => {
            const btn = document.getElementById('btnSave');
            btn.innerText = "‚è≥ SALVATAGGIO...";
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: "SAVE", type: "BLUEPRINT", 
                        id: p.get('id'), owner_id: p.get('owner'), 
                        payload: blueprintData 
                    })
                });
                btn.innerText = "‚úÖ AGGIORNATO";
                setTimeout(() => tg.close(), 1000);
            } catch(e) { btn.innerText = "‚ùå ERRORE"; }
        };

        load();
    </script>
</body>
</html>
