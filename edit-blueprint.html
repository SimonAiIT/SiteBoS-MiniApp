<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Blueprint Editor</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  
  <style>
    :root {
      --bg-start: #4a5b8f; --bg-end: #2a3d5f; --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7); --border-color: rgba(255, 255, 255, 0.2);
      --input-bg: rgba(255, 255, 255, 0.08); --accent-color: #5B6FED; --error-color: #ff6b6b;
      --success-color: #4ade80; --stage-bg: rgba(91, 111, 237, 0.15);
      --hover-bg: rgba(255, 255, 255, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text-primary); padding: 20px; min-height: 100vh; padding-bottom: 120px;
    }
    .container { max-width: 700px; margin: 0 auto; }
    h1 { font-size: 24px; margin-bottom: 6px; font-weight: 600; }
    .subtitle { font-size: 13px; color: var(--text-secondary); margin-bottom: 24px; font-weight: 300; }
    .section-title { 
      font-size: 16px; font-weight: 600; margin: 28px 0 16px; 
      padding-bottom: 8px; border-bottom: 1px solid var(--border-color);
    }
    .form-group { margin-bottom: 18px; }
    label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; }
    label.disabled { opacity: 0.5; }
    input[type="text"], input[type="number"], textarea {
      width: 100%; padding: 12px 14px; border: 1px solid var(--border-color);
      border-radius: 12px; background: var(--input-bg); backdrop-filter: blur(10px);
      color: var(--text-primary); font-size: 15px; font-family: inherit;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:disabled { opacity: 0.5; cursor: not-allowed; }
    input:focus, textarea:focus { 
      outline: none; border-color: rgba(255, 255, 255, 0.5); 
      box-shadow: 0 0 15px rgba(91, 111, 237, 0.3); 
    }
    
    /* DRAG & DROP */
    .drag-handle {
      cursor: grab; color: var(--text-secondary); padding: 8px; 
      font-size: 20px; line-height: 1; display: flex; align-items: center;
      opacity: 0.6; transition: opacity 0.2s;
    }
    .drag-handle:hover { opacity: 1; color: var(--text-primary); }
    .sortable-ghost { opacity: 0.4; background: var(--accent-color); }

    /* STAGES & STEPS */
    .stage-card {
      background: var(--stage-bg); border: 1px solid var(--border-color);
      border-radius: 16px; padding: 16px; margin-bottom: 24px;
      backdrop-filter: blur(10px); display: flex; flex-direction: column;
    }
    .stage-header {
      display: flex; align-items: flex-start; gap: 10px;
      margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);
    }
    .stage-content { flex: 1; }
    .stage-title-input {
      font-size: 18px; font-weight: 600; background: transparent;
      border: none; color: var(--text-primary); width: 100%;
      padding: 4px 0; margin-bottom: 4px;
    }
    .stage-title-input:focus { outline: none; border-bottom: 1px solid var(--accent-color); }
    
    .step-list-container { min-height: 10px; }

    .step-item {
      background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px; padding: 12px; margin-bottom: 12px; position: relative;
    }
    .step-header {
      display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px;
    }
    .step-id { 
      background: rgba(255, 255, 255, 0.15); padding: 3px 8px; 
      border-radius: 6px; font-size: 10px; font-weight: 700; 
      font-family: monospace; margin-bottom: 6px; display: inline-block;
      color: var(--accent-color);
    }
    .step-name-input {
      font-size: 15px; font-weight: 600; margin-bottom: 6px;
      background: transparent; border: none; color: var(--text-primary);
      width: 100%; padding: 4px 0;
    }
    .step-name-input:focus { outline: none; border-bottom: 1px solid var(--accent-color); }
    .step-meta {
      display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px;
      color: var(--text-secondary); margin-top: 10px;
    }
    
    /* BUTTONS */
    .btn-icon {
      background: transparent; border: none; cursor: pointer;
      font-size: 16px; padding: 8px; border-radius: 8px;
      transition: background 0.2s; color: var(--text-secondary);
      display: flex; align-items: center; justify-content: center;
    }
    .btn-icon:hover { background: var(--hover-bg); color: var(--text-primary); }
    .btn-delete { color: var(--error-color); }
    .btn-delete:hover { background: rgba(255, 107, 107, 0.15); }
    
    .btn-add-step {
      width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.05);
      border: 1px dashed var(--border-color); border-radius: 10px;
      color: var(--text-secondary); font-size: 13px; cursor: pointer;
      transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn-add-stage {
      width: 100%; padding: 16px; background: rgba(91, 111, 237, 0.1);
      border: 2px dashed var(--accent-color); border-radius: 16px;
      color: var(--accent-color); font-size: 15px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;
    }

    /* COLLAPSIBLE & FLAGS */
    .collapsible-content { 
      max-height: 0; overflow: hidden; 
      transition: max-height 0.3s ease, padding 0.3s ease; 
    }
    .collapsible-content.open { max-height: 2000px; padding-top: 12px; }

    /* NEW: FLAG CONTAINER */
    .flag-container {
      display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;
      padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .flag-item {
      display: flex; align-items: center; gap: 8px; font-size: 12px;
      background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 8px;
      border: 1px solid var(--border-color); cursor: pointer;
    }
    .flag-item input[type="checkbox"] { width: 16px; height: 16px; margin: 0; cursor: pointer; }
    
    .button-container { 
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 12px; width: calc(100% - 40px); max-width: 700px;
      background: rgba(42, 61, 95, 0.95); backdrop-filter: blur(15px);
      padding: 12px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid var(--border-color); z-index: 100;
    }
    button.primary {
      flex: 1; padding: 14px; border: none; border-radius: 12px;
      font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s;
      background: var(--accent-color); color: var(--text-primary);
    }
    button.primary:disabled { background: #555; opacity: 0.6; }
    button.primary.success { background: var(--success-color); color: #000; }
    
    .spinner { 
      border: 3px solid rgba(255,255,255,0.2); border-top: 3px solid #fff; 
      border-radius: 50%; width: 18px; height: 18px; animation: spin 0.8s linear infinite; display: inline-block;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
    <div class="loading-text" id="txtLoading" style="margin-top:20px;">Loading...</div>
  </div>

  <div class="container" id="mainContent" style="display: none;">
    <h1 id="pageTitle">Blueprint</h1>
    <p class="subtitle" id="pageSubtitle">Define Process</p>
    
    <form id="blueprintForm">
      <div class="section-title" id="lblInfo">Info</div>
      <div class="form-group">
        <label class="disabled">SKU</label>
        <input type="text" id="serviceSku" disabled>
      </div>
      <div class="form-group">
        <label id="lblDesc">Description</label>
        <textarea id="blueprintDesc" rows="2"></textarea>
      </div>

      <div class="section-title" id="lblStages">Stages</div>
      <div id="stagesContainer"></div>

      <button type="button" class="btn-add-stage" onclick="addStage()">
        <span id="btnAddStage">Add Stage</span>
      </button>

      <div class="button-container">
        <button type="submit" class="primary" id="saveBtn">Save</button>
      </div>
    </form>
  </div>

  <script>
    const WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/e742c7c8-107e-4328-882e-c13459413424";
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TRANSLATIONS (6 Langs + New Flags)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const translations = {
      it: {
        title: "üìã Blueprint Operativo", subtitle: "Trascina per riordinare fasi e step.",
        lblInfo: "‚ÑπÔ∏è Info Generali", lblDesc: "Descrizione", lblStages: "üéØ Fasi Operative",
        btnAddStage: "‚ûï Aggiungi Fase", btnSave: "üíæ Salva", loading: "Caricamento...", saving: "Salvataggio...", saved: "‚úÖ Salvato!", error: "‚ùå Errore",
        phDesc: "Scopo del processo...", phStageDesc: "Descrizione fase...", phStepInstr: "Istruzioni...",
        lblQC: "Controllo Qualit√†", phQC: "Cosa verificare?",
        lblSkills: "Skill (CSV)", phSkills: "Es: Dev, Legal...",
        newStage: "Nuova Fase", newStep: "Nuovo Step",
        confirmDelStage: "Eliminare fase?", confirmDelStep: "Eliminare step?",
        btnAddStep: "‚ûï Aggiungi Step", min: "min",
        // FLAG TRANSLATIONS
        lblLogistics: "Logistica & Risorse",
        flagWIP: "Richiede Semilavorato",
        flagFinished: "Richiede Prodotto Finito"
      },
      en: {
        title: "üìã Operational Blueprint", subtitle: "Drag to reorder stages and steps.",
        lblInfo: "‚ÑπÔ∏è General Info", lblDesc: "Description", lblStages: "üéØ Operational Stages",
        btnAddStage: "‚ûï Add Stage", btnSave: "üíæ Save", loading: "Loading...", saving: "Saving...", saved: "‚úÖ Saved!", error: "‚ùå Error",
        phDesc: "Process purpose...", phStageDesc: "Stage description...", phStepInstr: "Instructions...",
        lblQC: "Quality Check", phQC: "Verify what?",
        lblSkills: "Skills (CSV)", phSkills: "E.g.: Dev, Legal...",
        newStage: "New Stage", newStep: "New Step",
        confirmDelStage: "Delete stage?", confirmDelStep: "Delete step?",
        btnAddStep: "‚ûï Add Step", min: "min",
        lblLogistics: "Logistics & Resources",
        flagWIP: "Requires Semi-finished (WIP)",
        flagFinished: "Requires Finished Product"
      },
      fr: {
        title: "üìã Blueprint", subtitle: "Glisser pour r√©organiser.",
        lblInfo: "‚ÑπÔ∏è Info", lblDesc: "Description", lblStages: "üéØ Phases",
        btnAddStage: "‚ûï Ajouter Phase", btnSave: "üíæ Enregistrer", loading: "Chargement...", saving: "Enregistrement...", saved: "‚úÖ Enregistr√© !", error: "‚ùå Erreur",
        phDesc: "But du processus...", phStageDesc: "Desc. phase...", phStepInstr: "Instructions...",
        lblQC: "Contr√¥le Qualit√©", phQC: "Quoi v√©rifier ?",
        lblSkills: "Comp√©tences", phSkills: "Ex: Dev...",
        newStage: "Nouvelle Phase", newStep: "Nouvelle √âtape",
        confirmDelStage: "Supprimer phase ?", confirmDelStep: "Supprimer √©tape ?",
        btnAddStep: "‚ûï Ajouter √âtape", min: "min",
        lblLogistics: "Logistique & Ressources",
        flagWIP: "N√©cessite Produit Semi-fini",
        flagFinished: "N√©cessite Produit Fini"
      },
      de: {
        title: "üìã Blueprint", subtitle: "Ziehen zum Neuordnen.",
        lblInfo: "‚ÑπÔ∏è Info", lblDesc: "Beschreibung", lblStages: "üéØ Phasen",
        btnAddStage: "‚ûï Phase hinzuf√ºgen", btnSave: "üíæ Speichern", loading: "Laden...", saving: "Speichern...", saved: "‚úÖ Gespeichert!", error: "‚ùå Fehler",
        phDesc: "Zweck...", phStageDesc: "Beschreibung...", phStepInstr: "Anweisungen...",
        lblQC: "Qualit√§t", phQC: "Pr√ºfen?",
        lblSkills: "Skills", phSkills: "z.B. Dev...",
        newStage: "Neue Phase", newStep: "Neuer Schritt",
        confirmDelStage: "Phase l√∂schen?", confirmDelStep: "Schritt l√∂schen?",
        btnAddStep: "‚ûï Schritt hinzuf√ºgen", min: "Min",
        lblLogistics: "Logistik & Ressourcen",
        flagWIP: "Ben√∂tigt Halbzeug",
        flagFinished: "Ben√∂tigt Fertigprodukt"
      },
      es: {
        title: "üìã Blueprint", subtitle: "Arrastrar para reordenar.",
        lblInfo: "‚ÑπÔ∏è Info", lblDesc: "Descripci√≥n", lblStages: "üéØ Fases",
        btnAddStage: "‚ûï A√±adir Fase", btnSave: "üíæ Guardar", loading: "Cargando...", saving: "Guardando...", saved: "‚úÖ Guardado", error: "‚ùå Error",
        phDesc: "Prop√≥sito...", phStageDesc: "Desc. fase...", phStepInstr: "Instrucciones...",
        lblQC: "Calidad", phQC: "¬øVerificar qu√©?",
        lblSkills: "Habilidades", phSkills: "Ej: Dev...",
        newStage: "Nueva Fase", newStep: "Nuevo Paso",
        confirmDelStage: "¬øBorrar fase?", confirmDelStep: "¬øBorrar paso?",
        btnAddStep: "‚ûï A√±adir Paso", min: "min",
        lblLogistics: "Log√≠stica & Recursos",
        flagWIP: "Requiere Semielaborado",
        flagFinished: "Requiere Producto Terminado"
      },
      pt: {
        title: "üìã Blueprint", subtitle: "Arraste para reordenar.",
        lblInfo: "‚ÑπÔ∏è Info", lblDesc: "Descri√ß√£o", lblStages: "üéØ Fases",
        btnAddStage: "‚ûï Adicionar Fase", btnSave: "üíæ Salvar", loading: "Carregando...", saving: "Salvando...", saved: "‚úÖ Salvo!", error: "‚ùå Erro",
        phDesc: "Prop√≥sito...", phStageDesc: "Desc. fase...", phStepInstr: "Instru√ß√µes...",
        lblQC: "Qualidade", phQC: "Verificar o qu√™?",
        lblSkills: "Habilidades", phSkills: "Ex: Dev...",
        newStage: "Nova Fase", newStep: "Novo Passo",
        confirmDelStage: "Excluir fase?", confirmDelStep: "Excluir passo?",
        btnAddStep: "‚ûï Adicionar Passo", min: "min",
        lblLogistics: "Log√≠stica & Recursos",
        flagWIP: "Requer Semiacabado",
        flagFinished: "Requer Produto Acabado"
      }
    };

    const p = new URLSearchParams(location.search);
    const t = translations[p.get('lang') || p.get('language') || 'it'] || translations.it;
    const blueprintId = p.get('id');
    const ownerId = p.get('owner');
    
    let currentData = null;

    // Apply Static Translations
    document.getElementById('pageTitle').textContent = t.title;
    document.getElementById('pageSubtitle').textContent = t.subtitle;
    document.getElementById('lblInfo').textContent = t.lblInfo;
    document.getElementById('lblDesc').textContent = t.lblDesc;
    document.getElementById('blueprintDesc').placeholder = t.phDesc;
    document.getElementById('lblStages').textContent = t.lblStages;
    document.getElementById('btnAddStage').textContent = t.btnAddStage;
    document.getElementById('saveBtn').textContent = t.btnSave;
    document.getElementById('txtLoading').textContent = t.loading;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LOGIC & RENDER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateIndexes() {
      if (!currentData || !currentData.stages) return;
      let totalMinutes = 0;
      currentData.stages.forEach((stage, sIdx) => {
        stage.stage_order = sIdx + 1;
        stage.stage_id = `STAGE_${String(sIdx + 1).padStart(2, '0')}`;
        if (!stage.steps) stage.steps = [];
        stage.steps.forEach((step, stIdx) => {
          step.step_order = stIdx + 1;
          step.step_id = `STEP_${String(sIdx + 1).padStart(2, '0')}_${String(stIdx + 1).padStart(2, '0')}`;
          totalMinutes += parseInt(step.estimated_time_minutes || 0);
        });
      });
      if (!currentData.summary) currentData.summary = {};
      currentData.summary.estimated_total_time_minutes = totalMinutes;
    }

    function renderStages() {
      const container = document.getElementById('stagesContainer');
      container.innerHTML = '';

      currentData.stages.forEach((stage, sIdx) => {
        const stageCard = document.createElement('div');
        stageCard.className = 'stage-card';
        stageCard.dataset.idx = sIdx;

        stageCard.innerHTML = `
          <div class="stage-header">
            <div class="drag-handle">‚ãÆ‚ãÆ</div>
            <div class="stage-content">
              <div style="font-size: 10px; color: var(--accent-color); font-weight:bold;">${stage.stage_id}</div>
              <input type="text" class="stage-title-input" value="${stage.stage_name}" 
                     onchange="updateData('stages[${sIdx}].stage_name', this.value)">
              <textarea style="width: 100%; margin-top: 4px; min-height: 40px; font-size: 13px; color: var(--text-secondary); background: transparent; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px;"
                        onchange="updateData('stages[${sIdx}].description', this.value)" placeholder="${t.phStageDesc}">${stage.description || ''}</textarea>
            </div>
            <button type="button" class="btn-icon btn-delete" onclick="removeStage(${sIdx})">üóëÔ∏è</button>
          </div>
          <div class="step-list-container" id="stepList-${sIdx}"></div>
          <button type="button" class="btn-add-step" onclick="addStep(${sIdx})"><span>${t.btnAddStep}</span></button>
        `;

        const stepListContainer = stageCard.querySelector(`#stepList-${sIdx}`);
        
        if (stage.steps && stage.steps.length > 0) {
          stage.steps.forEach((step, stIdx) => {
            const stepItem = document.createElement('div');
            stepItem.className = 'step-item';
            stepItem.dataset.idx = stIdx;

            // Ensure flags object exists
            const flags = step.logistics_flags || { requires_wip: false, requires_finished: false };

            stepItem.innerHTML = `
              <div class="step-header">
                <div class="drag-handle" style="font-size:16px; padding:4px;">‚ãÆ‚ãÆ</div>
                <div style="flex: 1; padding-right: 5px;">
                  <div class="step-id">${step.step_id}</div>
                  <input type="text" class="step-name-input" value="${step.step_name}"
                         onchange="updateData('stages[${sIdx}].steps[${stIdx}].step_name', this.value)">
                  <textarea style="width: 100%; background: transparent; border: none; color: var(--text-secondary); padding: 4px 0; min-height: 50px; font-size: 13px; line-height: 1.4;"
                            onchange="updateData('stages[${sIdx}].steps[${stIdx}].instructions', this.value)" placeholder="${t.phStepInstr}">${step.instructions || ''}</textarea>
                  <div class="step-meta">
                    <span class="meta-item">
                      ‚è±Ô∏è <input type="number" min="0" style="width: 40px; background: transparent; border: none; color: white; padding: 0; text-align: center;"
                               value="${step.estimated_time_minutes || 0}"
                               onchange="updateData('stages[${sIdx}].steps[${stIdx}].estimated_time_minutes', this.value)"> ${t.min}
                    </span>
                  </div>
                </div>
                <div style="display:flex; flex-direction:column; gap:4px;">
                  <button type="button" class="btn-icon btn-delete" onclick="removeStep(${sIdx}, ${stIdx})">üóëÔ∏è</button>
                  <button type="button" class="btn-icon" onclick="toggleStep(${sIdx}, ${stIdx})">${step.quality_check ? 'üìã' : '‚öôÔ∏è'}</button>
                </div>
              </div>
              
              <div class="collapsible-content" id="step-${sIdx}-${stIdx}">
                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; margin-top:8px;">
                  
                  <!-- NEW: LOGISTICS FLAGS -->
                  <div class="flag-container">
                    <label class="flag-item">
                      <input type="checkbox" ${flags.requires_wip ? 'checked' : ''} 
                             onchange="updateFlag(${sIdx}, ${stIdx}, 'requires_wip', this.checked)">
                      üè≠ ${t.flagWIP}
                    </label>
                    <label class="flag-item">
                      <input type="checkbox" ${flags.requires_finished ? 'checked' : ''} 
                             onchange="updateFlag(${sIdx}, ${stIdx}, 'requires_finished', this.checked)">
                      üì¶ ${t.flagFinished}
                    </label>
                  </div>

                  <div style="margin-bottom: 12px;">
                    <div style="font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">${t.lblQC}</div>
                    <textarea style="width: 100%; min-height: 50px; font-size: 12px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; color: var(--text-primary);"
                              onchange="updateNestedData(${sIdx}, ${stIdx}, 'quality_check.check_description', this.value)"
                              placeholder="${t.phQC}">${step.quality_check?.check_description || ''}</textarea>
                  </div>
                  <div>
                    <div style="font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase;">${t.lblSkills}</div>
                    <input type="text" style="font-size: 12px; padding: 8px;" 
                           value="${(step.resources_needed?.labor?.required_skill_tags || []).join(', ')}"
                           onchange="updateSkills(${sIdx}, ${stIdx}, this.value)"
                           placeholder="${t.phSkills}">
                  </div>
                </div>
              </div>
            `;
            stepListContainer.appendChild(stepItem);
          });
        }
        
        new Sortable(stepListContainer, {
          group: 'steps', handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost',
          onEnd: function (evt) {
            const fromStageIdx = parseInt(evt.from.closest('.stage-card').dataset.idx);
            const toStageIdx = parseInt(evt.to.closest('.stage-card').dataset.idx);
            const movedItem = currentData.stages[fromStageIdx].steps.splice(evt.oldIndex, 1)[0];
            currentData.stages[toStageIdx].steps.splice(evt.newIndex, 0, movedItem);
            updateIndexes(); renderStages();
          }
        });
        container.appendChild(stageCard);
      });

      new Sortable(container, {
        handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost',
        onEnd: function (evt) {
          const movedItem = currentData.stages.splice(evt.oldIndex, 1)[0];
          currentData.stages.splice(evt.newIndex, 0, movedItem);
          updateIndexes(); renderStages();
        }
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HELPERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.updateData = function(path, value) {
        let obj = currentData;
        const keys = path.replace(/\]/g, '').split(/[\[\.]/); 
        keys.forEach((key, index) => {
            if (index === keys.length - 1) {
                if (key === 'estimated_time_minutes') value = parseInt(value) || 0;
                obj[key] = value;
            } else { obj = obj[key]; }
        });
        if(path.includes('estimated_time_minutes')) updateIndexes();
    };

    window.updateNestedData = function(sIdx, stIdx, keyPath, value) {
        let target = currentData.stages[sIdx].steps[stIdx];
        const keys = keyPath.split('.');
        if (keys[0] === 'quality_check' && !target.quality_check) target.quality_check = {};
        keys.forEach((key, index) => {
            if (index === keys.length - 1) target[key] = value; else target = target[key];
        });
    };

    // NEW: FLAG UPDATER
    window.updateFlag = function(sIdx, stIdx, flagName, isChecked) {
        let target = currentData.stages[sIdx].steps[stIdx];
        if (!target.logistics_flags) target.logistics_flags = {};
        target.logistics_flags[flagName] = isChecked;
    };

    window.updateSkills = function(sIdx, stIdx, value) {
        const tags = value.split(',').map(t => t.trim()).filter(t => t);
        if (!currentData.stages[sIdx].steps[stIdx].resources_needed) currentData.stages[sIdx].steps[stIdx].resources_needed = { labor: {} };
        if (!currentData.stages[sIdx].steps[stIdx].resources_needed.labor) currentData.stages[sIdx].steps[stIdx].resources_needed.labor = {};
        currentData.stages[sIdx].steps[stIdx].resources_needed.labor.required_skill_tags = tags;
    };

    window.addStage = function() {
      currentData.stages.push({ stage_id: "", stage_order: 0, stage_name: t.newStage, description: "", steps: [] });
      updateIndexes(); renderStages();
      setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
    };

    window.removeStage = function(index) {
      if(confirm(t.confirmDelStage)) { currentData.stages.splice(index, 1); updateIndexes(); renderStages(); }
    };

    window.addStep = function(stageIndex) {
      currentData.stages[stageIndex].steps.push({ 
        step_id: "", step_order: 0, step_name: t.newStep, instructions: "", estimated_time_minutes: 15, 
        resources_needed: { labor: { required_skill_tags: [] }, materials: [], assets: [] }, 
        quality_check: null,
        logistics_flags: { requires_wip: false, requires_finished: false } // Init flags
      });
      updateIndexes(); renderStages();
    };

    window.removeStep = function(sIdx, stIdx) {
      if(confirm(t.confirmDelStep)) { currentData.stages[sIdx].steps.splice(stIdx, 1); updateIndexes(); renderStages(); }
    };

    window.toggleStep = function(sIdx, stIdx) {
      document.getElementById(`step-${sIdx}-${stIdx}`).classList.toggle('open');
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NETWORK
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadBlueprint() {
      try {
        const res = await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'GET', type: 'BLUEPRINT', id: blueprintId, owner_id: ownerId }) });
        let data;
        const text = await res.text();
        try { data = JSON.parse(text); } catch (e) { data = JSON.parse(text.replace(/^"|"$/g, '').replace(/\\"/g, '"')); }
        currentData = data;
        document.getElementById('serviceSku').value = data.service_sku || '';
        document.getElementById('blueprintDesc').value = data.blueprint_description || '';
        updateIndexes(); renderStages();
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('mainContent').style.display = 'block';
      } catch (error) { document.getElementById('txtLoading').textContent = t.error; }
    }

    document.getElementById('blueprintForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('saveBtn');
      btn.innerHTML = `<div class="spinner"></div> ${t.saving}`;
      btn.disabled = true;
      currentData.blueprint_description = document.getElementById('blueprintDesc').value.trim();
      updateIndexes();
      try {
        await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'SAVE', type: 'BLUEPRINT', id: blueprintId, owner_id: ownerId, payload: currentData }) });
        btn.textContent = t.saved;
        btn.classList.add('success');
        setTimeout(() => tg.close(), 1000);
      } catch (error) { btn.textContent = t.error; btn.disabled = false; }
    });

    loadBlueprint();
  </script>
</body>
</html>
