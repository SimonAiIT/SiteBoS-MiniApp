<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Gestione Dati Azienda</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- LOADER -->
  <div id="loader">
    <div class="spinner"></div>
    <div style="margin-top:10px; opacity:0.7">Loading Secure Data...</div>
  </div>

  <!-- ACCESS DENIED -->
  <div id="access-denied" class="hidden container text-center" style="padding-top:50px;">
    <div style="font-size:50px; margin-bottom:20px;">ðŸš«</div>
    <h2 data-i18n="error_token_title">Link Scaduto o Invalido</h2>
    <p class="subtitle" data-i18n="error_token_desc">Per motivi di sicurezza, richiedi un nuovo link dal bot.</p>
    <button onclick="tg.close()" class="btn btn-primary">Chiudi</button>
  </div>

  <!-- MAIN APP -->
  <div id="app-content" class="container hidden">
    <h2 data-i18n="title">Gestione Dati Azienda</h2>
    <p class="subtitle" data-i18n="subtitle">Modifica le informazioni per aggiornare il sistema.</p>

    <form id="editForm" onsubmit="return false;">
      
      <!-- SEZIONE 1: ANAGRAFICA -->
      <div class="form-section">
        <div class="form-section-title" data-i18n="section_core">Dati Anagrafici</div>
        <div class="row">
          <div class="col"><div class="input-group"><label data-i18n="lbl_name">Nome</label><input type="text" id="name"></div></div>
          <div class="col"><div class="input-group"><label data-i18n="lbl_surname">Cognome</label><input type="text" id="surname"></div></div>
        </div>
        <div class="input-group"><label data-i18n="lbl_email">Email</label><input type="email" id="email" required></div>
        <div class="input-group"><label data-i18n="lbl_phone">Telefono</label><input type="tel" id="phone"></div>
      </div>

      <!-- SEZIONE 2: AZIENDA -->
      <div class="form-section">
        <div class="form-section-title" data-i18n="section_company">Dati Aziendali</div>
        <div class="input-group"><label data-i18n="lbl_company_name">Ragione Sociale</label><input type="text" id="ragione_sociale" required></div>
        <!-- P.IVA in sola lettura, caricata dal token -->
        <div class="input-group"><label data-i18n="lbl_vat">P.IVA (Non modificabile)</label><input type="text" id="vat_number" readonly style="opacity:0.7"></div>
        <div class="input-group"><label data-i18n="lbl_address">Indirizzo</label><input type="text" id="indirizzo"></div>
        <div class="input-group"><label data-i18n="lbl_site">Sito Web</label><input type="url" id="site"></div>
        <div class="input-group"><label>LinkedIn</label><input type="url" id="linkedin_page"></div>
        <div class="input-group"><label>Facebook</label><input type="url" id="facebook_page"></div>
      </div>

      <!-- SEZIONE 3: CONFIGURAZIONE -->
      <div class="form-section">
        <div class="form-section-title" data-i18n="section_config">Configurazione Operativa</div>
        
        <div class="input-group">
            <label data-i18n="lbl_owner_avail">Orari NON reperibilitÃ  (Owner)</label>
            <div class="row" style="gap:5px; align-items:center;">
                <select id="owner_unav_from" class="col"></select> 
                <span>-</span> 
                <select id="owner_unav_to" class="col"></select>
            </div>
        </div>
        
        <div class="input-group">
            <label data-i18n="lbl_op_avail">Orari NON reperibilitÃ  (Operatori)</label>
            <div class="row" style="gap:5px; align-items:center;">
                <select id="operator_unav_from" class="col"></select> 
                <span>-</span> 
                <select id="operator_unav_to" class="col"></select>
            </div>
        </div>
        
        <div class="input-group">
            <label>Gemini API Key</label>
            <input type="text" id="gemini_key">
        </div>
      </div>
      
      <!-- SEZIONE 4: OPERATORI -->
      <div class="operators-card">
          <div class="card-header" style="cursor:default;">
            <h3><i class="fas fa-users"></i> <span data-i18n="op_title">Gestione Operatori</span></h3>
            <span class="step-id" id="slot-counter" style="font-size:12px;">0 / 3</span>
          </div>
          
          <div id="operators-list" style="margin-top:15px;"></div>
          
          <button type="button" class="btn btn-secondary btn-block" id="add-operator-btn" onclick="openModal()">
            <i class="fas fa-plus-circle"></i> <span data-i18n="op_btn_invite">Invita Nuovo Operatore</span>
          </button>
          
          <div class="hint hidden text-center" id="upgrade-prompt" style="color:var(--warning); margin-top:10px;">
            <p data-i18n="op_limit_reached">Limite raggiunto.</p>
          </div>
      </div>

      <div class="button-container">
          <button type="button" id="saveBtn" class="btn btn-primary btn-block" onclick="saveData()" disabled>
            <i class="fas fa-save"></i> <span data-i18n="btn_save">Salva Modifiche</span>
          </button>
      </div>
      <p class="cancel-hint" data-i18n="hint_close">Puoi chiudere questa finestra dopo aver salvato.</p>

    </form>
  </div>
  
  <!-- MODAL OPERATORE -->
  <div id="operator-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 id="modal-title" data-i18n="modal_title">Invita Operatore</h3>
      <p class="subtitle" data-i18n="modal_subtitle" style="margin-bottom:15px;">Inserisci il nome. VerrÃ  generato un link.</p>
      
      <div class="input-group">
          <label data-i18n="modal_lbl_name">Nome Operatore</label>
          <input type="text" id="op-name" placeholder="Es: Mario Rossi">
      </div>
      
      <div class="btn-container">
        <button type="button" class="btn btn-secondary" onclick="closeModal()"><span data-i18n="btn_cancel">Annulla</span></button>
        <button type="button" class="btn btn-primary" onclick="generateInvitation()"><span data-i18n="btn_generate">Genera Invito</span></button>
      </div>
    </div>
  </div>

  <script>
    // WEBHOOK PER CARICAMENTO E SALVATAGGIO (PROTEZIONE TOKEN)
    const WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/83acc670-15ae-4da0-ae0e-3587c85bd5f4";
    const BOT_USERNAME = "TrinAi_SiteBoS_bot"; // Sostituisci col tuo bot username reale se diverso
    
    const tg = window.Telegram.WebApp; 
    tg.ready(); tg.expand();

    // 1. GESTIONE URL & TOKEN
    const urlParams = new URLSearchParams(window.location.search);
    const accessToken = urlParams.get('token'); // IL NUOVO PARAMETRO SICURO
    const langParam = urlParams.get('lang') || 'it';

    // Strutture Dati
    let ownerData = null; // Dati completi dal DB
    let operators = [];   // Array operatori locali
    let initialHash = ""; // Per check modifiche

    // DOM REF
    const dom = {
        loader: document.getElementById('loader'),
        app: document.getElementById('app-content'),
        denied: document.getElementById('access-denied'),
        saveBtn: document.getElementById('saveBtn'),
        // Fields
        name: document.getElementById('name'), surname: document.getElementById('surname'),
        email: document.getElementById('email'), phone: document.getElementById('phone'),
        ragioneSociale: document.getElementById('ragione_sociale'), vatNumber: document.getElementById('vat_number'),
        indirizzo: document.getElementById('indirizzo'), site: document.getElementById('site'),
        linkedin: document.getElementById('linkedin_page'), facebook: document.getElementById('facebook_page'),
        geminiKey: document.getElementById('gemini_key'),
        // Time
        tO_from: document.getElementById('owner_unav_from'), tO_to: document.getElementById('owner_unav_to'),
        tP_from: document.getElementById('operator_unav_from'), tP_to: document.getElementById('operator_unav_to'),
        // Ops
        opList: document.getElementById('operators-list'),
        slotCount: document.getElementById('slot-counter'),
        addOpBtn: document.getElementById('add-operator-btn'),
        upgPrompt: document.getElementById('upgrade-prompt'),
        modal: document.getElementById('operator-modal'),
        opName: document.getElementById('op-name')
    };

    // 2. DIZIONARIO 6 LINGUE (INTEGRALE)
    const i18n = {
      it: {
        title: "Gestione Dati Azienda", subtitle: "Modifica le informazioni del tuo account.",
        section_core: "Dati Anagrafici", section_company: "Dati Aziendali", section_config: "Configurazione Operativa",
        lbl_name: "Nome", lbl_surname: "Cognome", lbl_email: "Email", lbl_phone: "Telefono",
        lbl_company_name: "Ragione Sociale", lbl_vat: "P.IVA (Non modificabile)", lbl_address: "Indirizzo", lbl_site: "Sito Web",
        lbl_owner_avail: "Orari NON reperibilitÃ  (Owner)", lbl_op_avail: "Orari NON reperibilitÃ  (Operatori)",
        op_title: "Gestione Operatori", op_btn_invite: "Invita Nuovo Operatore", op_limit_reached: "Limite raggiunto.",
        op_status_pending: "In attesa", op_invite_text: "Invia questo link:", op_btn_copy: "Copia", op_copied: "Copiato!",
        modal_title: "Invita Operatore", modal_subtitle: "Inserisci il nome per generare il link.", modal_lbl_name: "Nome Operatore",
        btn_cancel: "Annulla", btn_generate: "Genera Invito", btn_save: "Salva Modifiche", hint_close: "Chiudi dopo aver salvato.",
        error_token_title: "Link Scaduto", error_token_desc: "Il token di accesso non Ã¨ valido o Ã¨ scaduto.",
        alert_del: "Eliminare operatore?", alert_revoke: "Revocare invito?", alert_saved: "Dati salvati con successo!", alert_err: "Errore durante il salvataggio."
      },
      en: {
        title: "Company Data Management", subtitle: "Edit your account information.",
        section_core: "Personal Data", section_company: "Company Data", section_config: "Operational Config",
        lbl_name: "Name", lbl_surname: "Surname", lbl_email: "Email", lbl_phone: "Phone",
        lbl_company_name: "Company Name", lbl_vat: "VAT ID (Read Only)", lbl_address: "Address", lbl_site: "Website",
        lbl_owner_avail: "Unavailability Hours (Owner)", lbl_op_avail: "Unavailability Hours (Operators)",
        op_title: "Operator Management", op_btn_invite: "Invite New Operator", op_limit_reached: "Limit reached.",
        op_status_pending: "Pending", op_invite_text: "Send this link:", op_btn_copy: "Copy", op_copied: "Copied!",
        modal_title: "Invite Operator", modal_subtitle: "Enter name to generate link.", modal_lbl_name: "Operator Name",
        btn_cancel: "Cancel", btn_generate: "Generate Invite", btn_save: "Save Changes", hint_close: "Close after saving.",
        error_token_title: "Link Expired", error_token_desc: "Access token is invalid or expired.",
        alert_del: "Delete operator?", alert_revoke: "Revoke invite?", alert_saved: "Data saved successfully!", alert_err: "Error saving data."
      },
      fr: {
        title: "Gestion des DonnÃ©es", subtitle: "Modifiez vos informations.",
        section_core: "DonnÃ©es Personnelles", section_company: "DonnÃ©es Entreprise", section_config: "Configuration",
        lbl_name: "PrÃ©nom", lbl_surname: "Nom", lbl_email: "Email", lbl_phone: "TÃ©lÃ©phone",
        lbl_company_name: "Raison Sociale", lbl_vat: "TVA (Lecture seule)", lbl_address: "Adresse", lbl_site: "Site Web",
        lbl_owner_avail: "Heures indisponibilitÃ© (Owner)", lbl_op_avail: "Heures indisponibilitÃ© (OpÃ©rateurs)",
        op_title: "Gestion OpÃ©rateurs", op_btn_invite: "Inviter OpÃ©rateur", op_limit_reached: "Limite atteinte.",
        op_status_pending: "En attente", op_invite_text: "Envoyer ce lien :", op_btn_copy: "Copier", op_copied: "CopiÃ© !",
        modal_title: "Inviter OpÃ©rateur", modal_subtitle: "Entrez le nom.", modal_lbl_name: "Nom",
        btn_cancel: "Annuler", btn_generate: "GÃ©nÃ©rer", btn_save: "Enregistrer", hint_close: "Fermer aprÃ¨s enregistrement.",
        error_token_title: "Lien ExpirÃ©", error_token_desc: "Jeton d'accÃ¨s invalide.",
        alert_del: "Supprimer ?", alert_revoke: "RÃ©voquer ?", alert_saved: "EnregistrÃ© !", alert_err: "Erreur."
      },
      de: {
        title: "Datenverwaltung", subtitle: "Informationen bearbeiten.",
        section_core: "PersÃ¶nliche Daten", section_company: "Firmendaten", section_config: "Konfiguration",
        lbl_name: "Vorname", lbl_surname: "Nachname", lbl_email: "E-Mail", lbl_phone: "Telefon",
        lbl_company_name: "Firmenname", lbl_vat: "USt-IdNr. (SchreibgeschÃ¼tzt)", lbl_address: "Adresse", lbl_site: "Webseite",
        lbl_owner_avail: "NichtverfÃ¼gbarkeit (Inhaber)", lbl_op_avail: "NichtverfÃ¼gbarkeit (Mitarbeiter)",
        op_title: "Mitarbeiter", op_btn_invite: "Einladen", op_limit_reached: "Limit erreicht.",
        op_status_pending: "Ausstehend", op_invite_text: "Link senden:", op_btn_copy: "Kopieren", op_copied: "Kopiert!",
        modal_title: "Einladen", modal_subtitle: "Namen eingeben.", modal_lbl_name: "Name",
        btn_cancel: "Abbrechen", btn_generate: "Erstellen", btn_save: "Speichern", hint_close: "Nach Speichern schlieÃŸen.",
        error_token_title: "Link Abgelaufen", error_token_desc: "Token ungÃ¼ltig.",
        alert_del: "LÃ¶schen?", alert_revoke: "Widerrufen?", alert_saved: "Gespeichert!", alert_err: "Fehler."
      },
      es: {
        title: "GestiÃ³n de Datos", subtitle: "Edita tu informaciÃ³n.",
        section_core: "Datos Personales", section_company: "Datos Empresa", section_config: "ConfiguraciÃ³n",
        lbl_name: "Nombre", lbl_surname: "Apellido", lbl_email: "Email", lbl_phone: "TelÃ©fono",
        lbl_company_name: "RazÃ³n Social", lbl_vat: "IVA (Solo lectura)", lbl_address: "DirecciÃ³n", lbl_site: "Sitio Web",
        lbl_owner_avail: "No disponibilidad (DueÃ±o)", lbl_op_avail: "No disponibilidad (Operadores)",
        op_title: "Operadores", op_btn_invite: "Invitar", op_limit_reached: "LÃ­mite alcanzado.",
        op_status_pending: "Pendiente", op_invite_text: "Enviar enlace:", op_btn_copy: "Copiar", op_copied: "Â¡Copiado!",
        modal_title: "Invitar", modal_subtitle: "Ingresa nombre.", modal_lbl_name: "Nombre",
        btn_cancel: "Cancelar", btn_generate: "Generar", btn_save: "Guardar", hint_close: "Cerrar al terminar.",
        error_token_title: "Enlace Caducado", error_token_desc: "Token invÃ¡lido.",
        alert_del: "Â¿Borrar?", alert_revoke: "Â¿Revocar?", alert_saved: "Â¡Guardado!", alert_err: "Error."
      },
      pt: {
        title: "GestÃ£o de Dados", subtitle: "Edite suas informaÃ§Ãµes.",
        section_core: "Dados Pessoais", section_company: "Dados da Empresa", section_config: "ConfiguraÃ§Ã£o",
        lbl_name: "Nome", lbl_surname: "Sobrenome", lbl_email: "Email", lbl_phone: "Telefone",
        lbl_company_name: "RazÃ£o Social", lbl_vat: "NIF (Leitura)", lbl_address: "EndereÃ§o", lbl_site: "Website",
        lbl_owner_avail: "Indisponibilidade (ProprietÃ¡rio)", lbl_op_avail: "Indisponibilidade (Operadores)",
        op_title: "Operadores", op_btn_invite: "Convidar", op_limit_reached: "Limite atingido.",
        op_status_pending: "Pendente", op_invite_text: "Enviar link:", op_btn_copy: "Copiar", op_copied: "Copiado!",
        modal_title: "Convidar", modal_subtitle: "Insira o nome.", modal_lbl_name: "Nome",
        btn_cancel: "Cancelar", btn_generate: "Gerar", btn_save: "Salvar", hint_close: "Fechar apÃ³s salvar.",
        error_token_title: "Link Expirado", error_token_desc: "Token invÃ¡lido.",
        alert_del: "Excluir?", alert_revoke: "Revogar?", alert_saved: "Salvo!", alert_err: "Erro."
      }
    };

    // Helper: Seleziona lingua
    const lang = i18n[langParam] ? langParam : 'it';
    const t = i18n[lang];

    // APPLICA TRADUZIONI ALL'AVVIO
    function applyTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(t[key]) el.innerText = t[key];
        });
    }
    applyTranslations();

    // POPOLAZIONE SELECTORS ORARI
    function initTimeSelectors() {
        const selects = [dom.tO_from, dom.tO_to, dom.tP_from, dom.tP_to];
        selects.forEach(sel => {
            for(let i=0; i<24; i++) {
                let opt = document.createElement('option');
                opt.value = i;
                opt.innerText = `${i.toString().padStart(2, '0')}:00`;
                sel.appendChild(opt);
            }
        });
    }
    initTimeSelectors();

    // 3. LOGICA LOAD DATA (VIA TOKEN)
    async function loadData() {
        if(!accessToken) {
            dom.loader.classList.add('hidden');
            dom.denied.classList.remove('hidden');
            return;
        }

        try {
            // Chiamata sicura usando il token
            const res = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    action: 'get_owner_data_by_token', 
                    token: accessToken 
                })
            });

            if(!res.ok) throw new Error("Auth Failed");
            
            const data = await res.json();
            ownerData = data.owner_data || data; // Adatta in base alla risposta del tuo backend

            // Popola i campi
            dom.name.value = ownerData.name || '';
            dom.surname.value = ownerData.surname || '';
            dom.email.value = ownerData.email || '';
            dom.phone.value = ownerData.phone || '';
            dom.ragioneSociale.value = ownerData.ragione_sociale || '';
            dom.vatNumber.value = ownerData.vat_number || '';
            dom.indirizzo.value = ownerData.indirizzo || '';
            dom.site.value = ownerData.site || '';
            dom.linkedin.value = ownerData.linkedin_page || '';
            dom.facebook.value = ownerData.facebook_page || '';
            dom.geminiKey.value = ownerData.gemini_key || '';

            // Orari
            const owTime = (ownerData.owner_unavailable_time || "21-7").split('-');
            dom.tO_from.value = owTime[0]; dom.tO_to.value = owTime[1];
            
            const opTime = (ownerData.operator_unavailable_time || "19-9").split('-');
            dom.tP_from.value = opTime[0]; dom.tP_to.value = opTime[1];

            // Operatori (Filtra via l'owner se Ã¨ nella lista come ruolo Owner)
            operators = (ownerData.operators || []).filter(op => op.Role !== 'Owner');
            renderOperators();

            // Hash iniziale per il pulsante salva
            initialHash = JSON.stringify(getDataObj());
            
            dom.loader.classList.add('hidden');
            dom.app.classList.remove('hidden');

        } catch (e) {
            console.error(e);
            dom.loader.classList.add('hidden');
            dom.denied.classList.remove('hidden');
        }
    }

    // 4. RENDER OPERATORI
    function renderOperators() {
        dom.opList.innerHTML = '';
        operators.forEach((op, idx) => {
            const isPending = !op.OperatorChatID; // Se non ha ID Telegram, Ã¨ in attesa
            const inviteLink = `https://t.me/${BOT_USERNAME}?start=${op.invitation_code}`;
            
            let html = `
            <div class="card" style="padding:15px; margin-bottom:10px; display:flex; flex-direction:column; gap:10px; border-left:3px solid ${isPending ? 'var(--warning)' : 'var(--success)'};">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong style="color:#fff;">${op.OperatorName}</strong>
                        <div style="font-size:11px; color:var(--text-secondary);">
                            ${isPending ? `<i class="fas fa-clock"></i> ${t.op_status_pending}` : `<i class="fas fa-check"></i> Attivo (ID: ${op.OperatorChatID})`}
                        </div>
                    </div>
                    <button class="btn-icon btn-delete" onclick="deleteOp(${idx})"><i class="fas fa-trash"></i></button>
                </div>`;
            
            if(isPending) {
                html += `
                <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px;">
                    <small>${t.op_invite_text}</small>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="text" value="${inviteLink}" readonly style="font-size:11px; padding:5px;">
                        <button class="btn btn-sm btn-primary" onclick="copyLink('${inviteLink}', this)">${t.op_btn_copy}</button>
                    </div>
                </div>`;
            }
            
            html += `</div>`;
            dom.opList.innerHTML += html;
        });

        dom.slotCount.innerText = `${operators.length} / 3`;
        if(operators.length >= 3) {
            dom.addOpBtn.classList.add('hidden');
            dom.upgPrompt.classList.remove('hidden');
        } else {
            dom.addOpBtn.classList.remove('hidden');
            dom.upgPrompt.classList.add('hidden');
        }
        checkDirty();
    }

    // 5. LOGICA INTERFACCIA
    function getDataObj() {
        return {
            name: dom.name.value, surname: dom.surname.value,
            email: dom.email.value, phone: dom.phone.value,
            ragione_sociale: dom.ragioneSociale.value,
            indirizzo: dom.indirizzo.value, site: dom.site.value,
            linkedin_page: dom.linkedin.value, facebook_page: dom.facebook.value,
            gemini_key: dom.geminiKey.value,
            owner_unavailable_time: `${dom.tO_from.value}-${dom.tO_to.value}`,
            operator_unavailable_time: `${dom.tP_from.value}-${dom.tP_to.value}`,
            operators: operators
        };
    }

    function checkDirty() {
        const curr = JSON.stringify(getDataObj());
        dom.saveBtn.disabled = (curr === initialHash);
    }

    // Listeners per checkDirty
    document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', checkDirty));

    // Modale
    window.openModal = () => { dom.opName.value = ''; dom.modal.classList.remove('hidden'); }
    window.closeModal = () => dom.modal.classList.add('hidden');

    // Genera Invito
    window.generateInvitation = () => {
        const name = dom.opName.value.trim();
        if(!name) return alert("Inserisci un nome");
        
        // Genera codice univoco (Token + Random)
        const rnd = Math.random().toString(36).substring(7);
        const code = `INV-${rnd}`; 
        
        operators.push({
            OperatorName: name,
            invitation_code: code,
            OperatorChatID: null,
            Role: 'Operator',
            OperatorLenguage: ownerData.lenguage // Eredita lingua owner
        });
        
        renderOperators();
        closeModal();
    }

    window.deleteOp = (idx) => {
        if(confirm(t.alert_del)) {
            operators.splice(idx, 1);
            renderOperators();
        }
    }

    window.copyLink = (txt, btn) => {
        navigator.clipboard.writeText(txt);
        const old = btn.innerText;
        btn.innerText = t.op_copied;
        setTimeout(() => btn.innerText = old, 2000);
    }

    // 6. SALVATAGGIO DATI (SECURE TOKEN)
    window.saveData = async () => {
        dom.saveBtn.disabled = true;
        const icon = dom.saveBtn.querySelector('i');
        icon.className = 'fas fa-circle-notch fa-spin';

        const payload = {
            action: 'save_owner_data_by_token',
            token: accessToken, // AUTH
            data_update: getDataObj()
        };

        try {
            const res = await fetch(WEBHOOK_URL, {
                method: 'POST', 
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            });

            if(res.ok) {
                tg.HapticFeedback.notificationOccurred('success');
                alert(t.alert_saved);
                initialHash = JSON.stringify(getDataObj());
                checkDirty();
            } else {
                throw new Error("Save Failed");
            }
        } catch(e) {
            alert(t.alert_err);
        } finally {
            icon.className = 'fas fa-save';
            checkDirty(); // Riabilita se necessario
        }
    }

    // AVVIO
    loadData();

  </script>
</body>
</html>
