<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nuova Categoria</title>
    
    <!-- Librerie Esterne -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- FontAwesome per le icone -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Nostro CSS Unificato -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        
        <!-- SEZIONE 1: INPUT INIZIALE -->
        <div id="initialInputSection" class="card">
            <h1 id="title"></h1>
            <p class="subtitle" id="subtitle"></p>
            
            <div class="form-group">
                <label for="categoryName" class="required"><span id="lblCatName"></span></label>
                <input type="text" id="categoryName" required placeholder="...">
            </div>
            
            <div class="form-group">
                <label for="categoryDescription"><span id="lblCatDesc"></span></label>
                <textarea id="categoryDescription" rows="3" placeholder="..."></textarea>
            </div>
            
            <div class="btn-container">
                <button id="generateBtn" class="btn btn-primary btn-block">
                    <i class="fas fa-magic"></i> <span id="btnGenText">Genera</span>
                </button>
            </div>
        </div>

        <!-- SEZIONE 2: ESPANSIONE E CURA (INIZIALMENTE NASCOSTA) -->
        <div id="subcategoriesSection" class="hidden card">
            <h3 id="subcatTitle" class="section-title"></h3>
            
            <!-- Lista sottocategorie con stile "list-item" -->
            <ul id="subcategoriesList" style="list-style: none; margin-bottom: 20px;"></ul>
            
            <div class="input-group">
                <label>Aggiungi Manualmente</label>
                <div class="d-flex gap-2">
                    <input type="text" id="manualSubcat" placeholder="">
                    <button id="addSubcatBtn" class="btn btn-secondary btn-icon" style="border-radius: var(--radius-md);">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="btn-container">
                <button id="saveBtn" class="btn btn-success btn-block">
                    <i class="fas fa-save"></i> <span id="btnSaveText">Salva</span>
                </button>
            </div>
        </div>

        <!-- AREA STATO / LOADING -->
        <div id="status" class="text-center mt-2"></div>
    </div>

    <script>
        const GENERATE_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/5e225cf6-76bb-4e19-8657-35cac49fd399";
        const SAVE_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/7da6f424-dc2a-4476-a0bd-a3bfd21270fb";

        const translations = {
            it: {
                title: "➕ Nuova Categoria", subtitle: "Definisci una nuova area per i tuoi prodotti o servizi.",
                lblCatName: "Nome Categoria", lblCatDesc: "Descrizione (Opzionale)",
                btnGenerate: "Genera Servizi con AI", btnGenerating: "Analisi in corso...",
                subcatTitle: "Seleziona i servizi da includere",
                manualSubcatPlaceholder: "Es. Manutenzione ordinaria...", 
                btnSave: "Salva Categoria e Servizi", btnSaving: "Salvataggio...",
                statusGenerating: "Il tuo assistente sta pensando...", statusError: "❌ Errore, riprova.",
                statusSuccess: "✅ Fatto! Puoi chiudere."
            },
            en: {
                title: "➕ New Category", subtitle: "Define a new area for your products or services.",
                lblCatName: "Category Name", lblCatDesc: "Description (Optional)",
                btnGenerate: "Generate Services with AI", btnGenerating: "Analyzing...",
                subcatTitle: "Select the services to include",
                manualSubcatPlaceholder: "E.g. Standard maintenance...", 
                btnSave: "Save Category and Services", btnSaving: "Saving...",
                statusGenerating: "Your assistant is thinking...", statusError: "❌ Error, please try again.",
                statusSuccess: "✅ Done! You can close now."
            },
            fr: {
                title: "➕ Nouvelle Catégorie", subtitle: "Définissez une nouvelle zone pour vos produits ou services.",
                lblCatName: "Nom de la Catégorie", lblCatDesc: "Description (Optionnel)",
                btnGenerate: "Générer des Services avec IA", btnGenerating: "Analyse en cours...",
                subcatTitle: "Sélectionnez les services à inclure",
                manualSubcatPlaceholder: "Ex. Entretien courant...", 
                btnSave: "Enregistrer Catégorie et Services", btnSaving: "Enregistrement...",
                statusGenerating: "Votre assistant réfléchit...", statusError: "❌ Erreur, veuillez réessayer.",
                statusSuccess: "✅ Terminé ! Vous pouvez fermer."
            },
            de: {
                title: "➕ Neue Kategorie", subtitle: "Definieren Sie einen neuen Bereich für Ihre Produkte oder Dienstleistungen.",
                lblCatName: "Kategoriename", lblCatDesc: "Beschreibung (Optional)",
                btnGenerate: "KI-gestützte Dienstvorschläge", btnGenerating: "Analysiere...",
                subcatTitle: "Wählen Sie die einzuschließenden Dienste aus",
                manualSubcatPlaceholder: "Z.B. Standardwartung...", 
                btnSave: "Kategorie und Dienste speichern", btnSaving: "Speichern...",
                statusGenerating: "Ihr Assistent denkt nach...", statusError: "❌ Fehler, bitte erneut versuchen.",
                statusSuccess: "✅ Fertig! Sie können schließen."
            },
            es: {
                title: "➕ Nueva Categoría", subtitle: "Define una nueva área para tus productos o servicios.",
                lblCatName: "Nombre de la Categoría", lblCatDesc: "Descripción (Opcional)",
                btnGenerate: "Generar Servicios con IA", btnGenerating: "Analizando...",
                subcatTitle: "Selecciona los servicios a incluir",
                manualSubcatPlaceholder: "Ej. Mantenimiento estándar...", 
                btnSave: "Guardar Categoría y Servicios", btnSaving: "Guardando...",
                statusGenerating: "Tu asistente está pensando...", statusError: "❌ Error, por favor inténtalo de nuevo.",
                statusSuccess: "✅ ¡Hecho! Ya puedes cerrar."
            },
            pt: {
                title: "➕ Nova Categoria", subtitle: "Defina uma nova área para seus produtos ou serviços.",
                lblCatName: "Nome da Categoria", lblCatDesc: "Descrição (Opcional)",
                btnGenerate: "Gerar Serviços com IA", btnGenerating: "Analisando...",
                subcatTitle: "Selecione os serviços a incluir",
                manualSubcatPlaceholder: "Ex. Manutenção padrão...", 
                btnSave: "Salvar Categoria e Serviços", btnSaving: "Salvando...",
                statusGenerating: "Seu assistente está pensando...", statusError: "❌ Erro, por favor tente novamente.",
                statusSuccess: "✅ Feito! Pode fechar agora."
            }
        };

        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('chat_id');
        const lang = urlParams.get('language') || 'it';
        const t = translations[lang] || translations.it;

        const dom = {
            initialSection: document.getElementById('initialInputSection'),
            subcatSection: document.getElementById('subcategoriesSection'),
            generateBtn: document.getElementById('generateBtn'),
            btnGenText: document.getElementById('btnGenText'),
            saveBtn: document.getElementById('saveBtn'),
            btnSaveText: document.getElementById('btnSaveText'),
            subcatList: document.getElementById('subcategoriesList'),
            manualSubcatInput: document.getElementById('manualSubcat'),
            addSubcatBtn: document.getElementById('addSubcatBtn'),
            status: document.getElementById('status'),
            categoryName: document.getElementById('categoryName'),
            categoryDescription: document.getElementById('categoryDescription'),
        };
        
        let generatedCategoryData = null;

        function applyTranslations() {
            document.title = t.title;
            document.getElementById('title').innerHTML = t.title;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('lblCatName').textContent = t.lblCatName;
            document.getElementById('lblCatDesc').textContent = t.lblCatDesc;
            dom.btnGenText.textContent = t.btnGenerate;
            document.getElementById('subcatTitle').textContent = t.subcatTitle;
            dom.manualSubcatInput.placeholder = t.manualSubcatPlaceholder;
            dom.btnSaveText.textContent = t.btnSave;
        }

        // Funzione helper per creare l'elemento lista con lo stile unificato
        function createSubcategoryItem(subcatObject, isChecked = true) {
            const li = document.createElement('li');
            li.className = 'list-item'; // Classe da style.css

            const checkboxGroup = document.createElement('div');
            checkboxGroup.className = 'checkbox-group';
            checkboxGroup.style.marginBottom = '0'; // Override per liste

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `chk_${subcatObject.name.replace(/\s/g, '_')}`;
            checkbox.checked = isChecked;
            checkbox.value = subcatObject.name;

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = subcatObject.short_name;

            checkboxGroup.appendChild(checkbox);
            checkboxGroup.appendChild(label);
            li.appendChild(checkboxGroup);
            
            return li;
        }

        dom.generateBtn.addEventListener('click', async () => {
            const categoryName = dom.categoryName.value;
            if (!categoryName) { tg.showAlert('Il nome della categoria è obbligatorio!'); return; }
            
            dom.generateBtn.disabled = true;
            dom.btnGenText.textContent = t.btnGenerating;
            dom.status.innerHTML = `<div class="spinner"></div><p style="margin-top:10px">${t.statusGenerating}</p>`;

            try {
                const response = await fetch(GENERATE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category_name: categoryName,
                        category_description: dom.categoryDescription.value,
                        chat_id: chatId, language: lang
                    })
                });
                const data = await response.json();
                
                generatedCategoryData = data;
                
                dom.categoryName.value = data.name;
                dom.categoryName.disabled = true; // Styling disabled input
                dom.categoryDescription.disabled = true;

                dom.subcatList.innerHTML = '';
                if (data.subcategories && data.subcategories.length > 0) {
                    data.subcategories.forEach(subcat => {
                        dom.subcatList.appendChild(createSubcategoryItem(subcat));
                    });
                }
                
                dom.initialSection.classList.add('hidden');
                dom.subcatSection.classList.remove('hidden');
                dom.status.innerHTML = '';
                
            } catch (error) {
                console.error("Errore:", error);
                dom.status.innerHTML = `<span style="color:var(--error)">${t.statusError}</span>`;
                dom.generateBtn.disabled = false;
                dom.btnGenText.textContent = t.btnGenerate;
            }
        });

        dom.addSubcatBtn.addEventListener('click', () => {
            const newSubcatName = dom.manualSubcatInput.value.trim();
            if (newSubcatName) {
                const manualObject = { name: newSubcatName, short_name: newSubcatName };
                dom.subcatList.appendChild(createSubcategoryItem(manualObject));
                dom.manualSubcatInput.value = '';
            }
        });

        dom.saveBtn.addEventListener('click', async () => {
            dom.saveBtn.disabled = true;
            dom.btnSaveText.textContent = t.btnSaving;
            dom.status.innerHTML = `<div class="spinner"></div>`;
            
            const selectedSubcatNames = Array.from(dom.subcatList.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            const selectedSubcategories = generatedCategoryData.subcategories.filter(
                subcat => selectedSubcatNames.includes(subcat.name)
            );

            // Gestione voci manuali
            const manualNames = selectedSubcatNames.filter(name => !generatedCategoryData.subcategories.some(s => s.name === name));
            
            manualNames.forEach(name => {
                selectedSubcategories.push({
                    name: name,
                    short_name: name,
                    callback_data: name.toUpperCase().replace(/ /g, '_')
                });
            });

            const finalPayload = {
                chat_id: chatId,
                new_category_block: {
                    name: generatedCategoryData.name,
                    short_name: generatedCategoryData.short_name,
                    callback_data: generatedCategoryData.callback_data,
                    subcategories: selectedSubcategories
                },
                user_data: tg.initDataUnsafe?.user,
                language: lang
            };

            try {
                const response = await fetch(SAVE_WEBHOOK_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(finalPayload)
                });
                
                if (response.ok) {
                    dom.status.innerHTML = `<div style="color:var(--success); font-weight:bold; font-size:16px;">${t.statusSuccess}</div>`;
                    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                    setTimeout(() => tg.close(), 1500);
                } else {
                    throw new Error('Server Error');
                }
            } catch (error) {
                dom.status.innerHTML = `<span style="color:var(--error)">${t.statusError}</span>`;
                dom.saveBtn.disabled = false;
                dom.btnSaveText.textContent = t.btnSave;
            }
        });

        applyTranslations();
    </script>
</body>
</html>
