<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Nuova Nota / ToDo</title>
  
  <!-- Telegram Web App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Unified Style -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1 id="title"></h1>
    <p class="subtitle" id="subtitle"></p>
    
    <form id="noteForm">
      <div class="form-group">
        <label for="noteContent" class="required"><span id="lblContent"></span></label>
        <!-- Aggiunto placeholder generico per UX -->
        <textarea id="noteContent" required placeholder="..."></textarea>
      </div>
      
      <!-- Layout a griglia aggiornato per style.css -->
      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="notePriority"><span id="lblPriority"></span></label>
            <select id="notePriority">
              <option value="LOW" id="optLow"></option>
              <option value="MEDIUM" id="optMedium" selected></option>
              <option value="HIGH" id="optHigh"></option>
            </select>
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="noteDueDate"><span id="lblDueDate"></span></label>
            <input type="date" id="noteDueDate">
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="noteTags"><span id="lblTags"></span></label>
        <input type="text" id="noteTags">
        <div class="hint" id="hintTags"></div>
      </div>
      
      <div class="button-container">
        <button type="submit" id="submitBtn" class="btn btn-primary btn-block" disabled>
          <i class="fas fa-plus-circle"></i> <span id="btnText"></span>
        </button>
      </div>
      <p class="cancel-hint" id="cancelHint"></p>
    </form>
  </div>

  <script>
    const translations = {
      it: {
        title: "ğŸ“ Nuovo ToDo",
        subtitle: "Cattura un compito o un'idea con tutti i dettagli.",
        lblContent: "ğŸ“„ Contenuto del ToDo",
        lblPriority: "ğŸš¦ PrioritÃ ",
        optLow: "ğŸ”µ Bassa",
        optMedium: "ğŸŸ¡ Media",
        optHigh: "ğŸ”´ Alta",
        lblDueDate: "ğŸ—“ï¸ Scadenza",
        lblTags: "ğŸ·ï¸ Tag (Opzionale)",
        hintTags: "Separa i tag con una virgola (es. fatture, urgente)",
        btnSubmit: "Aggiungi ToDo",
        btnSuccess: "Aggiunto! Puoi chiudere.",
        cancelHint: "Per annullare, basta chiudere questa finestra."
      },
      en: {
        title: "ğŸ“ New ToDo",
        subtitle: "Capture a task or an idea with all the details.",
        lblContent: "ğŸ“„ ToDo Content",
        lblPriority: "ğŸš¦ Priority",
        optLow: "ğŸ”µ Low",
        optMedium: "ğŸŸ¡ Medium",
        optHigh: "ğŸ”´ High",
        lblDueDate: "ğŸ—“ï¸ Due Date",
        lblTags: "ğŸ·ï¸ Tags (Optional)",
        hintTags: "Separate tags with a comma (e.g., invoices, urgent)",
        btnSubmit: "Add ToDo",
        btnSuccess: "Added! You can close now.",
        cancelHint: "To cancel, just close this window."
      },
      fr: {
        title: "ğŸ“ Nouveau ToDo",
        subtitle: "Saisissez une tÃ¢che ou une idÃ©e avec tous les dÃ©tails.",
        lblContent: "ğŸ“„ Contenu du ToDo",
        lblPriority: "ğŸš¦ PrioritÃ©",
        optLow: "ğŸ”µ Basse",
        optMedium: "ğŸŸ¡ Moyenne",
        optHigh: "ğŸ”´ Ã‰levÃ©e",
        lblDueDate: "ğŸ—“ï¸ Ã‰chÃ©ance",
        lblTags: "ğŸ·ï¸ Ã‰tiquettes (Optionnel)",
        hintTags: "SÃ©parez par une virgule (ex: factures, urgent)",
        btnSubmit: "Ajouter ToDo",
        btnSuccess: "AjoutÃ© ! Vous pouvez fermer.",
        cancelHint: "Pour annuler, fermez simplement cette fenÃªtre."
      },
      de: {
        title: "ğŸ“ Neues ToDo",
        subtitle: "Erfassen Sie eine Aufgabe oder Idee mit allen Details.",
        lblContent: "ğŸ“„ ToDo-Inhalt",
        lblPriority: "ğŸš¦ PrioritÃ¤t",
        optLow: "ğŸ”µ Niedrig",
        optMedium: "ğŸŸ¡ Mittel",
        optHigh: "ğŸ”´ Hoch",
        lblDueDate: "ğŸ—“ï¸ FÃ¤lligkeit",
        lblTags: "ğŸ·ï¸ Tags (Optional)",
        hintTags: "Mit Komma trennen (z.B. rechnungen, dringend)",
        btnSubmit: "ToDo hinzufÃ¼gen",
        btnSuccess: "HinzugefÃ¼gt! Du kannst jetzt schlieÃŸen.",
        cancelHint: "Zum Abbrechen einfach dieses Fenster schlieÃŸen."
      },
      es: {
        title: "ğŸ“ Nuevo ToDo",
        subtitle: "Captura una tarea o una idea con todos los detalles.",
        lblContent: "ğŸ“„ Contenido del ToDo",
        lblPriority: "ğŸš¦ Prioridad",
        optLow: "ğŸ”µ Baja",
        optMedium: "ğŸŸ¡ Media",
        optHigh: "ğŸ”´ Alta",
        lblDueDate: "ğŸ—“ï¸ Vencimiento",
        lblTags: "ğŸ·ï¸ Etiquetas (Opcional)",
        hintTags: "Separa con coma (ej: facturas, urgente)",
        btnSubmit: "AÃ±adir ToDo",
        btnSuccess: "Â¡AÃ±adido! Ya puedes cerrar.",
        cancelHint: "Para cancelar, simplemente cierra esta ventana."
      },
      pt: {
        title: "ğŸ“ Novo ToDo",
        subtitle: "Capture uma tarefa ou ideia com todos os detalhes.",
        lblContent: "ğŸ“„ ConteÃºdo do ToDo",
        lblPriority: "ğŸš¦ Prioridade",
        optLow: "ğŸ”µ Baixa",
        optMedium: "ğŸŸ¡ MÃ©dia",
        optHigh: "ğŸ”´ Alta",
        lblDueDate: "ğŸ—“ï¸ Vencimento",
        lblTags: "ğŸ·ï¸ Tags (Opcional)",
        hintTags: "Separe com vÃ­rgula (ex: faturas, urgente)",
        btnSubmit: "Adicionar ToDo",
        btnSuccess: "Adicionado! Pode fechar agora.",
        cancelHint: "Para cancelar, basta fechar esta janela."
      }
    };
    
    const N8N_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/a0b6b2cb-4e19-4a92-9269-6b6d8a7afb80";
    
    try {
      const tg = window.Telegram.WebApp;
      tg.ready(); tg.expand();
      
      const urlParams = new URLSearchParams(window.location.search);
      const lang = urlParams.get('lang') || 'it';
      const t = translations[lang] || translations.it; // Default to Italian if lang not found
      
      function applyTranslations() {
        document.title = t.title.replace(/<[^>]*>?/gm, '');
        document.getElementById('title').innerHTML = t.title;
        document.getElementById('subtitle').textContent = t.subtitle;
        document.getElementById('lblContent').textContent = t.lblContent;
        document.getElementById('lblPriority').textContent = t.lblPriority;
        document.getElementById('optLow').textContent = t.optLow;
        document.getElementById('optMedium').textContent = t.optMedium;
        document.getElementById('optHigh').textContent = t.optHigh;
        document.getElementById('lblDueDate').textContent = t.lblDueDate;
        document.getElementById('lblTags').textContent = t.lblTags;
        document.getElementById('hintTags').textContent = t.hintTags;
        // Aggiorno lo span dentro il bottone, non il bottone intero (per preservare l'icona)
        document.getElementById('btnText').textContent = t.btnSubmit;
        document.getElementById('cancelHint').textContent = t.cancelHint;
      }
      applyTranslations();

      // Data minima oggi
      function setMinDate() {
        const dueDateInput = document.getElementById('noteDueDate');
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const minDate = `${year}-${month}-${day}`;
        dueDateInput.setAttribute('min', minDate);
      }
      setMinDate();
      
      const form = document.getElementById('noteForm');
      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const noteContent = document.getElementById('noteContent');
      
      function validateForm() {
        submitBtn.disabled = noteContent.value.trim() === '';
      }
      noteContent.addEventListener('input', validateForm);
      // Run validation on load in case of browser autofill
      validateForm();
      
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        // UI Feedback immediato
        submitBtn.disabled = true;
        const originalBtnText = btnText.textContent;
        btnText.textContent = "Invio in corso...";
        
        const tagsValue = document.getElementById('noteTags').value.trim();
        const tagsArray = tagsValue ? tagsValue.split(',').map(tag => tag.trim()).filter(Boolean) : [];

        const noteData = {
          type: 'TODO_SUBMISSION',
          payload: {
              content: noteContent.value.trim(),
              priority: document.getElementById('notePriority').value,
              due_date: document.getElementById('noteDueDate').value || null,
              tags: tagsArray
          },
          context: {
              chatId: urlParams.get('chatId'),
              threadId: urlParams.get('threadId'),
              language: lang,
              timestamp: new Date().toISOString()
          }
        };

        fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(noteData)
        })
        .then(response => {
            if (response.ok) {
                btnText.textContent = t.btnSuccess;
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');
                setTimeout(() => { tg.close(); }, 1200);
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            btnText.textContent = "Errore. Riprova.";
            submitBtn.disabled = false;
            setTimeout(() => { btnText.textContent = originalBtnText; }, 2000);
        });
      });

    } catch (error) {
        console.error("Critical error:", error);
    }
  </script>
</body>
</html>
