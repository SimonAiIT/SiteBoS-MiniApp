<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Nuova Nota / ToDo</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-start: #4a5b8f; --bg-end: #2a3d5f; --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7); --border-color: rgba(255, 255, 255, 0.2);
      --input-bg: rgba(255, 255, 255, 0.08); --accent-color: #5B6FED;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text-primary); padding: 20px; min-height: 100vh;
    }
    .container { max-width: 500px; margin: 0 auto; }
    h1 { font-size: 26px; margin-bottom: 8px; font-weight: 600; }
    .subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 32px; font-weight: 300; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 10px; font-size: 14px; font-weight: 500; }
    
    input, textarea, select {
      width: 100%; padding: 14px 16px; border: 1px solid var(--border-color);
      border-radius: 12px; background: var(--input-bg); backdrop-filter: blur(10px);
      color: var(--text-primary); font-size: 15px; font-family: inherit;
      -webkit-appearance: none;
      appearance: none;
    }
    
    select {
        background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 16px center;
        padding-right: 40px;
    }
    
    /* NUOVA REGOLA: Stile per le opzioni del menu a tendina */
    option {
      background: var(--bg-end); /* Usa un colore di sfondo solido per la lista */
      color: var(--text-primary);
    }

    /* NUOVA REGOLA: Rende l'icona del calendario piÃ¹ grande, bianca e cliccabile */
    input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      opacity: 0.7;
      filter: invert(1); /* Rende l'icona bianca */
      transform: scale(1.2); /* Aumenta la dimensione del 20% */
      transition: opacity 0.2s ease;
    }
    input[type="date"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }

    input:focus, textarea:focus, select:focus {
      outline: none; border-color: rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 15px rgba(91, 111, 237, 0.3);
    }
    textarea { resize: vertical; min-height: 120px; }
    .required::after { content: " *"; color: #ff6b6b; }
    .button-container { text-align: center; margin-top: 32px; }
    #submitBtn {
      width: 100%; padding: 14px; background: var(--accent-color); color: var(--text-primary);
      border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer;
    }
    #submitBtn:disabled { background: #555; cursor: not-allowed; opacity: 0.6; }
    .cancel-hint { text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-secondary); opacity: 0.8; }
    .hint { font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 6px; }
    .row { display: flex; gap: 16px; }
    .row .form-group { flex: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title"></h1>
    <p class="subtitle" id="subtitle"></p>
    
    <form id="noteForm">
      <div class="form-group">
        <label for="noteContent" class="required"><span id="lblContent"></span></label>
        <textarea id="noteContent" required></textarea>
      </div>
      
      <div class="row">
        <div class="form-group">
          <label for="notePriority"><span id="lblPriority"></span></label>
          <select id="notePriority">
            <option value="LOW" id="optLow"></option>
            <option value="MEDIUM" id="optMedium" selected></option>
            <option value="HIGH" id="optHigh"></option>
          </select>
        </div>
        <div class="form-group">
          <label for="noteDueDate"><span id="lblDueDate"></span></label>
          <input type="date" id="noteDueDate">
        </div>
      </div>
      
      <div class="form-group">
        <label for="noteTags"><span id="lblTags"></span></label>
        <input type="text" id="noteTags">
        <div class="hint" id="hintTags"></div>
      </div>
      
      <div class="button-container">
        <button type="submit" id="submitBtn"></button>
      </div>
      <p class="cancel-hint" id="cancelHint"></p>
    </form>
  </div>

  <script>
    const translations = {
      it: {
        title: "ğŸ“ Nuovo ToDo",
        subtitle: "Cattura un compito o un'idea con tutti i dettagli.",
        lblContent: "ğŸ“„ Contenuto del ToDo",
        lblPriority: "ğŸš¦ PrioritÃ ",
        optLow: "ğŸ”µ Bassa",
        optMedium: "ğŸŸ¡ Media",
        optHigh: "ğŸ”´ Alta",
        lblDueDate: "ğŸ—“ï¸ Scadenza (Opzionale)",
        lblTags: "ğŸ·ï¸ Tag (Opzionale)",
        hintTags: "Separa i tag con una virgola (es. fatture, urgente)",
        btnSubmit: "Aggiungi ToDo",
        btnSuccess: "Aggiunto! Puoi chiudere.",
        cancelHint: "Per annullare, basta chiudere questa finestra."
      },
      en: {
        title: "ğŸ“ New ToDo",
        subtitle: "Capture a task or an idea with all the details.",
        lblContent: "ğŸ“„ ToDo Content",
        lblPriority: "ğŸš¦ Priority",
        optLow: "ğŸ”µ Low",
        optMedium: "ğŸŸ¡ Medium",
        optHigh: "ğŸ”´ High",
        lblDueDate: "ğŸ—“ï¸ Due Date (Optional)",
        lblTags: "ğŸ·ï¸ Tags (Optional)",
        hintTags: "Separate tags with a comma (e.g., invoices, urgent)",
        btnSubmit: "Add ToDo",
        btnSuccess: "Added! You can close now.",
        cancelHint: "To cancel, just close this window."
      },
      fr: {
        title: "ğŸ“ Nouveau ToDo",
        subtitle: "Saisissez une tÃ¢che ou une idÃ©e avec tous les dÃ©tails.",
        lblContent: "ğŸ“„ Contenu du ToDo",
        lblPriority: "ğŸš¦ PrioritÃ©",
        optLow: "ğŸ”µ Basse",
        optMedium: "ğŸŸ¡ Moyenne",
        optHigh: "ğŸ”´ Ã‰levÃ©e",
        lblDueDate: "ğŸ—“ï¸ Ã‰chÃ©ance (Optionnel)",
        lblTags: "ğŸ·ï¸ Ã‰tiquettes (Optionnel)",
        hintTags: "SÃ©parez les Ã©tiquettes par une virgule (ex: factures, urgent)",
        btnSubmit: "Ajouter ToDo",
        btnSuccess: "AjoutÃ© ! Vous pouvez fermer.",
        cancelHint: "Pour annuler, fermez simplement cette fenÃªtre."
      },
      de: {
        title: "ğŸ“ Neues ToDo",
        subtitle: "Erfassen Sie eine Aufgabe oder Idee mit allen Details.",
        lblContent: "ğŸ“„ ToDo-Inhalt",
        lblPriority: "ğŸš¦ PrioritÃ¤t",
        optLow: "ğŸ”µ Niedrig",
        optMedium: "ğŸŸ¡ Mittel",
        optHigh: "ğŸ”´ Hoch",
        lblDueDate: "ğŸ—“ï¸ FÃ¤lligkeitsdatum (Optional)",
        lblTags: "ğŸ·ï¸ Tags (Optional)",
        hintTags: "Trennen Sie Tags mit einem Komma (z.B. rechnungen, dringend)",
        btnSubmit: "ToDo hinzufÃ¼gen",
        btnSuccess: "HinzugefÃ¼gt! Du kannst jetzt schlieÃŸen.",
        cancelHint: "Zum Abbrechen einfach dieses Fenster schlieÃŸen."
      },
      es: {
        title: "ğŸ“ Nuevo ToDo",
        subtitle: "Captura una tarea o una idea con todos los detalles.",
        lblContent: "ğŸ“„ Contenido del ToDo",
        lblPriority: "ğŸš¦ Prioridad",
        optLow: "ğŸ”µ Baja",
        optMedium: "ğŸŸ¡ Media",
        optHigh: "ğŸ”´ Alta",
        lblDueDate: "ğŸ—“ï¸ Fecha de Vencimiento (Opcional)",
        lblTags: "ğŸ·ï¸ Etiquetas (Opcional)",
        hintTags: "Separa las etiquetas con una coma (ej: facturas, urgente)",
        btnSubmit: "AÃ±adir ToDo",
        btnSuccess: "Â¡AÃ±adido! Ya puedes cerrar.",
        cancelHint: "Para cancelar, simplemente cierra esta ventana."
      },
      pt: {
        title: "ğŸ“ Novo ToDo",
        subtitle: "Capture uma tarefa ou ideia com todos os detalhes.",
        lblContent: "ğŸ“„ ConteÃºdo do ToDo",
        lblPriority: "ğŸš¦ Prioridade",
        optLow: "ğŸ”µ Baixa",
        optMedium: "ğŸŸ¡ MÃ©dia",
        optHigh: "ğŸ”´ Alta",
        lblDueDate: "ğŸ—“ï¸ Data de Vencimento (Opcional)",
        lblTags: "ğŸ·ï¸ Tags (Opcional)",
        hintTags: "Separe as tags com uma vÃ­rgula (ex: faturas, urgente)",
        btnSubmit: "Adicionar ToDo",
        btnSuccess: "Adicionado! Pode fechar agora.",
        cancelHint: "Para cancelar, basta fechar esta janela."
      }
    };
    
    const N8N_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/a0b6b2cb-4e19-4a92-9269-6b6d8a7afb80";
    
    try {
      const tg = window.Telegram.WebApp;
      tg.ready(); tg.expand();
      
      const urlParams = new URLSearchParams(window.location.search);
      const lang = urlParams.get('lang') || 'it';
      const t = translations[lang] || translations.it;
      
      function applyTranslations() {
        document.title = t.title.replace(/<[^>]*>?/gm, '');
        document.getElementById('title').innerHTML = t.title;
        document.getElementById('subtitle').textContent = t.subtitle;
        document.getElementById('lblContent').textContent = t.lblContent;
        document.getElementById('lblPriority').textContent = t.lblPriority;
        document.getElementById('optLow').textContent = t.optLow;
        document.getElementById('optMedium').textContent = t.optMedium;
        document.getElementById('optHigh').textContent = t.optHigh;
        document.getElementById('lblDueDate').textContent = t.lblDueDate;
        document.getElementById('lblTags').textContent = t.lblTags;
        document.getElementById('hintTags').textContent = t.hintTags;
        document.getElementById('submitBtn').textContent = t.btnSubmit;
        document.getElementById('cancelHint').textContent = t.cancelHint;
      }
      applyTranslations();
      
      const form = document.getElementById('noteForm');
      const submitBtn = document.getElementById('submitBtn');
      const noteContent = document.getElementById('noteContent');
      
      function validateForm() {
        submitBtn.disabled = noteContent.value.trim() === '';
      }
      noteContent.addEventListener('input', validateForm);
      validateForm();
      
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const tagsValue = document.getElementById('noteTags').value.trim();
        const tagsArray = tagsValue ? tagsValue.split(',').map(tag => tag.trim()).filter(Boolean) : [];

        const noteData = {
          type: 'TODO_SUBMISSION',
          payload: {
              content: noteContent.value.trim(),
              priority: document.getElementById('notePriority').value,
              due_date: document.getElementById('noteDueDate').value || null,
              tags: tagsArray
          },
          context: {
              chatId: urlParams.get('chatId'),
              threadId: urlParams.get('threadId'),
              language: lang,
              timestamp: new Date().toISOString()
          }
        };

        fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(noteData)
        })
        .finally(() => {
            submitBtn.disabled = true;
            submitBtn.textContent = t.btnSuccess;
            setTimeout(() => { tg.close(); }, 1200);
        });
      });

    } catch (error) { /* ... */ }
  </script>
</body>
</html>
