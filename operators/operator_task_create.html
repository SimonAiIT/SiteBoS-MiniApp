<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuova Missione - SiteBoS</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="operator_session_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-info">
                <h1><i class="fas fa-plus-circle"></i> Nuova Missione</h1>
                <small id="step-indicator">Chi √® il beneficiario?</small>
            </div>
        </div>

        <!-- STEP 1: Target Selection -->
        <div id="step-target" class="step-container">
            <div class="card">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-crosshairs"></i> Seleziona Target</h3>
                
                <div class="target-option" data-option="new">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="dash-icon" style="width: 50px; height: 50px; font-size: 24px;">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0;">Nuovo Cliente</h4>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
                                Digital Handshake - QR Code o Smart Link
                            </p>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                </div>

                <div class="target-option" data-option="known">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="dash-icon" style="width: 50px; height: 50px; font-size: 24px;">
                            <i class="fas fa-address-book"></i>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0;">Cliente Noto</h4>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
                                Cerca nel database clienti
                            </p>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                </div>

                <div class="target-option" data-option="asset">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="dash-icon" style="width: 50px; height: 50px; font-size: 24px;">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0;">Asset / Interno</h4>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
                                Scan QR o Lavori Interni
                            </p>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: New Client Flow (Digital Handshake) -->
        <div id="step-handshake" class="step-container hidden">
            <div class="card" style="text-align: center;">
                <h3><i class="fas fa-handshake"></i> Digital Handshake</h3>
                <p class="subtitle">Mostra il QR o invia il link al cliente</p>

                <!-- QR Code Container -->
                <div id="qr-container" style="background: white; border-radius: 12px; padding: 20px; margin: 20px 0; display: inline-block;">
                    <div id="qr-code" style="margin: 0 auto;">
                        <!-- QR Code generated here -->
                    </div>
                </div>

                <!-- Smart Link Display -->
                <div style="margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--glass-border);">
                    <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;">Smart Link</p>
                    <p id="smart-link-display" style="font-size: 13px; color: var(--primary); word-break: break-all; margin: 0; font-weight: 600;">
                        Generazione in corso...
                    </p>
                </div>

                <!-- Copy Link Button -->
                <div style="margin: 20px 0;">
                    <button class="btn btn-secondary btn-block" id="copy-link-btn">
                        <i class="fas fa-link"></i> Copia Smart Link
                    </button>
                    <p class="hint">Invia il link via WhatsApp/Telegram per clienti remoti</p>
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--glass-border);">

                <!-- VERIFY BUTTON (Manual Check) -->
                <div style="margin: 30px 0;">
                    <button class="btn btn-primary btn-block" id="btn-verify" style="font-size: 16px; padding: 15px;">
                        <i class="fas fa-sync-alt"></i> VERIFICA CONNESSIONE
                    </button>
                    <p class="hint" style="margin-top: 10px; font-size: 12px;">
                        Premi quando il cliente ha completato la registrazione
                    </p>
                </div>
            </div>
        </div>

        <!-- STEP 3: Known Client Search -->
        <div id="step-search" class="step-container hidden">
            <div class="card">
                <h3><i class="fas fa-search"></i> Cerca Cliente</h3>
                <div class="form-group">
                    <input 
                        type="text" 
                        id="client-search" 
                        placeholder="Digita nome, email, telefono..."
                    >
                </div>

                <div id="search-results">
                    <!-- Results populated by JS -->
                </div>
            </div>
        </div>

        <!-- STEP 4: Asset Scan / Internal -->
        <div id="step-asset" class="step-container hidden">
            <div class="card">
                <h3><i class="fas fa-camera"></i> Scan Asset o Interno</h3>
                
                <div class="btn-container">
                    <button class="btn btn-block" id="scan-asset-btn">
                        <i class="fas fa-qrcode"></i> Scansiona QR Asset
                    </button>
                    <button class="btn btn-secondary btn-block" id="set-internal-btn">
                        <i class="fas fa-building"></i> Lavoro Interno
                    </button>
                </div>

                <p class="hint" style="margin-top: 15px;">
                    Asset: Identifica l'oggetto da un QR Code<br>
                    Interno: Per routine e manutenzioni aziendali
                </p>
            </div>
        </div>

        <!-- STEP 5: Mission Type Selection (for Persons) -->
        <div id="step-mission-type" class="step-container hidden">
            <div class="card">
                <h3><i class="fas fa-tasks"></i> Tipo di Missione</h3>
                <p class="subtitle">Seleziona cosa vuoi fare</p>

                <div class="mission-option" data-type="preventivo">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="dash-icon" style="width: 50px; height: 50px; font-size: 24px;">
                            üìù
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0;">Preventivo</h4>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
                                Crea un'offerta dal catalogo
                            </p>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                </div>

                <div class="mission-option" data-type="esecuzione">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="dash-icon" style="width: 50px; height: 50px; font-size: 24px;">
                            üî®
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0;">Esecuzione</h4>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
                                Segui un Blueprint operativo
                            </p>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                </div>

                <div class="mission-option" data-type="assistenza">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="dash-icon" style="width: 50px; height: 50px; font-size: 24px;">
                            üÜò
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0;">Assistenza</h4>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
                                Risolvi problemi o ticket
                            </p>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 6: Quote Builder (NEW!) -->
        <div id="step-quote-builder" class="step-container hidden">
            <div class="card">
                <h3><i class="fas fa-shopping-cart"></i> Crea Preventivo</h3>
                <p class="subtitle">Seleziona servizi dal catalogo</p>

                <!-- Catalog Categories Container -->
                <div id="catalog-container" style="margin: 20px 0;">
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 15px; display: block;"></i>
                        <p>Caricamento catalogo...</p>
                    </div>
                </div>
            </div>

            <!-- Floating Cart Summary -->
            <div id="cart-summary" class="card" style="position: sticky; bottom: 20px; z-index: 100; display: none; background: var(--card-bg); border: 2px solid var(--primary); box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;"><i class="fas fa-shopping-cart"></i> Carrello (<span id="cart-count">0</span>)</h4>
                    <button class="btn-icon" onclick="toggleCart()">
                        <i class="fas fa-chevron-down" id="cart-chevron"></i>
                    </button>
                </div>

                <div id="cart-items" class="hidden">
                    <!-- Cart items will be populated here -->
                    <div id="cart-items-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                        <!-- Dynamic content -->
                    </div>

                    <!-- Photo Upload Section -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600;">
                            <i class="fas fa-camera"></i> Foto Allegate (max 5)
                        </label>
                        <div id="photo-slots-container" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 10px;">
                            <!-- Photo slots will be populated by JS -->
                        </div>
                        <input type="file" id="quote-photo-input" accept="image/*" capture="environment" style="display: none;" multiple>
                        <button class="btn btn-secondary btn-sm btn-block" onclick="document.getElementById('quote-photo-input').click()">
                            <i class="fas fa-plus"></i> Aggiungi Foto
                        </button>
                        <p class="hint" style="margin-top: 5px; font-size: 11px;">Scatta o carica fino a 5 foto per il preventivo</p>
                    </div>

                    <!-- Document Upload Section -->
                    <div style="margin-bottom: 15px; padding-top: 15px; border-top: 1px solid var(--glass-border);">
                        <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600;">
                            <i class="fas fa-file-alt"></i> Documenti (max 2)
                        </label>
                        <div id="documents-list" style="margin-bottom: 10px;">
                            <!-- Document items will be populated by JS -->
                        </div>
                        <input type="file" id="quote-document-input" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt" style="display: none;" multiple>
                        <button class="btn btn-secondary btn-sm btn-block" onclick="document.getElementById('quote-document-input').click()">
                            <i class="fas fa-paperclip"></i> Aggiungi Documento
                        </button>
                        <p class="hint" style="margin-top: 5px; font-size: 11px;">PDF, Word, Excel (max 2MB per file)</p>
                    </div>

                    <!-- Notes -->
                    <div class="form-group">
                        <label>Note Aggiuntive</label>
                        <textarea id="quote-notes" rows="3" placeholder="Aggiungi note per il preventivo..."></textarea>
                    </div>

                    <button class="btn btn-success btn-block" id="generate-quote-btn">
                        <i class="fas fa-file-invoice"></i> Genera Preventivo
                    </button>
                </div>
            </div>
        </div>

        <!-- STEP 7: Photo Capture (for Assets) -->
        <div id="step-photo" class="step-container hidden">
            <div class="card">
                <h3><i class="fas fa-camera"></i> Cattura Report</h3>
                <p class="subtitle">Scatta una foto per generare il report automatico</p>

                <div class="upload-box" id="photo-upload" style="min-height: 200px;">
                    <input type="file" id="photo-input" accept="image/*" capture="environment">
                    <div class="upload-icon">üì∑</div>
                    <p>Tocca per scattare o caricare una foto</p>
                </div>

                <div id="photo-preview" class="hidden" style="margin-top: 20px;">
                    <img id="preview-img" style="width: 100%; border-radius: 12px; border: 1px solid var(--glass-border);">
                    <button class="btn btn-success btn-block" id="generate-report-btn" style="margin-top: 15px;">
                        <i class="fas fa-file-alt"></i> Genera Report AI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="fab-container">
        <button class="fab-btn fab-secondary" onclick="goBack()" aria-label="Torna Indietro">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden">
        <div class="loader-content">
            <div class="spinner-ring"></div>
            <p id="loading-text" style="margin-top: 15px; color: var(--text-muted);">Elaborazione...</p>
        </div>
    </div>

    <script src="operator_task_create_logic.js"></script>
</body>
</html>