<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Nuovo Evento Agenda</title>
  
  <!-- Telegram Script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Unified CSS -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1 id="title"></h1>
    <p class="subtitle" id="subtitle"></p>
    
    <!-- Avvolgiamo il form in una card per lo stile "glass" -->
    <div class="card">
      <form id="eventForm">
        <div class="form-group">
          <label for="eventTitle" class="required"><span id="lblTitle"></span></label>
          <input type="text" id="eventTitle" required placeholder="...">
        </div>
        
        <div class="row">
          <div class="col">
            <div class="form-group">
              <label for="eventDate" class="required"><span id="lblDate"></span></label>
              <input type="date" id="eventDate" required>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label for="eventTime" class="required"><span id="lblTime"></span></label>
              <input type="time" id="eventTime" required>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label><span id="lblDuration"></span></label>
          <div class="radio-group">
            <div>
              <input type="radio" name="duration" value="30" id="dur-30" checked>
              <label for="dur-30"><span id="opt30"></span></label>
            </div>
            <div>
              <input type="radio" name="duration" value="60" id="dur-60">
              <label for="dur-60"><span id="opt60"></span></label>
            </div>
            <div>
              <input type="radio" name="duration" value="custom" id="dur-custom">
              <label for="dur-custom"><span id="optCustom"></span></label>
            </div>
          </div>
        </div>
        
        <div id="customEndContainer" class="hidden">
          <div class="row">
              <div class="col">
                <div class="form-group">
                  <label for="eventEndDate" class="required"><span id="lblEndDate"></span></label>
                  <input type="date" id="eventEndDate">
                </div>
              </div>
              <div class="col">
                <div class="form-group">
                  <label for="eventEndTime" class="required"><span id="lblEndTime"></span></label>
                  <input type="time" id="eventEndTime">
                </div>
              </div>
          </div>
          <div id="timeErrorHint" class="hint note note-error hidden" style="margin-top:0;"></div>
        </div>
        
        <div class="form-group">
          <label for="eventDesc"><span id="lblDesc"></span></label>
          <textarea id="eventDesc" rows="3" placeholder="..."></textarea>
        </div>
        
        <div class="form-group">
          <label for="eventLocation"><span id="lblLocation"></span></label>
          <input type="text" id="eventLocation" placeholder="...">
        </div>
        
        <div class="btn-container">
          <button type="submit" id="submitBtn" class="btn btn-primary btn-block"></button>
        </div>
        <p class="cancel-hint" id="cancelHint"></p>
      </form>
    </div>
  </div>

  <script>
    const translations = {
      it: {
        title: "ğŸ—“ï¸ Nuovo Evento", subtitle: "Aggiungi un impegno alla tua agenda",
        lblTitle: "âœï¸ Titolo Evento", lblDate: "ğŸ—“ï¸ Data Inizio", lblTime: "â° Ora Inizio",
        lblDuration: "â±ï¸ Durata", opt30: "30 min", opt60: "60 min", optCustom: "Altro",
        lblEndDate: "ğŸ—“ï¸ Data Fine", lblEndTime: "â° Ora Fine", hintInvalidTime: "âš ï¸ L'ora di fine non puÃ² precedere quella di inizio.",
        lblDesc: "ğŸ“„ Descrizione / Note", lblLocation: "ğŸ“ Luogo",
        btnSubmit: "Aggiungi Evento", btnSuccess: "âœ… Aggiunto! Puoi chiudere.", cancelHint: "Per annullare, basta chiudere questa finestra."
      },
      en: {
        title: "ğŸ—“ï¸ New Event", subtitle: "Add a commitment to your agenda",
        lblTitle: "âœï¸ Event Title", lblDate: "ğŸ—“ï¸ Start Date", lblTime: "â° Start Time",
        lblDuration: "â±ï¸ Duration", opt30: "30 min", opt60: "60 min", optCustom: "Other",
        lblEndDate: "ğŸ—“ï¸ End Date", lblEndTime: "â° End Time", hintInvalidTime: "âš ï¸ End time cannot be earlier than start time.",
        lblDesc: "ğŸ“„ Description / Notes", lblLocation: "ğŸ“ Location",
        btnSubmit: "Add Event", btnSuccess: "âœ… Added! You can close now.", cancelHint: "To cancel, just close this window."
      },
      fr: {
        title: "ğŸ—“ï¸ Nouvel Ã‰vÃ©nement", subtitle: "Ajouter un engagement Ã  votre agenda",
        lblTitle: "âœï¸ Titre", lblDate: "ğŸ—“ï¸ Date dÃ©but", lblTime: "â° Heure dÃ©but",
        lblDuration: "â±ï¸ DurÃ©e", opt30: "30 min", opt60: "60 min", optCustom: "Autre",
        lblEndDate: "ğŸ—“ï¸ Date fin", lblEndTime: "â° Heure fin", hintInvalidTime: "âš ï¸ L'heure de fin ne peut pas Ãªtre antÃ©rieure au dÃ©but.",
        lblDesc: "ğŸ“„ Description", lblLocation: "ğŸ“ Lieu",
        btnSubmit: "Ajouter", btnSuccess: "âœ… AjoutÃ© !", cancelHint: "Fermer pour annuler."
      },
      de: {
        title: "ğŸ—“ï¸ Neues Ereignis", subtitle: "Termin hinzufÃ¼gen",
        lblTitle: "âœï¸ Titel", lblDate: "ğŸ—“ï¸ Startdatum", lblTime: "â° Startzeit",
        lblDuration: "â±ï¸ Dauer", opt30: "30 Min.", opt60: "60 Min.", optCustom: "Andere",
        lblEndDate: "ğŸ—“ï¸ Enddatum", lblEndTime: "â° Endzeit", hintInvalidTime: "âš ï¸ Endzeit ungÃ¼ltig.",
        lblDesc: "ğŸ“„ Beschreibung", lblLocation: "ğŸ“ Ort",
        btnSubmit: "HinzufÃ¼gen", btnSuccess: "âœ… HinzugefÃ¼gt!", cancelHint: "Zum Abbrechen schlieÃŸen."
      },
      es: {
        title: "ğŸ—“ï¸ Nuevo Evento", subtitle: "AÃ±ade un compromiso",
        lblTitle: "âœï¸ TÃ­tulo", lblDate: "ğŸ—“ï¸ Fecha Inicio", lblTime: "â° Hora Inicio",
        lblDuration: "â±ï¸ DuraciÃ³n", opt30: "30 min", opt60: "60 min", optCustom: "Otro",
        lblEndDate: "ğŸ—“ï¸ Fecha Fin", lblEndTime: "â° Hora Fin", hintInvalidTime: "âš ï¸ Hora de fin invÃ¡lida.",
        lblDesc: "ğŸ“„ DescripciÃ³n", lblLocation: "ğŸ“ UbicaciÃ³n",
        btnSubmit: "AÃ±adir", btnSuccess: "âœ… Â¡AÃ±adido!", cancelHint: "Cierra para cancelar."
      },
      pt: {
        title: "ğŸ—“ï¸ Novo Evento", subtitle: "Adicione um compromisso",
        lblTitle: "âœï¸ TÃ­tulo", lblDate: "ğŸ—“ï¸ Data InÃ­cio", lblTime: "â° Hora InÃ­cio",
        lblDuration: "â±ï¸ DuraÃ§Ã£o", opt30: "30 min", opt60: "60 min", optCustom: "Outro",
        lblEndDate: "ğŸ—“ï¸ Data Fim", lblEndTime: "â° Hora Fim", hintInvalidTime: "âš ï¸ Hora de tÃ©rmino invÃ¡lida.",
        lblDesc: "ğŸ“„ DescriÃ§Ã£o", lblLocation: "ğŸ“ LocalizaÃ§Ã£o",
        btnSubmit: "Adicionar", btnSuccess: "âœ… Adicionado!", cancelHint: "Feche para cancelar."
      }
    };
    
    const N8N_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/a0b6b2cb-4e19-4a92-9269-6b6d8a7afb80";
    
    try {
      const tg = window.Telegram.WebApp;
      tg.ready(); tg.expand();
      
      const urlParams = new URLSearchParams(window.location.search);
      const lang = urlParams.get('lang') || 'it';
      const t = translations[lang] || translations.en;
      
      const dom = {
          form: document.getElementById('eventForm'), submitBtn: document.getElementById('submitBtn'),
          eventDate: document.getElementById('eventDate'), eventTime: document.getElementById('eventTime'),
          eventEndDate: document.getElementById('eventEndDate'), eventEndTime: document.getElementById('eventEndTime'),
          durationRadios: document.querySelectorAll('input[name="duration"]'),
          customEndContainer: document.getElementById('customEndContainer'),
          timeErrorHint: document.getElementById('timeErrorHint')
      };

      function applyTranslations() {
        document.title = t.title.replace(/<[^>]*>?/gm, '');
        document.getElementById('title').innerHTML = t.title; document.getElementById('subtitle').textContent = t.subtitle;
        document.getElementById('lblTitle').textContent = t.lblTitle; document.getElementById('lblDate').textContent = t.lblDate;
        document.getElementById('lblTime').textContent = t.lblTime; document.getElementById('lblDuration').textContent = t.lblDuration;
        document.getElementById('opt30').textContent = t.opt30; document.getElementById('opt60').textContent = t.opt60;
        document.getElementById('optCustom').textContent = t.optCustom; document.getElementById('lblEndDate').textContent = t.lblEndDate;
        document.getElementById('lblEndTime').textContent = t.lblEndTime;
        dom.timeErrorHint.textContent = t.hintInvalidTime;
        document.getElementById('lblDesc').textContent = t.lblDesc; document.getElementById('lblLocation').textContent = t.lblLocation;
        dom.submitBtn.textContent = t.btnSubmit; document.getElementById('cancelHint').textContent = t.cancelHint;
      }
      applyTranslations();
      
      function setMinDates() {
        const today = new Date().toISOString().split('T')[0];
        dom.eventDate.setAttribute('min', today); dom.eventDate.value = today;
        dom.eventEndDate.setAttribute('min', today); dom.eventEndDate.value = today;
      }
      setMinDates();

      function updateEndDateTimeConstraints() {
          const startDate = dom.eventDate.value;
          const startTime = dom.eventTime.value;
          dom.eventEndDate.setAttribute('min', startDate);
          if (dom.eventEndDate.value < startDate) dom.eventEndDate.value = startDate;
          if (dom.eventEndDate.value === startDate && startTime) {
              dom.eventEndTime.setAttribute('min', startTime);
          } else {
              dom.eventEndTime.removeAttribute('min');
          }
      }
      
      function validateForm() {
        const requiredInputs = dom.form.querySelectorAll('[required]');
        let isAllFilled = Array.from(requiredInputs).every(input => input.value.trim() !== '');
        
        let isTimeValid = true;
        // Reset stile errore generico
        dom.eventEndTime.style.borderColor = ""; 
        dom.timeErrorHint.classList.add('hidden');
        
        const isCustomDuration = document.querySelector('input[name="duration"]:checked').value === 'custom';
        if (isCustomDuration && dom.eventDate.value === dom.eventEndDate.value && dom.eventTime.value && dom.eventEndTime.value && dom.eventEndTime.value < dom.eventTime.value) {
            isTimeValid = false;
            dom.eventEndTime.style.borderColor = "var(--error)";
            dom.timeErrorHint.classList.remove('hidden');
        }
        
        dom.submitBtn.disabled = !isAllFilled || !isTimeValid;
      }

      ['change', 'input'].forEach(evt => {
          dom.eventDate.addEventListener(evt, updateEndDateTimeConstraints);
          dom.eventTime.addEventListener(evt, updateEndDateTimeConstraints);
          dom.eventEndDate.addEventListener(evt, updateEndDateTimeConstraints);
          dom.form.addEventListener(evt, validateForm);
      });
      
      dom.durationRadios.forEach(radio => {
          radio.addEventListener('change', () => {
              const isCustom = radio.value === 'custom';
              dom.customEndContainer.classList.toggle('hidden', !isCustom);
              dom.eventEndDate.toggleAttribute('required', isCustom);
              dom.eventEndTime.toggleAttribute('required', isCustom);
              if (isCustom) updateEndDateTimeConstraints();
              validateForm();
          });
      });
      
      validateForm();
      
      dom.form.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = dom.submitBtn;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ' + t.btnSubmit; // Spinner icon
        
        const startTimeIso = new Date(`${dom.eventDate.value}T${dom.eventTime.value}`).toISOString();
        const durationChoice = document.querySelector('input[name="duration"]:checked').value;
        let endTimeIso = null; let durationInMinutes = null;
        
        if (durationChoice === 'custom') {
            endTimeIso = new Date(`${dom.eventEndDate.value}T${dom.eventEndTime.value}`).toISOString();
        } else {
            durationInMinutes = parseInt(durationChoice);
        }
        
        const eventData = {
          type: 'APPOINTMENT_SUBMISSION',
          payload: {
              title: document.getElementById('eventTitle').value.trim(),
              start_time: startTimeIso, end_time: endTimeIso, duration: durationInMinutes,
              description: document.getElementById('eventDesc').value.trim() || null,
              location: document.getElementById('eventLocation').value.trim() || null,
          },
          context: { chatId: urlParams.get('chatId'), threadId: urlParams.get('threadId'), language: lang }
        };
        
        fetch(N8N_WEBHOOK_URL, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(eventData)
        }).then(() => {
            btn.disabled = true; 
            btn.classList.add('btn-add'); // Make it green
            btn.textContent = t.btnSuccess;
            tg.HapticFeedback.notificationOccurred('success');
            setTimeout(() => { tg.close(); }, 1200);
        }).catch(err => {
            alert("Errore di connessione");
            btn.textContent = t.btnSubmit;
        });
      });
    } catch (error) { console.error("Errore init:", error); }
  </script>
</body>
</html>
