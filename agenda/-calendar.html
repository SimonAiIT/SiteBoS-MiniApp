<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Calendario Manager Desk</title>
  
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  
  <!-- Custom Styles -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- LOADER -->
  <div id="loader">
    <div class="spinner"></div>
    <p style="margin-top:10px; color: var(--text-muted); font-size: 12px;">Caricamento Agenda...</p>
  </div>

  <div class="container">
    <!-- CALENDAR WRAPPER -->
    <div class="card" style="padding: 10px;">
      <div id="calendar"></div>
    </div>
  </div>

  <!-- MODAL: EVENT DETAILS -->
  <div class="modal-overlay hidden" id="modalOverlay">
    <div class="modal-content fade-in">
      <h3>Dettagli Evento</h3>
      <div id="modalText" style="white-space: pre-wrap; margin-bottom: 20px; font-size: 14px; color: var(--text-muted); line-height: 1.6;"></div>
      <button class="btn btn-primary btn-block" id="modalCloseBtn" onclick="closeModal()">Chiudi</button>
    </div>
  </div>

  <script>
    // --- TRANSLATIONS ---
    const translations = {
      it: {
        title: 'Calendario Manager Desk', missingParam: 'Parametro group_id mancante', error: 'Errore',
        close: 'Chiudi', priority: 'Priorit√†', dueDate: 'Scadenza', status: 'Status', tags: 'Tags',
        duration: 'Durata', end: 'Fine', location: 'Non specificato', locale: 'it'
      },
      en: {
        title: 'Manager Desk Calendar', missingParam: 'Missing group_id parameter', error: 'Error',
        close: 'Close', priority: 'Priority', dueDate: 'Due Date', status: 'Status', tags: 'Tags',
        duration: 'Duration', end: 'End', location: 'Not specified', locale: 'en'
      },
      fr: {
        title: 'Calendrier Manager Desk', missingParam: 'Param√®tre group_id manquant', error: 'Erreur',
        close: 'Fermer', priority: 'Priorit√©', dueDate: 'Date limite', status: 'Statut', tags: 'Tags',
        duration: 'Dur√©e', end: 'Fin', location: 'Non sp√©cifi√©', locale: 'fr'
      },
      de: {
        title: 'Manager Desk Kalender', missingParam: 'Fehlender group_id Parameter', error: 'Fehler',
        close: 'Schlie√üen', priority: 'Priorit√§t', dueDate: 'F√§lligkeitsdatum', status: 'Status', tags: 'Tags',
        duration: 'Dauer', end: 'Ende', location: 'Nicht angegeben', locale: 'de'
      },
      es: {
        title: 'Calendario Manager Desk', missingParam: 'Falta el par√°metro group_id', error: 'Error',
        close: 'Cerrar', priority: 'Prioridad', dueDate: 'Fecha l√≠mite', status: 'Estado', tags: 'Etiquetas',
        duration: 'Duraci√≥n', end: 'Fin', location: 'No especificado', locale: 'es'
      },
      pt: {
        title: 'Calend√°rio Manager Desk', missingParam: 'Par√¢metro group_id ausente', error: 'Erro',
        close: 'Fechar', priority: 'Prioridade', dueDate: 'Data limite', status: 'Status', tags: 'Tags',
        duration: 'Dura√ß√£o', end: 'Fim', location: 'N√£o especificado', locale: 'pt'
      }
    };

    // --- INIT ---
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // Gestione colori tema Telegram (Opzionale, se vuoi forzare l'header)
    if (tg.headerColor) tg.headerColor = '#2a3d5f'; // Matches var(--bg-end)
    if (tg.backgroundColor) tg.backgroundColor = '#2a3d5f';

    const params = new URLSearchParams(window.location.search);
    const groupId = params.get('group_id');
    const langParam = params.get('lang') || 'en';
    const t = translations[translations[langParam] ? langParam : 'en'];

    document.title = t.title;
    document.getElementById('modalCloseBtn').textContent = t.close;

    const loader = document.getElementById('loader');

    if (!groupId) {
      loader.innerHTML = `<h3 style="color: var(--error)">${t.missingParam}</h3>`;
      throw new Error(t.missingParam);
    }

    const apiUrl = `https://trinai.api.workflow.dcmake.it/webhook/manager-desk/appointments?group_id=${groupId}`;

    // --- MODAL FUNCTIONS ---
    function showEventDetails(details) {
      // Usa il modale HTML custom invece di tg.showAlert per coerenza stilistica
      document.getElementById('modalText').textContent = details;
      document.getElementById('modalOverlay').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.add('hidden');
    }

    // --- FETCH & RENDER ---
    fetch(apiUrl)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${t.error}: ${res.status}`);
        return res.json();
      })
      .then(responseData => {
        const eventsArray = responseData.events; 
        
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: window.innerWidth < 768 ? 'timeGridDay' : 'dayGridMonth',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          locale: t.locale,
          firstDay: 1,
          slotMinTime: '07:00:00',
          slotMaxTime: '22:00:00',
          allDaySlot: true,
          events: eventsArray,
          height: 'auto',
          dayMaxEventRows: true,
          selectable: false,
          editable: false,
          
          // Styling events dynamically based on type
          eventDidMount: function(info) {
             if (info.event.extendedProps.type === 'note') {
                 info.el.style.backgroundColor = 'var(--warning)';
                 info.el.style.borderColor = 'var(--warning)';
                 info.el.style.color = '#fff';
             } else {
                 info.el.style.backgroundColor = 'var(--primary)';
                 info.el.style.borderColor = 'var(--primary)';
             }
          },

          eventClick: function(info) {
            const event = info.event;
            const props = event.extendedProps;
            let details;

            if (props.type === 'note') {
              const dueDate = new Date(event.start);
              const priorityEmoji = { 'HIGH': 'üî¥', 'MEDIUM': 'üü°', 'LOW': 'üîµ' };

              details = `üìå ${event.title.replace('üìå ', '')}\n
${priorityEmoji[props.priority] || '‚ö™'} ${t.priority}: ${props.priority}
üìÖ ${t.dueDate}: ${dueDate.toLocaleDateString(t.locale, { weekday: 'long', day: 'numeric', month: 'long' })}
üìä ${t.status}: ${props.status}
${props.tags && props.tags.length > 0 ? 'üè∑Ô∏è ' + t.tags + ': ' + props.tags.join(', ') : ''}`;
            } else {
              const start = new Date(event.start);
              const end = event.end ? new Date(event.end) : null;
              
              details = `üìÖ ${event.title}\n
üïê ${start.toLocaleString(t.locale, { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' })}
${end ? 'üèÅ ' + t.end + ': ' + end.toLocaleTimeString(t.locale, {hour: '2-digit', minute: '2-digit'}) : ''}
‚è±Ô∏è ${t.duration}: ${props.duration_minutes || 'N/A'} min
üìç ${props.location || t.location}
${props.description ? '\nüìù ' + props.description : ''}`;
            }

            showEventDetails(details);
          },
          
          dateClick: function(info) {
            calendar.changeView('timeGridDay', info.dateStr);
          }
        });
        
        calendar.render();
        // Nascondi il loader solo quando il calendario √® renderizzato
        loader.classList.add('hidden');
      })
      .catch(err => {
        loader.innerHTML = `<div style="text-align:center; padding:20px;"><h3 style="color: var(--error)">${t.error}</h3><p>${err.message}</p></div>`;
      });
  </script>
</body>
</html>
