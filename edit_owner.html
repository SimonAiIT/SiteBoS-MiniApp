<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Gestione Dati Azienda</title>
  
  <!-- LIBS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- UNIFIED STYLES -->
  <link rel="stylesheet" href="styles.css">

  <style>
    /* Specific overrides for this page mainly for the generated list items */
    .operator-item {
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid var(--glass-border);
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }
    .op-info { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
    .op-name { font-weight: 600; color: #fff; }
    .op-id { font-size: 11px; color: var(--text-secondary); font-family: monospace; }
    
    .invitation-link { display: flex; gap: 8px; margin-top: 5px; }
    .invitation-link input { 
      font-size: 11px; padding: 4px 8px; height: 30px; 
      background: rgba(0,0,0,0.3); border: none; 
    }
    .invitation-link button {
      font-size: 11px; padding: 4px 8px; height: 30px;
      background: var(--primary); border: none; border-radius: 4px; color: #fff; cursor: pointer;
    }
    
    .time-range-selector { display: flex; align-items: center; gap: 10px; }
    .time-range-selector select { flex: 1; }
    
    .slot-counter { 
      font-size: 12px; font-weight: bold; 
      background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 12px; 
    }
  </style>
</head>
<body>

  <!-- LOADER -->
  <div id="loader" class="loading-overlay">
    <div class="spinner"></div>
    <div style="margin-top: 10px; font-size: 12px; color: var(--text-muted);">Caricamento dati...</div>
  </div>

  <!-- APP CONTENT -->
  <div id="app-content" class="container hidden">
    <h1 data-i18n="title">Gestione Dati Azienda</h1>
    <p class="subtitle" data-i18n="subtitle">Modifica le informazioni per aggiornare il sistema.</p>

    <form id="editForm">
      
      <!-- SEZIONE 1: DATI ANAGRAFICI -->
      <div class="form-section">
        <div class="form-section-title" data-i18n="section_core">Dati Anagrafici</div>
        <div class="row">
          <div class="col">
            <div class="input-group">
              <label data-i18n="lbl_name">Nome</label>
              <input type="text" id="name" placeholder="Nome">
            </div>
          </div>
          <div class="col">
            <div class="input-group">
              <label data-i18n="lbl_surname">Cognome</label>
              <input type="text" id="surname" placeholder="Cognome">
            </div>
          </div>
        </div>
        <div class="input-group">
          <label data-i18n="lbl_email">Email</label>
          <input type="email" id="email" required placeholder="name@example.com">
        </div>
        <div class="input-group">
          <label data-i18n="lbl_phone">Telefono</label>
          <input type="tel" id="phone" placeholder="+39...">
        </div>
      </div>

      <!-- SEZIONE 2: DATI AZIENDALI -->
      <div class="form-section">
        <div class="form-section-title" data-i18n="section_company">Dati Aziendali</div>
        <div class="input-group">
          <label data-i18n="lbl_company_name">Ragione Sociale</label>
          <input type="text" id="ragione_sociale" required>
        </div>
        <div class="input-group">
          <label data-i18n="lbl_vat">P.IVA (Non modificabile)</label>
          <input type="text" id="vat_number" readonly disabled>
        </div>
        <div class="input-group">
          <label data-i18n="lbl_address">Indirizzo</label>
          <input type="text" id="indirizzo" placeholder="Via, Civico, Città">
        </div>
        <div class="input-group">
          <label data-i18n="lbl_site">Sito Web</label>
          <input type="url" id="site" placeholder="https://...">
        </div>
        <div class="row">
          <div class="col">
             <div class="input-group"><label>LinkedIn</label><input type="url" id="linkedin_page" placeholder="https://linkedin..."></div>
          </div>
          <div class="col">
             <div class="input-group"><label>Facebook</label><input type="url" id="facebook_page" placeholder="https://facebook..."></div>
          </div>
        </div>
      </div>

      <!-- SEZIONE 3: CONFIGURAZIONE -->
      <div class="form-section">
        <div class="form-section-title" data-i18n="section_config">Configurazione Operativa</div>
        
        <div class="input-group">
            <label data-i18n="lbl_owner_avail">Orari NON reperibilità (Owner)</label>
            <div class="time-range-selector">
              <select id="owner_unav_from"></select> 
              <span>-</span> 
              <select id="owner_unav_to"></select>
            </div>
            <div class="hint">Fascia oraria in cui l'AI non disturberà l'Owner.</div>
        </div>
        
        <div class="input-group">
            <label data-i18n="lbl_op_avail">Orari NON reperibilità (Operatori)</label>
            <div class="time-range-selector">
              <select id="operator_unav_from"></select> 
              <span>-</span> 
              <select id="operator_unav_to"></select>
            </div>
        </div>
        
        <div class="input-group">
          <label>Gemini API Key</label>
          <input type="text" id="gemini_key" placeholder="AIza...">
        </div>
      </div>
      
      <!-- SEZIONE 4: OPERATORI -->
      <div class="operators-card card">
        <div class="card-header">
          <h3><i class="fas fa-users"></i> <span data-i18n="op_title">Gestione Operatori</span></h3>
          <span class="slot-counter" id="slot-counter">0 / 3</span>
        </div>
        
        <div id="operators-list" class="mt-2">
          <!-- JS Generates Items Here -->
        </div>

        <div class="btn-container">
          <button type="button" class="btn btn-secondary btn-block" id="add-operator-btn">
            <i class="fas fa-plus-circle"></i> <span data-i18n="op_btn_invite">Invita Nuovo Operatore</span>
          </button>
        </div>

        <div class="upgrade-prompt hidden note note-warning mt-2" id="upgrade-prompt">
          <p data-i18n="op_limit_reached">Limite operatori raggiunto.</p>
          <a href="https://t.me/TrinAi_OperativeChief" data-i18n="op_contact_support" style="color: inherit; text-decoration: underline;">Contatta TrinAi per più slot!</a>
        </div>
      </div>

      <!-- SAVE BUTTON -->
      <div class="btn-container">
        <button type="submit" id="saveBtn" class="btn btn-primary btn-block" disabled>
          <i class="fas fa-save"></i> <span data-i18n="btn_save">Salva Modifiche</span>
        </button>
      </div>
    </form>
  </div>
  
  <!-- MODAL: ADD OPERATOR -->
  <div id="operator-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 id="modal-title" data-i18n="modal_title">Invita Operatore</h3>
      <p class="subtitle" data-i18n="modal_subtitle" style="margin-bottom: 15px;">Inserisci il nome. Verrà generato un link di invito.</p>
      
      <div class="input-group">
        <label data-i18n="modal_lbl_name">Nome Operatore</label>
        <input type="text" id="op-name" placeholder="Es: Mario Rossi">
      </div>
      
      <div class="btn-container">
        <button type="button" class="btn btn-secondary" onclick="closeModal()"><span data-i18n="btn_cancel">Annulla</span></button>
        <button type="button" class="btn btn-primary" onclick="generateInvitation()"><span data-i18n="btn_generate">Genera Invito</span></button>
      </div>
    </div>
  </div>

  <script>
    const WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/83acc670-15ae-4da0-ae0e-3587c85bd5f4";
    const BOT_USERNAME = "TrinAi_Site_bot";
    const tg = window.Telegram.WebApp; 
    tg.ready(); 
    tg.expand();

    const urlParams = new URLSearchParams(window.location.search);
    const vatNumber = urlParams.get('vat');
    
    const dom = {
        loader: document.getElementById('loader'), 
        app: document.getElementById('app-content'),
        form: document.getElementById('editForm'), 
        saveBtn: document.getElementById('saveBtn'),
        name: document.getElementById('name'), 
        surname: document.getElementById('surname'), 
        email: document.getElementById('email'), 
        phone: document.getElementById('phone'),
        ragioneSociale: document.getElementById('ragione_sociale'), 
        vatNumber: document.getElementById('vat_number'),
        indirizzo: document.getElementById('indirizzo'), 
        site: document.getElementById('site'),
        linkedin_page: document.getElementById('linkedin_page'), 
        facebook_page: document.getElementById('facebook_page'),
        ownerUnavFrom: document.getElementById('owner_unav_from'), 
        ownerUnavTo: document.getElementById('owner_unav_to'),
        operatorUnavFrom: document.getElementById('operator_unav_from'), 
        operatorUnavTo: document.getElementById('operator_unav_to'),
        gemini_key: document.getElementById('gemini_key'),
        operatorsList: document.getElementById('operators-list'), 
        slotCounter: document.getElementById('slot-counter'),
        addOperatorBtn: document.getElementById('add-operator-btn'), 
        upgradePrompt: document.getElementById('upgrade-prompt'),
        modal: document.getElementById('operator-modal'), 
        modalTitle: document.getElementById('modal-title'), 
        opName: document.getElementById('op-name')
    };

    const i18n = {
      it: {
        title: "Gestione Dati Azienda", subtitle: "Modifica le informazioni per aggiornare il sistema.",
        section_core: "Dati Anagrafici", section_company: "Dati Aziendali", section_config: "Configurazione Operativa",
        lbl_name: "Nome", lbl_surname: "Cognome", lbl_email: "Email", lbl_phone: "Telefono",
        lbl_company_name: "Ragione Sociale", lbl_vat: "P.IVA", lbl_address: "Indirizzo", lbl_site: "Sito Web",
        lbl_owner_avail: "Orari NON reperibilità (Owner)", lbl_op_avail: "Orari NON reperibilità (Operatori)",
        op_title: "Gestione Operatori", op_btn_invite: "Invita Nuovo Operatore", op_limit_reached: "Limite operatori raggiunto.", op_contact_support: "Contatta TrinAi per più slot!",
        op_status_pending: "In attesa", op_invite_text: "Invia questo link per l'attivazione:", op_btn_copy: "Copia", op_copied: "Copiato!",
        modal_title: "Invita Operatore", modal_subtitle: "Inserisci il nome. Verrà generato un link di invito.", modal_lbl_name: "Nome Operatore",
        btn_cancel: "Annulla", btn_generate: "Genera Invito", btn_save: "Salva Modifiche",
        alert_confirm_delete: "Sei sicuro di voler eliminare l'operatore", alert_revoke_invite: "Sei sicuro di voler revocare l'invito per",
        alert_name_required: "Il nome dell'operatore è obbligatorio.", alert_loading_error: "Errore caricamento dati.", alert_saving_error: "Errore salvataggio dati.",
        saving_progress: "Salvataggio...", saving_success: "✅ Salvato!"
      },
      en: {
        title: "Company Data Management", subtitle: "Edit the information to update the system.",
        section_core: "Personal Data", section_company: "Company Data", section_config: "Operational Config",
        lbl_name: "Name", lbl_surname: "Surname", lbl_email: "Email", lbl_phone: "Phone",
        lbl_company_name: "Company Name", lbl_vat: "VAT ID", lbl_address: "Address", lbl_site: "Website",
        lbl_owner_avail: "Unavailability Hours (Owner)", lbl_op_avail: "Unavailability Hours (Operators)",
        op_title: "Operator Management", op_btn_invite: "Invite New Operator", op_limit_reached: "Operator limit reached.", op_contact_support: "Contact TrinAi for more slots!",
        op_status_pending: "Pending", op_invite_text: "Send this link for activation:", op_btn_copy: "Copy", op_copied: "Copied!",
        modal_title: "Invite Operator", modal_subtitle: "Enter the name. An invitation link will be generated.", modal_lbl_name: "Operator Name",
        btn_cancel: "Cancel", btn_generate: "Generate Invite", btn_save: "Save Changes",
        alert_confirm_delete: "Are you sure you want to delete the operator", alert_revoke_invite: "Are you sure you want to revoke the invitation for",
        alert_name_required: "Operator name is required.", alert_loading_error: "Error loading data.", alert_saving_error: "Error saving data.",
        saving_progress: "Saving...", saving_success: "✅ Saved!"
      },
      fr: {
        title: "Gestion des Données", subtitle: "Modifiez les informations pour mettre à jour le système.",
        section_core: "Données Personnelles", section_company: "Données de l'Entreprise", section_config: "Configuration Opérationnelle",
        lbl_name: "Prénom", lbl_surname: "Nom", lbl_email: "Email", lbl_phone: "Téléphone",
        lbl_company_name: "Raison Sociale", lbl_vat: "TVA", lbl_address: "Adresse", lbl_site: "Site Web",
        lbl_owner_avail: "Heures d'indisponibilité (Propriétaire)", lbl_op_avail: "Heures d'indisponibilité (Opérateurs)",
        op_title: "Gestion des Opérateurs", op_btn_invite: "Inviter un Opérateur", op_limit_reached: "Limite d'opérateurs atteinte.", op_contact_support: "Contactez TrinAi pour plus de slots !",
        op_status_pending: "En attente", op_invite_text: "Envoyez ce lien pour l'activation :", op_btn_copy: "Copier", op_copied: "Copié !",
        modal_title: "Inviter un Opérateur", modal_subtitle: "Entrez le nom. Un lien d'invitation sera généré.", modal_lbl_name: "Nom de l'Opérateur",
        btn_cancel: "Annuler", btn_generate: "Générer l'invitation", btn_save: "Enregistrer",
        alert_confirm_delete: "Êtes-vous sûr de vouloir supprimer l'opérateur", alert_revoke_invite: "Êtes-vous sûr de vouloir révoquer l'invitation pour",
        alert_name_required: "Le nom de l'opérateur est requis.", alert_loading_error: "Erreur de chargement.", alert_saving_error: "Erreur d'enregistrement.",
        saving_progress: "Enregistrement...", saving_success: "✅ Enregistré !"
      },
      de: {
        title: "Firmendatenverwaltung", subtitle: "Informationen bearbeiten, um das System zu aktualisieren.",
        section_core: "Persönliche Daten", section_company: "Firmendaten", section_config: "Betriebskonfiguration",
        lbl_name: "Vorname", lbl_surname: "Nachname", lbl_email: "E-Mail", lbl_phone: "Telefon",
        lbl_company_name: "Firmenname", lbl_vat: "USt-IdNr.", lbl_address: "Adresse", lbl_site: "Webseite",
        lbl_owner_avail: "Nichtverfügbarkeitszeiten (Inhaber)", lbl_op_avail: "Nichtverfügbarkeitszeiten (Bediener)",
        op_title: "Bedienerverwaltung", op_btn_invite: "Bediener Einladen", op_limit_reached: "Bedienerlimit erreicht.", op_contact_support: "Kontaktieren Sie TrinAi für mehr Plätze!",
        op_status_pending: "Ausstehend", op_invite_text: "Senden Sie diesen Link zur Aktivierung:", op_btn_copy: "Kopieren", op_copied: "Kopiert!",
        modal_title: "Bediener Einladen", modal_subtitle: "Namen eingeben. Ein Einladungslink wird erstellt.", modal_lbl_name: "Bedienername",
        btn_cancel: "Abbrechen", btn_generate: "Einladung Erstellen", btn_save: "Speichern",
        alert_confirm_delete: "Möchten Sie den Bediener wirklich löschen", alert_revoke_invite: "Möchten Sie die Einladung für",
        alert_name_required: "Bedienername erforderlich.", alert_loading_error: "Fehler beim Laden.", alert_saving_error: "Fehler beim Speichern.",
        saving_progress: "Speichern...", saving_success: "✅ Gespeichert!"
      },
      es: {
        title: "Gestión de Datos", subtitle: "Edita la información para actualizar el sistema.",
        section_core: "Datos Personales", section_company: "Datos de la Empresa", section_config: "Configuración Operativa",
        lbl_name: "Nombre", lbl_surname: "Apellido", lbl_email: "Email", lbl_phone: "Teléfono",
        lbl_company_name: "Razón Social", lbl_vat: "IVA", lbl_address: "Dirección", lbl_site: "Sitio Web",
        lbl_owner_avail: "Horas de no disponibilidad (Dueño)", lbl_op_avail: "Horas de no disponibilidad (Operadores)",
        op_title: "Gestión de Operadores", op_btn_invite: "Invitar Operador", op_limit_reached: "Límite de operadores alcanzado.", op_contact_support: "Contacta a TrinAi para más espacios!",
        op_status_pending: "Pendiente", op_invite_text: "Envía este enlace para activar:", op_btn_copy: "Copiar", op_copied: "¡Copiado!",
        modal_title: "Invitar Operador", modal_subtitle: "Introduce el nombre. Se generará un enlace de invitación.", modal_lbl_name: "Nombre del Operador",
        btn_cancel: "Cancelar", btn_generate: "Generar Invitación", btn_save: "Guardar",
        alert_confirm_delete: "¿Seguro que quieres eliminar al operador", alert_revoke_invite: "¿Seguro que quieres revocar la invitación para",
        alert_name_required: "El nombre del operador es obligatorio.", alert_loading_error: "Error al cargar.", alert_saving_error: "Error al guardar.",
        saving_progress: "Guardando...", saving_success: "✅ ¡Guardado!"
      },
      pt: {
        title: "Gestão de Dados", subtitle: "Edite as informações para atualizar o sistema.",
        section_core: "Dados Pessoais", section_company: "Dados da Empresa", section_config: "Configuração Operacional",
        lbl_name: "Nome", lbl_surname: "Sobrenome", lbl_email: "Email", lbl_phone: "Telefone",
        lbl_company_name: "Razão Social", lbl_vat: "NIF", lbl_address: "Endereço", lbl_site: "Website",
        lbl_owner_avail: "Horas de indisponibilidade (Proprietário)", lbl_op_avail: "Horas de indisponibilidade (Operadores)",
        op_title: "Gestão de Operadores", op_btn_invite: "Convidar Operador", op_limit_reached: "Limite de operadores atingido.", op_contact_support: "Contate a TrinAi para mais vagas!",
        op_status_pending: "Pendente", op_invite_text: "Envie este link para ativar:", op_btn_copy: "Copiar", op_copied: "Copiado!",
        modal_title: "Convidar Operador", modal_subtitle: "Insira o nome. Um link de convite será gerado.", modal_lbl_name: "Nome do Operador",
        btn_cancel: "Cancelar", btn_generate: "Gerar Convite", btn_save: "Salvar",
        alert_confirm_delete: "Tem certeza de que deseja excluir o operador", alert_revoke_invite: "Tem certeza de que deseja revogar o convite para",
        alert_name_required: "O nome do operador é obrigatório.", alert_loading_error: "Erro ao carregar.", alert_saving_error: "Erro ao salvar.",
        saving_progress: "Salvando...", saving_success: "✅ Salvo!"
      }
    };
    
    let initialDataString = '';
    let ownerAsOperator = null;
    let operators = []; 
    let currentLang = 'it';
    const dict = () => i18n[currentLang] || i18n.it;
    
    function getCurrentStateAsObject() {
        const finalOperatorsArray = [];
        if (ownerAsOperator) finalOperatorsArray.push(ownerAsOperator);
        finalOperatorsArray.push(...operators);

        return {
            name: dom.name.value, surname: dom.surname.value, email: dom.email.value, phone: dom.phone.value,
            ragione_sociale: dom.ragioneSociale.value, indirizzo: dom.indirizzo.value,
            site: dom.site.value, linkedin_page: dom.linkedin_page.value, facebook_page: dom.facebook_page.value,
            gemini_key: dom.gemini_key.value,
            owner_unavailable_time: `${dom.ownerUnavFrom.value}-${dom.ownerUnavTo.value}`,
            operator_unavailable_time: `${dom.operatorUnavFrom.value}-${dom.operatorUnavTo.value}`,
            operators: finalOperatorsArray
        };
    }

    function checkIfDirty() {
        const currentStateString = JSON.stringify(getCurrentStateAsObject());
        dom.saveBtn.disabled = (currentStateString === initialDataString);
    }
    
    function changeLanguage(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-i18n]').forEach(el => { 
            const k = el.getAttribute('data-i18n'); 
            if(dict()[k]) el.innerHTML = dict()[k]; 
        });
    }

    function populateTimeSelectors() {
        const selectors = [dom.ownerUnavFrom, dom.ownerUnavTo, dom.operatorUnavFrom, dom.operatorUnavTo];
        selectors.forEach(selector => {
            if (selector.options.length > 0) return;
            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i.toString().padStart(2, '0')}:00`;
                selector.appendChild(option);
            }
        });
    }

    async function loadData() {
        if (!vatNumber) { tg.showAlert('ID not found!'); return; }
        try {
            const res = await fetch(WEBHOOK_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'get_owner_data', vat_number: vatNumber }) });
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const data = await res.json();
            const allOperators = data.owner_data.operators || [];
            ownerAsOperator = allOperators.find(op => op.Role === 'Owner');
            operators = allOperators.filter(op => op.Role !== 'Owner');
            populateForm(data.owner_data);
            changeLanguage(urlParams.get('lang') || 'it');
            dom.loader.classList.add('hidden');
            dom.app.classList.remove('hidden');
        } catch (err) {
            tg.showAlert(dict().alert_loading_error); tg.close();
        }
    }

    function populateForm(data) {
        dom.name.value = data.name || ''; dom.surname.value = data.surname || ''; dom.email.value = data.email || '';
        dom.phone.value = data.phone || ''; dom.ragioneSociale.value = data.ragione_sociale || ''; dom.vatNumber.value = data.vat_number || '';
        dom.indirizzo.value = data.indirizzo || ''; dom.site.value = data.site || ''; dom.linkedin_page.value = data.linkedin_page || '';
        dom.facebook_page.value = data.facebook_page || ''; dom.gemini_key.value = data.gemini_key || '';
        const [ownerFrom, ownerTo] = (data.owner_unavailable_time || '21-7').split('-');
        dom.ownerUnavFrom.value = ownerFrom; dom.ownerUnavTo.value = ownerTo;
        const [opFrom, opTo] = (data.operator_unavailable_time || '19-9').split('-');
        dom.operatorUnavFrom.value = opFrom; dom.operatorUnavTo.value = opTo;
        renderOperators();
        initialDataString = JSON.stringify(getCurrentStateAsObject());
        checkIfDirty();
    }
    
    function renderOperators() {
        dom.operatorsList.innerHTML = '';
        operators.forEach((op, index) => {
            const isPending = !op.OperatorChatID;
            let operatorHTML = '';
            if (isPending) {
                const invitationLink = `https://t.me/${BOT_USERNAME}?start=${op.invitation_code}`;
                operatorHTML = `
                <div class="operator-item pending">
                  <div class="op-info">
                    <span class="op-name">${op.OperatorName} <i class="fas fa-clock" style="font-size:10px; opacity:0.7"></i> <small>${dict().op_status_pending}</small></span>
                    <p style="font-size:11px; color:var(--text-secondary); margin:0;">${dict().op_invite_text}</p>
                    <div class="invitation-link">
                      <input type="text" value="${invitationLink}" readonly>
                      <button onclick="copyToClipboard('${invitationLink}', this)">${dict().op_btn_copy}</button>
                    </div>
                  </div>
                  <div class="op-actions">
                    <button type="button" class="btn-icon btn-delete" onclick="deleteOperator(${index})"><i class="fas fa-trash-alt"></i></button>
                  </div>
                </div>`;
            } else {
                operatorHTML = `
                <div class="operator-item">
                  <div class="op-info">
                    <span class="op-name">${op.OperatorName}</span>
                    <span class="op-id">ID: ${op.OperatorChatID}</span>
                  </div>
                  <div class="op-actions">
                    <button type="button" class="btn-icon btn-delete" onclick="deleteOperator(${index})"><i class="fas fa-trash-alt"></i></button>
                  </div>
                </div>`;
            }
            dom.operatorsList.innerHTML += operatorHTML;
        });
        updateOperatorControls();
    }
    
    function updateOperatorControls() {
        const count = operators.length;
        dom.slotCounter.textContent = `${count} / 3`;
        const canAdd = count < 3;
        dom.addOperatorBtn.classList.toggle('hidden', !canAdd);
        dom.upgradePrompt.classList.toggle('hidden', canAdd);
    }
    
    window.copyToClipboard = (text, button) => {
        navigator.clipboard.writeText(text).then(() => {
            button.textContent = dict().op_copied;
            tg.HapticFeedback.notificationOccurred('success');
            setTimeout(() => { button.textContent = dict().op_btn_copy; }, 2000);
        });
    };

    window.openModal = () => { dom.opName.value = ''; dom.modal.classList.remove('hidden'); };
    window.closeModal = () => dom.modal.classList.add('hidden');

    window.deleteOperator = (index) => {
        const op = operators[index];
        const isPending = !op.OperatorChatID;
        let confirmText = isPending ? `${dict().alert_revoke_invite} ${op.OperatorName}?` : `${dict().alert_confirm_delete} ${op.OperatorName}?`;
        tg.showConfirm(confirmText, (ok) => {
            if (ok) { operators.splice(index, 1); renderOperators(); checkIfDirty(); tg.HapticFeedback.notificationOccurred('warning'); }
        });
    };
    
    window.generateInvitation = () => {
        const name = dom.opName.value.trim();
        if (!name) { tg.showAlert(dict().alert_name_required); return; }
        const uniquePart = Math.random().toString(36).substring(2, 8).toUpperCase();
        const invitationCode = `INV-${vatNumber}-${ownerAsOperator.OperatorChatID}-${uniquePart}`;
        const newOperator = { OperatorName: name, invitation_code: invitationCode, OperatorChatID: null, GeminiKey: null, OperatorLenguage: ownerAsOperator.OperatorLenguage, FreeHandOperator: true, Role: 'Operator' };
        operators.push(newOperator);
        renderOperators();
        closeModal();
        checkIfDirty();
        tg.HapticFeedback.notificationOccurred('success');
    };
    
    document.querySelectorAll('#editForm input, #editForm select').forEach(el => el.addEventListener('input', checkIfDirty));
    dom.addOperatorBtn.addEventListener('click', () => openModal());

    dom.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        dom.saveBtn.disabled = true; dom.saveBtn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> ${dict().saving_progress}`;
        
        const updatedData = getCurrentStateAsObject();

        try {
            await fetch(WEBHOOK_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'save_owner_data', vat_number: vatNumber, data_update: updatedData }) });
            tg.HapticFeedback.notificationOccurred('success');
            dom.saveBtn.style.background = 'var(--success)';
            dom.saveBtn.innerHTML = dict().saving_success;
            initialDataString = JSON.stringify(updatedData);
            checkIfDirty();
            setTimeout(() => tg.close(), 1500);
        } catch (err) {
            tg.showAlert(dict().alert_saving_error);
            dom.saveBtn.disabled = false; dom.saveBtn.innerHTML = `<i class="fas fa-save"></i> ${dict().btn_save}`;
        }
    });

    populateTimeSelectors();
    loadData();
  </script>
</body>
</html>
