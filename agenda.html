<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Nuovo Evento Agenda</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-start: #4a5b8f; --bg-end: #2a3d5f; --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7); --border-color: rgba(255, 255, 255, 0.2);
      --input-bg: rgba(255, 255, 255, 0.08); --accent-color: #5B6FED;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text-primary); padding: 20px; min-height: 100vh;
    }
    .container { max-width: 500px; margin: 0 auto; }
    h1 { font-size: 26px; margin-bottom: 8px; font-weight: 600; }
    .subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 32px; font-weight: 300; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 10px; font-size: 14px; font-weight: 500; }
    input, textarea {
      width: 100%; padding: 14px 16px; border: 1px solid var(--border-color);
      border-radius: 12px; background: var(--input-bg); backdrop-filter: blur(10px);
      color: var(--text-primary); font-size: 15px; font-family: inherit;
    }
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
      cursor: pointer; opacity: 0.7; filter: invert(1); transform: scale(1.2); transition: opacity 0.2s ease;
    }
    input[type="date"]::-webkit-calendar-picker-indicator:hover,
    input[type="time"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }
    
    .radio-group { display: flex; gap: 10px; margin-top: 10px; }
    .radio-group input[type="radio"] { display: none; }
    .radio-group label {
      flex: 1; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 15px; padding: 10px; border-radius: 10px;
      transition: all 0.3s ease; background-color: var(--input-bg);
      border: 1px solid var(--border-color); color: var(--text-secondary);
    }
    .radio-group input[type="radio"]:checked + label {
      border-color: var(--accent-color); color: var(--text-primary);
      background-color: rgba(91, 111, 237, 0.15);
    }

    input:focus, textarea:focus { outline: none; border-color: rgba(255, 255, 255, 0.5); box-shadow: 0 0 15px rgba(91, 111, 237, 0.3); }
    textarea { resize: vertical; min-height: 80px; }
    .required::after { content: " *"; color: #ff6b6b; }
    .button-container { text-align: center; margin-top: 32px; }
    #submitBtn { width: 100%; padding: 14px; background: var(--accent-color); color: var(--text-primary); border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; }
    #submitBtn:disabled { background: #555; cursor: not-allowed; opacity: 0.6; }
    .cancel-hint { text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-secondary); opacity: 0.8; }
    .row { display: flex; gap: 16px; }
    .row .form-group { flex: 1; }
    .hidden { display: none !important; }
    #customEndContainer { transition: all 0.4s ease-in-out; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title"></h1>
    <p class="subtitle" id="subtitle"></p>
    
    <form id="eventForm">
      <div class="form-group">
        <label for="eventTitle" class="required"><span id="lblTitle"></span></label>
        <input type="text" id="eventTitle" required>
      </div>
      
      <div class="row">
        <div class="form-group">
          <label for="eventDate" class="required"><span id="lblDate"></span></label>
          <input type="date" id="eventDate" required>
        </div>
        <div class="form-group">
          <label for="eventTime" class="required"><span id="lblTime"></span></label>
          <input type="time" id="eventTime" required>
        </div>
      </div>

      <div class="form-group">
        <label><span id="lblDuration"></span></label>
        <div class="radio-group">
          <input type="radio" name="duration" value="30" id="dur-30" checked>
          <label for="dur-30"><span id="opt30"></span></label>
          <input type="radio" name="duration" value="60" id="dur-60">
          <label for="dur-60"><span id="opt60"></span></label>
          <input type="radio" name="duration" value="custom" id="dur-custom">
          <label for="dur-custom"><span id="optCustom"></span></label>
        </div>
      </div>
      
      <div id="customEndContainer" class="hidden">
        <div class="row">
            <div class="form-group">
              <label for="eventEndDate" class="required"><span id="lblEndDate"></span></label>
              <input type="date" id="eventEndDate">
            </div>
            <div class="form-group">
              <label for="eventEndTime" class="required"><span id="lblEndTime"></span></label>
              <input type="time" id="eventEndTime">
            </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="eventDesc"><span id="lblDesc"></span></label>
        <textarea id="eventDesc"></textarea>
      </div>
      
      <div class="form-group">
        <label for="eventLocation"><span id="lblLocation"></span></label>
        <input type="text" id="eventLocation">
      </div>
      
      <div class="button-container">
        <button type="submit" id="submitBtn"></button>
      </div>
      <p class="cancel-hint" id="cancelHint"></p>
    </form>
  </div>

  <script>
    const translations = {
      it: {
        title: "üóìÔ∏è Nuovo Evento", subtitle: "Aggiungi un impegno alla tua agenda",
        lblTitle: "‚úèÔ∏è Titolo Evento", lblDate: "üóìÔ∏è Data Inizio", lblTime: "‚è∞ Ora Inizio",
        lblDuration: "‚è±Ô∏è Durata", opt30: "30 min", opt60: "60 min", optCustom: "Altro",
        lblEndDate: "üóìÔ∏è Data Fine", lblEndTime: "‚è∞ Ora Fine",
        lblDesc: "üìÑ Descrizione / Note (Opzionale)", lblLocation: "üìç Luogo (Opzionale)",
        btnSubmit: "Aggiungi Evento", btnSuccess: "Aggiunto! Puoi chiudere.", cancelHint: "Per annullare, basta chiudere questa finestra."
      },
      en: {
        title: "üóìÔ∏è New Event", subtitle: "Add a commitment to your agenda",
        lblTitle: "‚úèÔ∏è Event Title", lblDate: "üóìÔ∏è Start Date", lblTime: "‚è∞ Start Time",
        lblDuration: "‚è±Ô∏è Duration", opt30: "30 min", opt60: "60 min", optCustom: "Other",
        lblEndDate: "üóìÔ∏è End Date", lblEndTime: "‚è∞ End Time",
        lblDesc: "üìÑ Description / Notes (Optional)", lblLocation: "üìç Location (Optional)",
        btnSubmit: "Add Event", btnSuccess: "Added! You can close now.", cancelHint: "To cancel, just close this window."
      },
      // ... Aggiungere altre 4 lingue se necessario
    };
    
    const N8N_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/a0b6b2cb-4e19-4a92-9269-6b6d8a7afb80";
    
    try {
      const tg = window.Telegram.WebApp;
      tg.ready(); tg.expand();
      
      const urlParams = new URLSearchParams(window.location.search);
      const lang = urlParams.get('lang') || 'it';
      const t = translations[lang] || translations.it;
      
      const dom = {
          form: document.getElementById('eventForm'), submitBtn: document.getElementById('submitBtn'),
          eventDate: document.getElementById('eventDate'), eventEndDate: document.getElementById('eventEndDate'),
          durationRadios: document.querySelectorAll('input[name="duration"]'),
          customEndContainer: document.getElementById('customEndContainer'),
          eventEndTime: document.getElementById('eventEndTime')
      };

      function applyTranslations() {
        document.title = t.title.replace(/<[^>]*>?/gm, '');
        document.getElementById('title').innerHTML = t.title; document.getElementById('subtitle').textContent = t.subtitle;
        document.getElementById('lblTitle').textContent = t.lblTitle; document.getElementById('lblDate').textContent = t.lblDate;
        document.getElementById('lblTime').textContent = t.lblTime; document.getElementById('lblDuration').textContent = t.lblDuration;
        document.getElementById('opt30').textContent = t.opt30; document.getElementById('opt60').textContent = t.opt60;
        document.getElementById('optCustom').textContent = t.optCustom; document.getElementById('lblEndDate').textContent = t.lblEndDate;
        document.getElementById('lblEndTime').textContent = t.lblEndTime; document.getElementById('lblDesc').textContent = t.lblDesc;
        document.getElementById('lblLocation').textContent = t.lblLocation; dom.submitBtn.textContent = t.btnSubmit;
        document.getElementById('cancelHint').textContent = t.cancelHint;
      }
      applyTranslations();
      
      function setMinDates() {
        const today = new Date().toISOString().split('T')[0];
        dom.eventDate.setAttribute('min', today);
        dom.eventDate.value = today; // Imposta oggi come default
        dom.eventEndDate.setAttribute('min', today);
        dom.eventEndDate.value = today;
      }
      setMinDates();

      // Logica per aggiornare la data di fine in base a quella di inizio
      dom.eventDate.addEventListener('change', () => {
          dom.eventEndDate.setAttribute('min', dom.eventDate.value);
          if (dom.eventEndDate.value < dom.eventDate.value) {
              dom.eventEndDate.value = dom.eventDate.value;
          }
      });
      
      // Logica per mostrare/nascondere i campi custom
      dom.durationRadios.forEach(radio => {
          radio.addEventListener('change', () => {
              const isCustom = radio.value === 'custom';
              dom.customEndContainer.classList.toggle('hidden', !isCustom);
              dom.eventEndDate.toggleAttribute('required', isCustom);
              dom.eventEndTime.toggleAttribute('required', isCustom);
              validateForm();
          });
      });

      function validateForm() {
        const requiredInputs = dom.form.querySelectorAll('[required]');
        const isValid = Array.from(requiredInputs).every(input => input.value.trim() !== '');
        dom.submitBtn.disabled = !isValid;
      }
      dom.form.addEventListener('input', validateForm);
      validateForm();
      
      dom.form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const startTimeIso = new Date(`${dom.eventDate.value}T${document.getElementById('eventTime').value}`).toISOString();
        const durationChoice = document.querySelector('input[name="duration"]:checked').value;

        let endTimeIso = null;
        let durationInMinutes = null;

        if (durationChoice === 'custom') {
            endTimeIso = new Date(`${dom.eventEndDate.value}T${dom.eventEndTime.value}`).toISOString();
        } else {
            durationInMinutes = parseInt(durationChoice);
        }

        const eventData = {
          type: 'APPOINTMENT_SUBMISSION',
          payload: {
              title: document.getElementById('eventTitle').value.trim(),
              start_time: startTimeIso,
              end_time: endTimeIso,
              duration: durationInMinutes,
              description: document.getElementById('eventDesc').value.trim() || null,
              location: document.getElementById('eventLocation').value.trim() || null,
          },
          context: { chatId: urlParams.get('chatId'), threadId: urlParams.get('threadId'), language: lang }
        };

        fetch(N8N_WEBHOOK_URL, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(eventData)
        }).finally(() => {
            dom.submitBtn.disabled = true; dom.submitBtn.textContent = t.btnSuccess;
            setTimeout(() => { tg.close(); }, 1200);
        });
      });

    } catch (error) { console.error("Errore nell'inizializzazione dell'app:", error); }
  </script>
</body>
</html>
