<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Nuovo Evento Agenda</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-start: #4a5b8f; --bg-end: #2a3d5f; --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7); --border-color: rgba(255, 255, 255, 0.2);
      --input-bg: rgba(255, 255, 255, 0.08); --accent-color: #5B6FED; --error-color: #ff6b6b;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text-primary); padding: 20px; min-height: 100vh;
    }
    .container { max-width: 500px; margin: 0 auto; }
    h1 { font-size: 26px; margin-bottom: 8px; font-weight: 600; }
    .subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 32px; font-weight: 300; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 10px; font-size: 14px; font-weight: 500; }
    input, textarea {
      width: 100%; padding: 14px 16px; border: 1px solid var(--border-color);
      border-radius: 12px; background: var(--input-bg); backdrop-filter: blur(10px);
      color: var(--text-primary); font-size: 15px; font-family: inherit;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
      cursor: pointer; opacity: 0.7; filter: invert(1); transform: scale(1.2); transition: opacity 0.2s ease;
    }
    input[type="date"]::-webkit-calendar-picker-indicator:hover,
    input[type="time"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }
    
    .radio-group { display: flex; gap: 10px; margin-top: 10px; }
    .radio-group input[type="radio"] { display: none; }
    .radio-group label {
      flex: 1; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 15px; padding: 10px; border-radius: 10px;
      transition: all 0.3s ease; background-color: var(--input-bg);
      border: 1px solid var(--border-color); color: var(--text-secondary);
    }
    .radio-group input[type="radio"]:checked + label {
      border-color: var(--accent-color); color: var(--text-primary);
      background-color: rgba(91, 111, 237, 0.15);
    }

    input:focus, textarea:focus { outline: none; border-color: rgba(255, 255, 255, 0.5); box-shadow: 0 0 15px rgba(91, 111, 237, 0.3); }
    textarea { resize: vertical; min-height: 80px; }
    .required::after { content: " *"; color: #ff6b6b; }
    .button-container { text-align: center; margin-top: 32px; }
    #submitBtn { width: 100%; padding: 14px; background: var(--accent-color); color: var(--text-primary); border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; }
    #submitBtn:disabled { background: #555; cursor: not-allowed; opacity: 0.6; }
    .cancel-hint { text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-secondary); opacity: 0.8; }
    .row { display: flex; gap: 16px; }
    .row .form-group { flex: 1; }
    .hidden { display: none !important; }
    #customEndContainer { transition: all 0.4s ease-in-out; }
    .hint { font-size: 12px; color: var(--error-color); margin-top: 6px; font-weight: 500; }
    .invalid-field {
      border-color: var(--error-color) !important;
      box-shadow: 0 0 8px rgba(255, 107, 107, 0.5) !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title"></h1>
    <p class="subtitle" id="subtitle"></p>
    
    <form id="eventForm">
      <div class="form-group">
        <label for="eventTitle" class="required"><span id="lblTitle"></span></label>
        <input type="text" id="eventTitle" required>
      </div>
      
      <div class="row">
        <div class="form-group">
          <label for="eventDate" class="required"><span id="lblDate"></span></label>
          <input type="date" id="eventDate" required>
        </div>
        <div class="form-group">
          <label for="eventTime" class="required"><span id="lblTime"></span></label>
          <input type="time" id="eventTime" required>
        </div>
      </div>

      <div class="form-group">
        <label><span id="lblDuration"></span></label>
        <div class="radio-group">
          <input type="radio" name="duration" value="30" id="dur-30" checked>
          <label for="dur-30"><span id="opt30"></span></label>
          <input type="radio" name="duration" value="60" id="dur-60">
          <label for="dur-60"><span id="opt60"></span></label>
          <input type="radio" name="duration" value="custom" id="dur-custom">
          <label for="dur-custom"><span id="optCustom"></span></label>
        </div>
      </div>
      
      <div id="customEndContainer" class="hidden">
        <div class="row">
            <div class="form-group">
              <label for="eventEndDate" class="required"><span id="lblEndDate"></span></label>
              <input type="date" id="eventEndDate">
            </div>
            <div class="form-group">
              <label for="eventEndTime" class="required"><span id="lblEndTime"></span></label>
              <input type="time" id="eventEndTime">
              <div id="timeErrorHint" class="hint hidden"></div>
            </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="eventDesc"><span id="lblDesc"></span></label>
        <textarea id="eventDesc"></textarea>
      </div>
      
      <div class="form-group">
        <label for="eventLocation"><span id="lblLocation"></span></label>
        <input type="text" id="eventLocation">
      </div>
      
      <div class="button-container">
        <button type="submit" id="submitBtn"></button>
      </div>
      <p class="cancel-hint" id="cancelHint"></p>
    </form>
  </div>

  <script>
    const translations = {
      it: {
        title: "ğŸ—“ï¸ Nuovo Evento", subtitle: "Aggiungi un impegno alla tua agenda",
        lblTitle: "âœï¸ Titolo Evento", lblDate: "ğŸ—“ï¸ Data Inizio", lblTime: "â° Ora Inizio",
        lblDuration: "â±ï¸ Durata", opt30: "30 min", opt60: "60 min", optCustom: "Altro",
        lblEndDate: "ğŸ—“ï¸ Data Fine", lblEndTime: "â° Ora Fine", hintInvalidTime: "L'ora di fine non puÃ² precedere quella di inizio.",
        lblDesc: "ğŸ“„ Descrizione / Note (Opzionale)", lblLocation: "ğŸ“ Luogo (Opzionale)",
        btnSubmit: "Aggiungi Evento", btnSuccess: "Aggiunto! Puoi chiudere.", cancelHint: "Per annullare, basta chiudere questa finestra."
      },
      en: {
        title: "ğŸ—“ï¸ New Event", subtitle: "Add a commitment to your agenda",
        lblTitle: "âœï¸ Event Title", lblDate: "ğŸ—“ï¸ Start Date", lblTime: "â° Start Time",
        lblDuration: "â±ï¸ Duration", opt30: "30 min", opt60: "60 min", optCustom: "Other",
        lblEndDate: "ğŸ—“ï¸ End Date", lblEndTime: "â° End Time", hintInvalidTime: "End time cannot be earlier than start time.",
        lblDesc: "ğŸ“„ Description / Notes (Optional)", lblLocation: "ğŸ“ Location (Optional)",
        btnSubmit: "Add Event", btnSuccess: "Added! You can close now.", cancelHint: "To cancel, just close this window."
      },
      fr: {
        title: "ğŸ—“ï¸ Nouvel Ã‰vÃ©nement", subtitle: "Ajouter un engagement Ã  votre agenda",
        lblTitle: "âœï¸ Titre de l'Ã©vÃ©nement", lblDate: "ğŸ—“ï¸ Date de dÃ©but", lblTime: "â° Heure de dÃ©but",
        lblDuration: "â±ï¸ DurÃ©e", opt30: "30 min", opt60: "60 min", optCustom: "Autre",
        lblEndDate: "ğŸ—“ï¸ Date de fin", lblEndTime: "â° Heure de fin", hintInvalidTime: "L'heure de fin ne peut pas Ãªtre antÃ©rieure Ã  l'heure de dÃ©but.",
        lblDesc: "ğŸ“„ Description / Notes (Optionnel)", lblLocation: "ğŸ“ Lieu (Optionnel)",
        btnSubmit: "Ajouter l'Ã©vÃ©nement", btnSuccess: "AjoutÃ© ! Vous pouvez fermer.", cancelHint: "Pour annuler, fermez simplement cette fenÃªtre."
      },
      de: {
        title: "ğŸ—“ï¸ Neues Ereignis", subtitle: "FÃ¼gen Sie einen Termin zu Ihrem Kalender hinzu",
        lblTitle: "âœï¸ Ereignistitel", lblDate: "ğŸ—“ï¸ Startdatum", lblTime: "â° Startzeit",
        lblDuration: "â±ï¸ Dauer", opt30: "30 Min.", opt60: "60 Min.", optCustom: "Andere",
        lblEndDate: "ğŸ—“ï¸ Enddatum", lblEndTime: "â° Endzeit", hintInvalidTime: "Die Endzeit darf nicht vor der Startzeit liegen.",
        lblDesc: "ğŸ“„ Beschreibung / Notizen (Optional)", lblLocation: "ğŸ“ Ort (Optional)",
        btnSubmit: "Ereignis hinzufÃ¼gen", btnSuccess: "HinzugefÃ¼gt! Du kannst schlieÃŸen.", cancelHint: "Zum Abbrechen einfach dieses Fenster schlieÃŸen."
      },
      es: {
        title: "ğŸ—“ï¸ Nuevo Evento", subtitle: "AÃ±ade un compromiso a tu agenda",
        lblTitle: "âœï¸ TÃ­tulo del Evento", lblDate: "ğŸ—“ï¸ Fecha de Inicio", lblTime: "â° Hora de Inicio",
        lblDuration: "â±ï¸ DuraciÃ³n", opt30: "30 min", opt60: "60 min", optCustom: "Otro",
        lblEndDate: "ğŸ—“ï¸ Fecha de Fin", lblEndTime: "â° Hora de Fin", hintInvalidTime: "La hora de fin no puede ser anterior a la de inicio.",
        lblDesc: "ğŸ“„ DescripciÃ³n / Notas (Opcional)", lblLocation: "ğŸ“ UbicaciÃ³n (Opcional)",
        btnSubmit: "AÃ±adir Evento", btnSuccess: "Â¡AÃ±adido! Ya puedes cerrar.", cancelHint: "Para cancelar, simplemente cierra esta ventana."
      },
      pt: {
        title: "ğŸ—“ï¸ Novo Evento", subtitle: "Adicione um compromisso Ã  sua agenda",
        lblTitle: "âœï¸ TÃ­tulo do Evento", lblDate: "ğŸ—“ï¸ Data de InÃ­cio", lblTime: "â° Hora de InÃ­cio",
        lblDuration: "â±ï¸ DuraÃ§Ã£o", opt30: "30 min", opt60: "60 min", optCustom: "Outro",
        lblEndDate: "ğŸ—“ï¸ Data de Fim", lblEndTime: "â° Hora de Fim", hintInvalidTime: "A hora de tÃ©rmino nÃ£o pode ser anterior Ã  hora de inÃ­cio.",
        lblDesc: "ğŸ“„ DescriÃ§Ã£o / Notas (Opcional)", lblLocation: "ğŸ“ LocalizaÃ§Ã£o (Opcional)",
        btnSubmit: "Adicionar Evento", btnSuccess: "Adicionado! Pode fechar agora.", cancelHint: "Para cancelar, basta fechar esta janela."
      }
    };
    
    const N8N_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/a0b6b2cb-4e19-4a92-9269-6b6d8a7afb80";
    
    try {
      const tg = window.Telegram.WebApp;
      tg.ready(); tg.expand();
      
      const urlParams = new URLSearchParams(window.location.search);
      const lang = urlParams.get('lang') || 'it';
      const t = translations[lang] || translations.en; // FALLBACK IN INGLESE
      
      const dom = {
          form: document.getElementById('eventForm'), submitBtn: document.getElementById('submitBtn'),
          eventDate: document.getElementById('eventDate'), eventTime: document.getElementById('eventTime'),
          eventEndDate: document.getElementById('eventEndDate'), eventEndTime: document.getElementById('eventEndTime'),
          durationRadios: document.querySelectorAll('input[name="duration"]'),
          customEndContainer: document.getElementById('customEndContainer'),
          timeErrorHint: document.getElementById('timeErrorHint')
      };

      function applyTranslations() {
        document.title = t.title.replace(/<[^>]*>?/gm, '');
        document.getElementById('title').innerHTML = t.title; document.getElementById('subtitle').textContent = t.subtitle;
        document.getElementById('lblTitle').textContent = t.lblTitle; document.getElementById('lblDate').textContent = t.lblDate;
        document.getElementById('lblTime').textContent = t.lblTime; document.getElementById('lblDuration').textContent = t.lblDuration;
        document.getElementById('opt30').textContent = t.opt30; document.getElementById('opt60').textContent = t.opt60;
        document.getElementById('optCustom').textContent = t.optCustom; document.getElementById('lblEndDate').textContent = t.lblEndDate;
        document.getElementById('lblEndTime').textContent = t.lblEndTime;
        dom.timeErrorHint.textContent = t.hintInvalidTime;
        document.getElementById('lblDesc').textContent = t.lblDesc; document.getElementById('lblLocation').textContent = t.lblLocation;
        dom.submitBtn.textContent = t.btnSubmit; document.getElementById('cancelHint').textContent = t.cancelHint;
      }
      applyTranslations();
      
      function setMinDates() {
        const today = new Date().toISOString().split('T')[0];
        dom.eventDate.setAttribute('min', today); dom.eventDate.value = today;
        dom.eventEndDate.setAttribute('min', today); dom.eventEndDate.value = today;
      }
      setMinDates();

      function updateEndDateTimeConstraints() {
          const startDate = dom.eventDate.value;
          const startTime = dom.eventTime.value;
          dom.eventEndDate.setAttribute('min', startDate);
          if (dom.eventEndDate.value < startDate) dom.eventEndDate.value = startDate;
          if (dom.eventEndDate.value === startDate && startTime) {
              dom.eventEndTime.setAttribute('min', startTime);
          } else {
              dom.eventEndTime.removeAttribute('min');
          }
      }
      
      function validateForm() {
        const requiredInputs = dom.form.querySelectorAll('[required]');
        let isAllFilled = Array.from(requiredInputs).every(input => input.value.trim() !== '');
        
        let isTimeValid = true;
        dom.eventEndTime.classList.remove('invalid-field');
        dom.timeErrorHint.classList.add('hidden');
        
        const isCustomDuration = document.querySelector('input[name="duration"]:checked').value === 'custom';
        if (isCustomDuration && dom.eventDate.value === dom.eventEndDate.value && dom.eventTime.value && dom.eventEndTime.value && dom.eventEndTime.value < dom.eventTime.value) {
            isTimeValid = false;
            dom.eventEndTime.classList.add('invalid-field');
            dom.timeErrorHint.classList.remove('hidden');
        }
        
        dom.submitBtn.disabled = !isAllFilled || !isTimeValid;
      }

      ['change', 'input'].forEach(evt => {
          dom.eventDate.addEventListener(evt, updateEndDateTimeConstraints);
          dom.eventTime.addEventListener(evt, updateEndDateTimeConstraints);
          dom.eventEndDate.addEventListener(evt, updateEndDateTimeConstraints);
          dom.form.addEventListener(evt, validateForm);
      });
      
      dom.durationRadios.forEach(radio => {
          radio.addEventListener('change', () => {
              const isCustom = radio.value === 'custom';
              dom.customEndContainer.classList.toggle('hidden', !isCustom);
              dom.eventEndDate.toggleAttribute('required', isCustom);
              dom.eventEndTime.toggleAttribute('required', isCustom);
              if (isCustom) updateEndDateTimeConstraints();
              validateForm();
          });
      });
      
      validateForm();
      
      dom.form.addEventListener('submit', (e) => {
        e.preventDefault();
        const startTimeIso = new Date(`${dom.eventDate.value}T${dom.eventTime.value}`).toISOString();
        const durationChoice = document.querySelector('input[name="duration"]:checked').value;
        let endTimeIso = null; let durationInMinutes = null;
        if (durationChoice === 'custom') {
            endTimeIso = new Date(`${dom.eventEndDate.value}T${dom.eventEndTime.value}`).toISOString();
        } else {
            durationInMinutes = parseInt(durationChoice);
        }
        const eventData = {
          type: 'APPOINTMENT_SUBMISSION',
          payload: {
              title: document.getElementById('eventTitle').value.trim(),
              start_time: startTimeIso, end_time: endTimeIso, duration: durationInMinutes,
              description: document.getElementById('eventDesc').value.trim() || null,
              location: document.getElementById('eventLocation').value.trim() || null,
          },
          context: { chatId: urlParams.get('chatId'), threadId: urlParams.get('threadId'), language: lang }
        };
        fetch(N8N_WEBHOOK_URL, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(eventData)
        }).finally(() => {
            dom.submitBtn.disabled = true; dom.submitBtn.textContent = t.btnSuccess;
            setTimeout(() => { tg.close(); }, 1200);
        });
      });
    } catch (error) { console.error("Errore nell'inizializzazione dell'app:", error); }
  </script>
</body>
</html>
