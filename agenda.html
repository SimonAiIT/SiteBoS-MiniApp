<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Nuovo Evento Agenda</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-start: #4a5b8f; --bg-end: #2a3d5f; --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7); --border-color: rgba(255, 255, 255, 0.2);
      --input-bg: rgba(255, 255, 255, 0.08); --accent-color: #5B6FED;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text-primary); padding: 20px; min-height: 100vh;
    }
    .container { max-width: 500px; margin: 0 auto; }
    h1 { font-size: 26px; margin-bottom: 8px; font-weight: 600; }
    .subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 32px; font-weight: 300; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 10px; font-size: 14px; font-weight: 500; }
    input, textarea {
      width: 100%; padding: 14px 16px; border: 1px solid var(--border-color);
      border-radius: 12px; background: var(--input-bg); backdrop-filter: blur(10px);
      color: var(--text-primary); font-size: 15px; font-family: inherit;
    }

    /* NUOVE REGOLE CSS: Icone calendario e orologio piÃ¹ grandi e visibili */
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      opacity: 0.7;
      filter: invert(1); /* Rende l'icona bianca */
      transform: scale(1.2); /* Aumenta la dimensione del 20% */
      transition: opacity 0.2s ease;
    }
    input[type="date"]::-webkit-calendar-picker-indicator:hover,
    input[type="time"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }
    
    input:focus, textarea:focus {
      outline: none; border-color: rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 15px rgba(91, 111, 237, 0.3);
    }
    textarea { resize: vertical; min-height: 80px; }
    .required::after { content: " *"; color: #ff6b6b; }
    .button-container { text-align: center; margin-top: 32px; }
    #submitBtn {
      width: 100%; padding: 14px; background: var(--accent-color); color: var(--text-primary);
      border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer;
    }
    #submitBtn:disabled { background: #555; cursor: not-allowed; opacity: 0.6; }
    .cancel-hint { text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-secondary); opacity: 0.8; }
    .hint { font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 6px; }
    .row { display: flex; gap: 16px; }
    .row .form-group { flex: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title"></h1>
    <p class="subtitle" id="subtitle"></p>
    
    <form id="eventForm">
      <div class="form-group">
        <label for="eventTitle" class="required"><span id="lblTitle"></span></label>
        <input type="text" id="eventTitle" required>
      </div>
      
      <div class="row">
        <div class="form-group">
          <label for="eventDate" class="required"><span id="lblDate"></span></label>
          <input type="date" id="eventDate" required>
        </div>
        <div class="form-group">
          <label for="eventTime" class="required"><span id="lblTime"></span></label>
          <input type="time" id="eventTime" required>
        </div>
      </div>
      
      <div class="form-group">
        <label for="eventDesc"><span id="lblDesc"></span></label>
        <textarea id="eventDesc"></textarea>
      </div>
      
      <div class="form-group">
        <label for="eventLocation"><span id="lblLocation"></span></label>
        <input type="text" id="eventLocation">
      </div>
      
      <div class="button-container">
        <button type="submit" id="submitBtn"></button>
      </div>
      <p class="cancel-hint" id="cancelHint"></p>
    </form>
  </div>

  <script>
    const translations = {
      it: {
        title: "ğŸ—“ï¸ Nuovo Evento",
        subtitle: "Aggiungi un impegno alla tua agenda",
        lblTitle: "âœï¸ Titolo Evento",
        lblDate: "ğŸ—“ï¸ Data",
        lblTime: "â° Ora",
        lblDesc: "ğŸ“„ Descrizione / Note (Opzionale)",
        lblLocation: "ğŸ“ Luogo (Opzionale)",
        btnSubmit: "Aggiungi Evento",
        btnSuccess: "Aggiunto! Puoi chiudere.",
        cancelHint: "Per annullare, basta chiudere questa finestra."
      },
      en: {
        title: "ğŸ—“ï¸ New Event",
        subtitle: "Add a commitment to your agenda",
        lblTitle: "âœï¸ Event Title",
        lblDate: "ğŸ—“ï¸ Date",
        lblTime: "â° Time",
        lblDesc: "ğŸ“„ Description / Notes (Optional)",
        lblLocation: "ğŸ“ Location (Optional)",
        btnSubmit: "Add Event",
        btnSuccess: "Added! You can close now.",
        cancelHint: "To cancel, just close this window."
      },
      fr: {
        title: "ğŸ—“ï¸ Nouvel Ã‰vÃ©nement",
        subtitle: "Ajouter un engagement Ã  votre agenda",
        lblTitle: "âœï¸ Titre de l'Ã©vÃ©nement",
        lblDate: "ğŸ—“ï¸ Date",
        lblTime: "â° Heure",
        lblDesc: "ğŸ“„ Description / Notes (Optionnel)",
        lblLocation: "ğŸ“ Lieu (Optionnel)",
        btnSubmit: "Ajouter l'Ã©vÃ©nement",
        btnSuccess: "AjoutÃ© ! Vous pouvez fermer.",
        cancelHint: "Pour annuler, fermez simplement cette fenÃªtre."
      },
      de: {
        title: "ğŸ—“ï¸ Neues Ereignis",
        subtitle: "FÃ¼gen Sie einen Termin zu Ihrem Kalender hinzu",
        lblTitle: "âœï¸ Ereignistitel",
        lblDate: "ğŸ—“ï¸ Datum",
        lblTime: "â° Uhrzeit",
        lblDesc: "ğŸ“„ Beschreibung / Notizen (Optional)",
        lblLocation: "ğŸ“ Ort (Optional)",
        btnSubmit: "Ereignis hinzufÃ¼gen",
        btnSuccess: "HinzugefÃ¼gt! Du kannst schlieÃŸen.",
        cancelHint: "Zum Abbrechen einfach dieses Fenster schlieÃŸen."
      },
      es: {
        title: "ğŸ—“ï¸ Nuevo Evento",
        subtitle: "AÃ±ade un compromiso a tu agenda",
        lblTitle: "âœï¸ TÃ­tulo del Evento",
        lblDate: "ğŸ—“ï¸ Fecha",
        lblTime: "â° Hora",
        lblDesc: "ğŸ“„ DescripciÃ³n / Notas (Opcional)",
        lblLocation: "ğŸ“ UbicaciÃ³n (Opcional)",
        btnSubmit: "AÃ±adir Evento",
        btnSuccess: "Â¡AÃ±adido! Ya puedes cerrar.",
        cancelHint: "Para cancelar, simplemente cierra esta ventana."
      },
      pt: {
        title: "ğŸ—“ï¸ Novo Evento",
        subtitle: "Adicione um compromisso Ã  sua agenda",
        lblTitle: "âœï¸ TÃ­tulo do Evento",
        lblDate: "ğŸ—“ï¸ Data",
        lblTime: "â° Hora",
        lblDesc: "ğŸ“„ DescriÃ§Ã£o / Notas (Opcional)",
        lblLocation: "ğŸ“ LocalizaÃ§Ã£o (Opcional)",
        btnSubmit: "Adicionar Evento",
        btnSuccess: "Adicionado! Pode fechar.",
        cancelHint: "Para cancelar, basta fechar esta janela."
      }
    };
    
    const N8N_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/a0b6b2cb-4e19-4a92-9269-6b6d8a7afb80";
    
    try {
      const tg = window.Telegram.WebApp;
      tg.ready(); tg.expand();
      
      const urlParams = new URLSearchParams(window.location.search);
      const lang = urlParams.get('lang') || 'it';
      const t = translations[lang] || translations.it;
      
      function applyTranslations() {
        document.title = t.title.replace(/<[^>]*>?/gm, '');
        document.getElementById('title').innerHTML = t.title;
        document.getElementById('subtitle').textContent = t.subtitle;
        document.getElementById('lblTitle').textContent = t.lblTitle;
        document.getElementById('lblDate').textContent = t.lblDate;
        document.getElementById('lblTime').textContent = t.lblTime;
        document.getElementById('lblDesc').textContent = t.lblDesc;
        document.getElementById('lblLocation').textContent = t.lblLocation;
        document.getElementById('submitBtn').textContent = t.btnSubmit;
        document.getElementById('cancelHint').textContent = t.cancelHint;
      }
      applyTranslations();
      
      // NUOVO BLOCCO: Imposta la data minima per il campo della data
      function setMinDate() {
        const eventDateInput = document.getElementById('eventDate');
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        
        const minDate = `${year}-${month}-${day}`;
        eventDateInput.setAttribute('min', minDate);
        // Imposta anche il valore di default a oggi
        eventDateInput.value = minDate;
      }
      setMinDate();

      const form = document.getElementById('eventForm');
      const submitBtn = document.getElementById('submitBtn');
      const requiredInputs = form.querySelectorAll('[required]');
      
      function validateForm() {
        const isValid = Array.from(requiredInputs).every(input => input.value.trim() !== '');
        submitBtn.disabled = !isValid;
      }
      requiredInputs.forEach(input => input.addEventListener('input', validateForm));
      validateForm();
      
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const date = document.getElementById('eventDate').value;
        const time = document.getElementById('eventTime').value;
        const startTimeIso = new Date(`${date}T${time}`).toISOString();

        const eventData = {
          type: 'APPOINTMENT_SUBMISSION',
          payload: {
              title: document.getElementById('eventTitle').value.trim(),
              start_time: startTimeIso,
              description: document.getElementById('eventDesc').value.trim() || null,
              location: document.getElementById('eventLocation').value.trim() || null,
          },
          context: {
              chatId: urlParams.get('chatId'),
              threadId: urlParams.get('threadId'),
              language: lang,
              timestamp: new Date().toISOString()
          }
        };

        fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(eventData)
        })
        .finally(() => {
            submitBtn.disabled = true;
            submitBtn.textContent = t.btnSuccess;
            setTimeout(() => { tg.close(); }, 1200);
        });
      });

    } catch (error) { /* ... */ }
  </script>
</body>
</html>
