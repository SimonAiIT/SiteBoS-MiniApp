<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Calendario Manager Desk</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  
    <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="calendar"></div>
  <!-- Modal fallback per dettagli evento -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
      <div id="modalText"></div>
      <button class="modal-close" id="modalCloseBtn" onclick="closeModal()">Chiudi</button>
    </div>
  </div>
  <script>
    // Traduzioni multilingua
    const translations = {
      it: {
        title: 'Calendario Manager Desk',
        missingParam: 'Parametro group_id mancante',
        error: 'Errore',
        close: 'Chiudi',
        priority: 'Priorit√†',
        dueDate: 'Scadenza',
        status: 'Status',
        tags: 'Tags',
        duration: 'Durata',
        end: 'Fine',
        location: 'Non specificato',
        locale: 'it'
      },
      en: {
        title: 'Manager Desk Calendar',
        missingParam: 'Missing group_id parameter',
        error: 'Error',
        close: 'Close',
        priority: 'Priority',
        dueDate: 'Due Date',
        status: 'Status',
        tags: 'Tags',
        duration: 'Duration',
        end: 'End',
        location: 'Not specified',
        locale: 'en'
      },
      fr: {
        title: 'Calendrier Manager Desk',
        missingParam: 'Param√®tre group_id manquant',
        error: 'Erreur',
        close: 'Fermer',
        priority: 'Priorit√©',
        dueDate: 'Date limite',
        status: 'Statut',
        tags: 'Tags',
        duration: 'Dur√©e',
        end: 'Fin',
        location: 'Non sp√©cifi√©',
        locale: 'fr'
      },
      de: {
        title: 'Manager Desk Kalender',
        missingParam: 'Fehlender group_id Parameter',
        error: 'Fehler',
        close: 'Schlie√üen',
        priority: 'Priorit√§t',
        dueDate: 'F√§lligkeitsdatum',
        status: 'Status',
        tags: 'Tags',
        duration: 'Dauer',
        end: 'Ende',
        location: 'Nicht angegeben',
        locale: 'de'
      },
      es: {
        title: 'Calendario Manager Desk',
        missingParam: 'Falta el par√°metro group_id',
        error: 'Error',
        close: 'Cerrar',
        priority: 'Prioridad',
        dueDate: 'Fecha l√≠mite',
        status: 'Estado',
        tags: 'Etiquetas',
        duration: 'Duraci√≥n',
        end: 'Fin',
        location: 'No especificado',
        locale: 'es'
      },
      pt: {
        title: 'Calend√°rio Manager Desk',
        missingParam: 'Par√¢metro group_id ausente',
        error: 'Erro',
        close: 'Fechar',
        priority: 'Prioridade',
        dueDate: 'Data limite',
        status: 'Status',
        tags: 'Tags',
        duration: 'Dura√ß√£o',
        end: 'Fim',
        location: 'N√£o especificado',
        locale: 'pt'
      }
    };

    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const params = new URLSearchParams(window.location.search);
    const groupId = params.get('group_id');
    const langParam = params.get('lang') || 'en';
    
    // Seleziona la lingua con fallback su inglese
    const lang = translations[langParam] ? langParam : 'en';
    const t = translations[lang];

    // Imposta il titolo della pagina
    document.title = t.title;

    if (!groupId) {
      document.body.innerHTML = `<h2>${t.missingParam}</h2>`;
      throw new Error(t.missingParam);
    }

    const apiUrl = `https://trinai.api.workflow.dcmake.it/webhook/manager-desk/appointments?group_id=${groupId}`;

    // Imposta il testo del pulsante chiudi
    document.getElementById('modalCloseBtn').textContent = t.close;

    function showEventDetails(details) {
      // Prova prima con Telegram
      if (tg && tg.showAlert) {
        try {
          tg.showAlert(details);
          return;
        } catch (e) {
          console.warn('Telegram showAlert fallito, uso modal', e);
        }
      }
      // Fallback: modal custom
      document.getElementById('modalText').textContent = details;
      document.getElementById('modalOverlay').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    fetch(apiUrl)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${t.error}: ${res.status}`);
        return res.json();
      })
      .then(responseData => {
        const eventsArray = responseData.events; 
        console.log('Eventi caricati:', eventsArray);
        
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: window.innerWidth < 768 ? 'timeGridDay' : 'dayGridMonth',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          locale: t.locale,
          firstDay: 1,
          slotMinTime: '07:00:00',
          slotMaxTime: '22:00:00',
          events: eventsArray,
          height: 'auto',
          dayMaxEventRows: true,
          selectable: false,
          editable: false,
          
          eventClick: function(info) {
            const event = info.event;
            const props = event.extendedProps;
            let details;

            if (props.type === 'note') {
              const dueDate = new Date(event.start);
              const priorityEmoji = { 'HIGH': 'üî¥', 'MEDIUM': 'üü°', 'LOW': 'üîµ' };

              details = `üìå ${event.title.replace('üìå ', '')}\n\n${priorityEmoji[props.priority] || '‚ö™'} ${t.priority}: ${props.priority}\nüìÖ ${t.dueDate}: ${dueDate.toLocaleDateString(t.locale, {
  weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
})}\nüìä ${t.status}: ${props.status}\n${props.tags && props.tags.length > 0 ? 'üè∑Ô∏è ' + t.tags + ': ' + props.tags.join(', ') : ''}`;
            } else {
              const start = new Date(event.start);
              const end = event.end ? new Date(event.end) : null;
              
              details = `üìÖ ${event.title}\n\nüïê ${start.toLocaleString(t.locale, {
  weekday: 'long', day: 'numeric', month: 'long', year: 'numeric',
  hour: '2-digit', minute: '2-digit'
})}\n${end ? 'üïê ' + t.end + ': ' + end.toLocaleTimeString(t.locale, {hour: '2-digit', minute: '2-digit'}) : ''}\n\n‚è±Ô∏è ${t.duration}: ${props.duration_minutes || 'N/A'} min\nüìç ${props.location || t.location}\n${props.description ? 'üìù ' + props.description : ''}`;
            }

            showEventDetails(details);
          },
          
          dateClick: function(info) {
            calendar.changeView('timeGridDay', info.dateStr);
          }
        });
        
        calendar.render();
      })
      .catch(err => {
        document.body.innerHTML = `<h2>${t.error}: ${err.message}</h2>`;
      });
  </script>
</body>
</html>
