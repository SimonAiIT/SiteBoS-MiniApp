<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Calendario Manager Desk</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <style>
    :root {
      --bg-start: #4a5b8f; --bg-end: #2a3d5f; --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7); --border-color: rgba(255, 255, 255, 0.2);
      --input-bg: rgba(255, 255, 255, 0.08); --accent-color: #5B6FED; --error-color: #ff6b6b;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text-primary); padding: 20px; min-height: 100vh;
    }
    #calendar {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.07);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
    }
    .fc {
      font-family: inherit;
      color: var(--text-primary);
    }
    .fc .fc-toolbar-title {
      font-weight: 600;
      font-size: 1.3rem;
      color: var(--text-primary);
    }
    .fc button {
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 8px;
      font-weight: 600;
    }
    .fc button:hover, .fc button:focus {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: #fff;
      outline: none;
      box-shadow: 0 0 10px var(--accent-color);
    }
    .fc .fc-daygrid-event {
      border-radius: 8px;
      padding: 2px 6px;
      font-size: 0.9rem;
      font-weight: 600;
      line-height: 1.2;
      white-space: normal;
      cursor: pointer;
    }
    .fc .fc-timegrid-event {
      cursor: pointer;
    }
    
    /* Modal popup fallback */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      color: var(--text-primary);
      white-space: pre-line;
      line-height: 1.6;
    }
    .modal-close {
      margin-top: 20px;
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="calendar"></div>
  <!-- Modal fallback per dettagli evento -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
      <div id="modalText"></div>
      <button class="modal-close" onclick="closeModal()">Chiudi</button>
    </div>
  </div>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const params = new URLSearchParams(window.location.search);
    const groupId = params.get('group_id');

    if (!groupId) {
      document.body.innerHTML = '<h2 style="color: red; text-align:center;">Parametro group_id mancante</h2>';
      throw new Error('Parametro group_id mancante');
    }

    const apiUrl = `https://trinai.api.workflow.prod.dcmake.it/webhook/manager-desk/appointments?group_id=${groupId}`;

    function showEventDetails(details) {
      // Prova prima con Telegram
      if (tg && tg.showAlert) {
        try {
          tg.showAlert(details);
          return;
        } catch (e) {
          console.warn('Telegram showAlert fallito, uso modal', e);
        }
      }
      // Fallback: modal custom
      document.getElementById('modalText').textContent = details;
      document.getElementById('modalOverlay').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    fetch(apiUrl)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
        return res.json();
      })
      .then(events => {
        console.log('Eventi caricati:', events);
        
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: window.innerWidth < 768 ? 'timeGridDay' : 'dayGridMonth',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          locale: 'it',
          firstDay: 1,
          slotMinTime: '07:00:00',
          slotMaxTime: '22:00:00',
          events: events,
          height: 'auto',
          dayMaxEventRows: true,
          selectable: false,
          editable: false,
          
          eventClick: function(info) {
            const event = info.event;
            const props = event.extendedProps;
            let details;

            if (props.type === 'note') {
              const dueDate = new Date(event.start);
              const priorityEmoji = { 'HIGH': 'ðŸ”´', 'MEDIUM': 'ðŸŸ¡', 'LOW': 'ðŸ”µ' };

              details = `ðŸ“Œ ${event.title.replace('ðŸ“Œ ', '')}

${priorityEmoji[props.priority] || 'âšª'} PrioritÃ : ${props.priority}
ðŸ“… Scadenza: ${dueDate.toLocaleDateString('it-IT', {
  weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
})}
ðŸ“Š Status: ${props.status}
${props.tags && props.tags.length > 0 ? 'ðŸ·ï¸ Tags: ' + props.tags.join(', ') : ''}`;
            } else {
              const start = new Date(event.start);
              const end = event.end ? new Date(event.end) : null;
              
              details = `ðŸ“… ${event.title}

ðŸ• ${start.toLocaleString('it-IT', {
  weekday: 'long', day: 'numeric', month: 'long', year: 'numeric',
  hour: '2-digit', minute: '2-digit'
})}
${end ? 'ðŸ• Fine: ' + end.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'}) : ''}

â±ï¸ Durata: ${props.duration_minutes || 'N/A'} min
ðŸ“ ${props.location || 'Non specificato'}
${props.description ? 'ðŸ“ ' + props.description : ''}`;
            }

            showEventDetails(details);
          },
          
          dateClick: function(info) {
            calendar.changeView('timeGridDay', info.dateStr);
          }
        });
        
        calendar.render();
      })
      .catch(err => {
        document.body.innerHTML = '<h2 style="color: red; text-align:center;">Errore: ' + err.message + '</h2>';
      });
  </script>
</body>
</html>
