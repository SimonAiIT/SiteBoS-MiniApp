<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale-1.0, user-scalable=no, viewport-fit=cover">
  <title>Pianifica Percorso</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
    <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1 id="title"></h1>
    <p class="subtitle" id="subtitle"></p>
    
    <form id="travelForm">
      <div class="form-group checkbox-group">
        <input type="checkbox" id="partenzaDaSede" checked>
        <label for="partenzaDaSede"><span id="lblPartenzaSede"></span></label>
      </div>
      <div id="customPartenzaContainer" class="hidden">
        <label for="partenza" class="required"><span id="lblPartenza"></span></label>
        <input type="text" id="partenza">
      </div>

      <div class="form-group checkbox-group">
        <input type="checkbox" id="arrivoInSede" checked>
        <label for="arrivoInSede"><span id="lblArrivoSede"></span></label>
      </div>
      <div id="customArrivoContainer" class="hidden">
        <label for="arrivo" class="required"><span id="lblArrivo"></span></label>
        <input type="text" id="arrivo">
      </div>

      <div class="form-group">
        <label><span id="lblTipoPercorso"></span></label>
        <div class="radio-group">
          <input type="radio" name="tripType" value="interessi" id="radio-interessi" checked>
          <label for="radio-interessi"><span id="optInteressi"></span></label>
          <input type="radio" name="tripType" value="appuntamenti" id="radio-appuntamenti">
          <label for="radio-appuntamenti"><span id="optAppuntamenti"></span></label>
        </div>
      </div>

      <div id="dataAppuntamentoContainer" class="form-group hidden">
        <label for="dataAppuntamento" class="required"><span id="lblDataAppuntamento"></span></label>
        <input type="date" id="dataAppuntamento">
      </div>

      <div id="midpointContainer" class="form-group">
        <label for="midpoint"><span id="lblMidpoint"></span></label>
        <input type="text" id="midpoint">
        <div class="hint" id="hintMidpoint"></div>
      </div>

      <div class="form-group">
        <label for="dettagli"><span id="lblDettagli"></span></label>
        <input type="text" id="dettagli">
      </div>
      
      <div class="form-group checkbox-group">
        <input type="checkbox" id="includeTripDetails">
        <label for="includeTripDetails"><span id="lblPernottamento"></span></label>
      </div>
      
      <div id="tripDetailsContainer" class="hidden">
        <div class="row">
          <div class="form-group"><label for="notti"><span id="lblNotti"></span></label><input type="number" id="notti" min="1" value="1"></div>
          <div class="form-group"><label for="adulti"><span id="lblAdulti"></span></label><input type="number" id="adulti" min="1" value="2"></div>
          <div class="form-group"><label for="bambini"><span id="lblBambini"></span></label><input type="number" id="bambini" min="0" value="0"></div>
        </div>
      </div>

      <div class="button-container"><button type="submit" id="submitBtn"></button></div>
      <p class="cancel-hint" id="cancelHint"></p>
    </form>
  </div>

  <script>
    const translations = {
      it: {
        title: "ğŸš— Pianifica Percorso", subtitle: "Crea un itinerario o calcola un percorso per appuntamenti.",
        lblPartenza: "ğŸ“ Punto di Partenza Personalizzato", lblPartenzaSede: "Partenza da Sede",
        lblArrivo: "ğŸ Punto di Arrivo Personalizzato", lblArrivoSede: "Arrivo in Sede",
        lblTipoPercorso: "Scopo del percorso", optInteressi: "Interessi", optAppuntamenti: "Appuntamenti",
        lblDataAppuntamento: "ğŸ—“ï¸ Data Appuntamento",
        lblMidpoint: "ğŸ—ºï¸ Tappe Intermedie (Opzionale)", hintMidpoint: "Puoi elencare piÃ¹ destinazioni qui",
        lblDettagliApp: "Dettagli Appuntamento (es. Cliente Rossi)", lblDettagliInt: "Elenca Interessi (es. cibo, musei)",
        lblPernottamento: "Pianifica anche il pernottamento",
        lblNotti: "ğŸŒ™ Notti", lblAdulti: "ğŸ‘¥ Adulti", lblBambini: "ğŸ§’ Bambini",
        btnSubmit: "Crea Itinerario", btnSuccess: "Richiesta inviata!", cancelHint: "Per annullare, chiudi la finestra."
      },
      en: {
        title: "ğŸš— Plan Route", subtitle: "Create an itinerary or calculate a route for appointments.",
        lblPartenza: "ğŸ“ Custom Starting Point", lblPartenzaSede: "Depart from Office",
        lblArrivo: "ğŸ Custom Destination", lblArrivoSede: "Arrive at Office",
        lblTipoPercorso: "Purpose of the route", optInteressi: "Interests", optAppuntamenti: "Appointments",
        lblDataAppuntamento: "ğŸ—“ï¸ Appointment Date",
        lblMidpoint: "ğŸ—ºï¸ Midpoints / Stops (Optional)", hintMidpoint: "You can list multiple destinations here",
        lblDettagliApp: "Appointment Details (e.g., Client Smith)", lblDettagliInt: "List Interests (e.g., food, museums)",
        lblPernottamento: "Plan overnight stay as well",
        lblNotti: "ğŸŒ™ Nights", lblAdulti: "ğŸ‘¥ Adults", lblBambini: "ğŸ§’ Children",
        btnSubmit: "Create Itinerary", btnSuccess: "Request sent!", cancelHint: "To cancel, just close the window."
      },
      fr: {
        title: "ğŸš— Planifier l'ItinÃ©raire", subtitle: "CrÃ©ez un itinÃ©raire ou calculez un trajet pour des rendez-vous.",
        lblPartenza: "ğŸ“ Point de DÃ©part PersonnalisÃ©", lblPartenzaSede: "DÃ©part du SiÃ¨ge",
        lblArrivo: "ğŸ Destination PersonnalisÃ©e", lblArrivoSede: "ArrivÃ©e au SiÃ¨ge",
        lblTipoPercorso: "But du parcours", optInteressi: "IntÃ©rÃªts", optAppuntamenti: "Rendez-vous",
        lblDataAppuntamento: "ğŸ—“ï¸ Date du Rendez-vous",
        lblMidpoint: "ğŸ—ºï¸ Ã‰tapes IntermÃ©diaires (Optionnel)", hintMidpoint: "Vous pouvez lister plusieurs destinations ici",
        lblDettagliApp: "DÃ©tails du rendez-vous (ex: Client Durand)", lblDettagliInt: "Listez vos intÃ©rÃªts (ex: nourriture, musÃ©es)",
        lblPernottamento: "Planifier aussi la nuitÃ©e",
        lblNotti: "ğŸŒ™ Nuits", lblAdulti: "ğŸ‘¥ Adultes", lblBambini: "ğŸ§’ Enfants",
        btnSubmit: "CrÃ©er l'ItinÃ©raire", btnSuccess: "Demande envoyÃ©e !", cancelHint: "Pour annuler, fermez la fenÃªtre."
      },
      de: {
        title: "ğŸš— Route planen", subtitle: "Erstellen Sie eine Reiseroute oder berechnen Sie eine Strecke fÃ¼r Termine.",
        lblPartenza: "ğŸ“ Benutzerdefinierter Startpunkt", lblPartenzaSede: "Abfahrt vom BÃ¼ro",
        lblArrivo: "ğŸ Benutzerdefiniertes Ziel", lblArrivoSede: "Ankunft im BÃ¼ro",
        lblTipoPercorso: "Zweck der Route", optInteressi: "Interessen", optAppuntamenti: "Termine",
        lblDataAppuntamento: "ğŸ—“ï¸ Termindatum",
        lblMidpoint: "ğŸ—ºï¸ Zwischenstopps (Optional)", hintMidpoint: "Sie kÃ¶nnen hier mehrere Ziele auflisten",
        lblDettagliApp: "Termindetails (z.B. Kunde MÃ¼ller)", lblDettagliInt: "Interessen auflisten (z.B. Essen, Museen)",
        lblPernottamento: "Auch Ãœbernachtung planen",
        lblNotti: "ğŸŒ™ NÃ¤chte", lblAdulti: "ğŸ‘¥ Erwachsene", lblBambini: "ğŸ§’ Kinder",
        btnSubmit: "Route erstellen", btnSuccess: "Anfrage gesendet!", cancelHint: "Zum Abbrechen, schlieÃŸen Sie das Fenster."
      },
      es: {
        title: "ğŸš— Planificar Ruta", subtitle: "Crea un itinerario o calcula una ruta para citas.",
        lblPartenza: "ğŸ“ Punto de Salida Personalizado", lblPartenzaSede: "Salida desde la Oficina",
        lblArrivo: "ğŸ Destino Personalizado", lblArrivoSede: "Llegada a la Oficina",
        lblTipoPercorso: "PropÃ³sito de la ruta", optInteressi: "Intereses", optAppuntamenti: "Citas",
        lblDataAppuntamento: "ğŸ—“ï¸ Fecha de la Cita",
        lblMidpoint: "ğŸ—ºï¸ Paradas Intermedias (Opcional)", hintMidpoint: "Puedes listar mÃºltiples destinos aquÃ­",
        lblDettagliApp: "Detalles de la cita (ej: Cliente GarcÃ­a)", lblDettagliInt: "Enumera intereses (ej: comida, museos)",
        lblPernottamento: "Planificar tambiÃ©n la pernoctaciÃ³n",
        lblNotti: "ğŸŒ™ Noches", lblAdulti: "ğŸ‘¥ Adultos", lblBambini: "ğŸ§’ NiÃ±os",
        btnSubmit: "Crear Itinerario", btnSuccess: "Â¡Solicitud enviada!", cancelHint: "Para cancelar, cierra la ventana."
      },
      pt: {
        title: "ğŸš— Planear Rota", subtitle: "Crie um itinerÃ¡rio ou calcule uma rota para compromissos.",
        lblPartenza: "ğŸ“ Ponto de Partida Personalizado", lblPartenzaSede: "Partida do EscritÃ³rio",
        lblArrivo: "ğŸ Destino Personalizado", lblArrivoSede: "Chegada ao EscritÃ³rio",
        lblTipoPercorso: "Objetivo da rota", optInteressi: "Interesses", optAppuntamenti: "Compromissos",
        lblDataAppuntamento: "ğŸ—“ï¸ Data do Compromisso",
        lblMidpoint: "ğŸ—ºï¸ Paragens IntermÃ©dias (Opcional)", hintMidpoint: "Pode listar vÃ¡rios destinos aqui",
        lblDettagliApp: "Detalhes do compromisso (ex: Cliente Silva)", lblDettagliInt: "Liste interesses (ex: comida, museus)",
        lblPernottamento: "Planear tambÃ©m a pernoita",
        lblNotti: "ğŸŒ™ Noites", lblAdulti: "ğŸ‘¥ Adultos", lblBambini: "ğŸ§’ CrianÃ§as",
        btnSubmit: "Criar ItinerÃ¡rio", btnSuccess: "Pedido enviado!", cancelHint: "Para cancelar, feche a janela."
      }
    };
    
    const N8N_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/a0b6b2cb-4e19-4a92-9269-6b6d8a7afb80";
    
    try {
      const tg = window.Telegram.WebApp;
      tg.ready(); tg.expand();
      
      const urlParams = new URLSearchParams(window.location.search);
      const lang = urlParams.get('lang') || 'it';
      const t = translations[lang] || translations.en; // FALLBACK IN INGLESE
      
      const dom = {
          form: document.getElementById('travelForm'), submitBtn: document.getElementById('submitBtn'),
          title: document.getElementById('title'), subtitle: document.getElementById('subtitle'),
          lblPartenza: document.getElementById('lblPartenza'), lblPartenzaSede: document.getElementById('lblPartenzaSede'),
          lblArrivo: document.getElementById('lblArrivo'), lblArrivoSede: document.getElementById('lblArrivoSede'),
          lblTipoPercorso: document.getElementById('lblTipoPercorso'),
          optInteressi: document.getElementById('optInteressi'), optAppuntamenti: document.getElementById('optAppuntamenti'),
          lblDataAppuntamento: document.getElementById('lblDataAppuntamento'), lblMidpoint: document.getElementById('lblMidpoint'),
          hintMidpoint: document.getElementById('hintMidpoint'), lblPernottamento: document.getElementById('lblPernottamento'),
          lblNotti: document.getElementById('lblNotti'), lblAdulti: document.getElementById('lblAdulti'),
          lblBambini: document.getElementById('lblBambini'), cancelHint: document.getElementById('cancelHint'),
          partenzaDaSede: document.getElementById('partenzaDaSede'), customPartenzaContainer: document.getElementById('customPartenzaContainer'),
          partenza: document.getElementById('partenza'), arrivoInSede: document.getElementById('arrivoInSede'),
          customArrivoContainer: document.getElementById('customArrivoContainer'), arrivo: document.getElementById('arrivo'),
          dataAppuntamentoContainer: document.getElementById('dataAppuntamentoContainer'), dataAppuntamento: document.getElementById('dataAppuntamento'),
          midpointContainer: document.getElementById('midpointContainer'), midpoint: document.getElementById('midpoint'),
          dettagli: document.getElementById('dettagli'), lblDettagli: document.getElementById('lblDettagli'),
          includeTripDetails: document.getElementById('includeTripDetails'), tripDetailsContainer: document.getElementById('tripDetailsContainer'),
          notti: document.getElementById('notti'), adulti: document.getElementById('adulti'),
          bambini: document.getElementById('bambini'),
          tripTypeRadios: document.querySelectorAll('input[name="tripType"]')
      };

      function applyTranslations() {
        document.title = t.title.replace(/<[^>]*>?/gm, '');
        dom.title.innerHTML = t.title; dom.subtitle.textContent = t.subtitle;
        dom.lblPartenza.textContent = t.lblPartenza; dom.lblPartenzaSede.textContent = t.lblPartenzaSede;
        dom.lblArrivo.textContent = t.lblArrivo; dom.lblArrivoSede.textContent = t.lblArrivoSede;
        dom.lblTipoPercorso.textContent = t.lblTipoPercorso; dom.optInteressi.textContent = t.optInteressi;
        dom.optAppuntamenti.textContent = t.optAppuntamenti; dom.lblDataAppuntamento.textContent = t.lblDataAppuntamento;
        dom.lblMidpoint.textContent = t.lblMidpoint; dom.hintMidpoint.textContent = t.hintMidpoint;
        dom.lblPernottamento.textContent = t.lblPernottamento; dom.lblNotti.textContent = t.lblNotti;
        dom.lblAdulti.textContent = t.lblAdulti; dom.lblBambini.textContent = t.lblBambini;
        dom.submitBtn.textContent = t.btnSubmit; dom.cancelHint.textContent = t.cancelHint;
      }
      applyTranslations();
      
      function setMinDate() { dom.dataAppuntamento.setAttribute('min', new Date().toISOString().split('T')[0]); }
      setMinDate();

      function updateFormUI() {
          const tripType = document.querySelector('input[name="tripType"]:checked').value;
          const isAppointments = tripType === 'appuntamenti';
          dom.dataAppuntamentoContainer.classList.toggle('hidden', !isAppointments);
          dom.dataAppuntamento.toggleAttribute('required', isAppointments);
          dom.midpointContainer.classList.toggle('hidden', isAppointments);
          dom.lblDettagli.textContent = isAppointments ? t.lblDettagliApp : t.lblDettagliInt;
          validateForm();
      }

      function createCheckboxToggleListener(checkbox, container, input) {
          checkbox.addEventListener('change', function() {
              container.classList.toggle('hidden', this.checked);
              input.toggleAttribute('required', !this.checked);
              validateForm();
          });
      }

      createCheckboxToggleListener(dom.partenzaDaSede, dom.customPartenzaContainer, dom.partenza);
      createCheckboxToggleListener(dom.arrivoInSede, dom.customArrivoContainer, dom.arrivo);
      dom.tripTypeRadios.forEach(radio => radio.addEventListener('change', updateFormUI));
      dom.includeTripDetails.addEventListener('change', function() {
          const isChecked = this.checked;
          dom.tripDetailsContainer.classList.toggle('hidden', !isChecked);
          dom.notti.toggleAttribute('required', isChecked);
          dom.adulti.toggleAttribute('required', isChecked);
          validateForm();
      });

      function validateForm() {
          const currentRequired = dom.form.querySelectorAll('[required]');
          const isValid = Array.from(currentRequired).every(input => input.value.trim() !== '');
          dom.submitBtn.disabled = !isValid;
      }
      
      dom.form.addEventListener('input', validateForm);
      updateFormUI();

      dom.form.addEventListener('submit', (e) => {
        e.preventDefault();
        const tripType = document.querySelector('input[name="tripType"]:checked').value;
        const pernottamento = dom.includeTripDetails.checked;
        const tripData = {
          type: 'TRIP_PLANNING_SUBMISSION',
          payload: {
              Partenza: dom.partenzaDaSede.checked ? "Sede" : dom.partenza.value.trim(),
              Arrivo: dom.arrivoInSede.checked ? "Sede" : dom.arrivo.value.trim(),
              TipoPercorso: tripType,
              TappeIntermedie: tripType === 'interessi' ? (dom.midpoint.value.trim() || null) : null,
              Dettagli: dom.dettagli.value.trim() || null,
              DataAppuntamento: tripType === 'appuntamenti' ? dom.dataAppuntamento.value : null,
              PernottamentoIncluso: pernottamento,
              Notti: pernottamento ? parseInt(dom.notti.value) : null,
              Adulti: pernottamento ? parseInt(dom.adulti.value) : null,
              Bambini: pernottamento ? parseInt(dom.bambini.value) : null,
          },
          context: { chatId: urlParams.get('chatId'), threadId: urlParams.get('threadId'), language: lang }
        };

        fetch(N8N_WEBHOOK_URL, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(tripData)
        }).finally(() => {
            dom.submitBtn.disabled = true; dom.submitBtn.textContent = t.btnSuccess;
            setTimeout(() => { tg.close(); }, 1200);
        });
      });
    } catch (error) {
        console.error("Errore nell'inizializzazione dell'app:", error);
        document.body.innerHTML = '<h1>Oops!</h1><p>Qualcosa Ã¨ andato storto. Assicurati di aprire questa pagina da Telegram.</p>';
    }
  </script>
</body>
</html>
