<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Pianifica Percorso</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-start: #4a5b8f; --bg-end: #2a3d5f; --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7); --border-color: rgba(255, 255, 255, 0.2);
      --input-bg: rgba(255, 255, 255, 0.08); --accent-color: #5B6FED;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text-primary); padding: 20px; min-height: 100vh;
    }
    .container { max-width: 500px; margin: 0 auto; }
    h1 { font-size: 26px; margin-bottom: 8px; font-weight: 600; }
    .subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 32px; font-weight: 300; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 10px; font-size: 14px; font-weight: 500; }
    
    input, textarea {
      width: 100%; padding: 14px 16px; border: 1px solid var(--border-color);
      border-radius: 12px; background: var(--input-bg); backdrop-filter: blur(10px);
      color: var(--text-primary); font-size: 15px; font-family: inherit;
    }
    input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; filter: invert(1); transform: scale(1.2); }
    
    /* MODIFICA: Stile unificato per Radio e Checkbox */
    .radio-group, .checkbox-group { display: flex; gap: 10px; margin-top: 10px; }
    .radio-group input, .checkbox-group input { display: none; } /* Nasconde l'input nativo */
    .radio-group label, .checkbox-group label {
      flex: 1; display: flex; align-items: center; justify-content: flex-start; /* Allinea a sinistra */
      cursor: pointer; font-size: 15px; padding: 12px 16px; border-radius: 12px;
      transition: all 0.3s ease; background-color: var(--input-bg);
      border: 1px solid var(--border-color); color: var(--text-secondary); opacity: 0.7;
    }
    /* Stato selezionato */
    .radio-group input:checked + label, .checkbox-group input:checked + label {
      border-color: var(--accent-color); color: var(--text-primary); opacity: 1;
      background-color: rgba(91, 111, 237, 0.15);
    }
    /* Icona radio */
    .radio-group label::before {
      content: ''; display: inline-block; width: 18px; height: 18px;
      margin-right: 12px; border: 2px solid var(--text-secondary);
      border-radius: 50%; transition: all 0.2s ease; flex-shrink: 0;
    }
    .radio-group input:checked + label::before {
      border-color: var(--accent-color); background-color: var(--accent-color);
      box-shadow: 0 0 8px rgba(91, 111, 237, 0.5);
    }
    /* Icona checkbox */
    .checkbox-group label::before {
      content: '‚úì'; display: inline-block; width: 20px; height: 20px; line-height: 18px;
      text-align: center; font-weight: bold; margin-right: 12px; 
      border: 2px solid var(--text-secondary); border-radius: 5px; 
      transition: all 0.2s ease; flex-shrink: 0; color: transparent;
    }
    .checkbox-group input:checked + label::before {
      border-color: var(--accent-color); background-color: var(--accent-color);
      color: var(--text-primary); box-shadow: 0 0 8px rgba(91, 111, 237, 0.5);
    }

    input:focus, textarea:focus { outline: none; border-color: rgba(255, 255, 255, 0.5); box-shadow: 0 0 15px rgba(91, 111, 237, 0.3); }
    .required::after { content: " *"; color: #ff6b6b; }
    .button-container { text-align: center; margin-top: 32px; }
    #submitBtn { width: 100%; padding: 14px; background: var(--accent-color); color: var(--text-primary); border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; }
    #submitBtn:disabled { background: #555; cursor: not-allowed; opacity: 0.6; }
    .cancel-hint { text-align: center; margin-top: 16px; font-size: 13px; color: var(--text-secondary); opacity: 0.8; }
    .row { display: flex; gap: 16px; }
    .row .form-group { flex: 1; }
    .hidden { display: none !important; }
    .hint { font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 6px; }
    #tripDetailsContainer { overflow: hidden; max-height: 500px; opacity: 1; transition: all 0.5s ease-in-out; margin-top: 20px; }
    #tripDetailsContainer.hidden { max-height: 0; opacity: 0; margin: 0; padding: 0; border: 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title"></h1>
    <p class="subtitle" id="subtitle"></p>
    
    <form id="travelForm">
      <!-- MODIFICA HTML: Nuova struttura per i Checkbox -->
      <div class="form-group checkbox-group">
        <input type="checkbox" id="partenzaDaSede" checked>
        <label for="partenzaDaSede"><span id="lblPartenzaSede"></span></label>
      </div>
      <div id="customPartenzaContainer" class="hidden" style="margin-top: -10px; margin-bottom: 20px;">
        <label for="partenza" class="required"><span id="lblPartenza"></span></label>
        <input type="text" id="partenza">
      </div>

      <div class="form-group checkbox-group">
        <input type="checkbox" id="arrivoInSede" checked>
        <label for="arrivoInSede"><span id="lblArrivoSede"></span></label>
      </div>
      <div id="customArrivoContainer" class="hidden" style="margin-top: -10px; margin-bottom: 20px;">
        <label for="arrivo" class="required"><span id="lblArrivo"></span></label>
        <input type="text" id="arrivo">
      </div>

      <div class="form-group">
        <label><span id="lblTipoPercorso"></span></label>
        <div class="radio-group">
          <input type="radio" name="tripType" value="interessi" id="radio-interessi" checked>
          <label for="radio-interessi"><span id="optInteressi"></span></label>
          <input type="radio" name="tripType" value="appuntamenti" id="radio-appuntamenti">
          <label for="radio-appuntamenti"><span id="optAppuntamenti"></span></label>
        </div>
      </div>

      <div id="dataAppuntamentoContainer" class="form-group hidden">
        <label for="dataAppuntamento" class="required"><span id="lblDataAppuntamento"></span></label>
        <input type="date" id="dataAppuntamento">
      </div>

      <div id="midpointContainer" class="form-group">
        <label for="midpoint"><span id="lblMidpoint"></span></label>
        <input type="text" id="midpoint">
        <div class="hint" id="hintMidpoint"></div>
      </div>

      <div class="form-group">
        <label for="dettagli"><span id="lblDettagli"></span></label>
        <input type="text" id="dettagli">
      </div>
      
      <div class="form-group checkbox-group">
        <input type="checkbox" id="includeTripDetails">
        <label for="includeTripDetails"><span id="lblPernottamento"></span></label>
      </div>
      
      <div id="tripDetailsContainer" class="hidden">
        <div class="row">
          <div class="form-group"><label for="notti"><span id="lblNotti"></span></label><input type="number" id="notti" min="1" value="1"></div>
          <div class="form-group"><label for="adulti"><span id="lblAdulti"></span></label><input type="number" id="adulti" min="1" value="2"></div>
          <div class="form-group"><label for="bambini"><span id="lblBambini"></span></label><input type="number" id="bambini" min="0" value="0"></div>
        </div>
      </div>

      <div class="button-container"><button type="submit" id="submitBtn"></button></div>
      <p class="cancel-hint" id="cancelHint"></p>
    </form>
  </div>

  <script>
    const translations = {
      it: {
        title: "üöó Pianifica Percorso", subtitle: "Crea un itinerario o calcola un percorso per appuntamenti.",
        lblPartenza: "üìç Punto di Partenza Personalizzato", lblPartenzaSede: "Partenza da Sede",
        lblArrivo: "üèÅ Punto di Arrivo Personalizzato", lblArrivoSede: "Arrivo in Sede",
        lblTipoPercorso: "Scopo del percorso", optInteressi: "Interessi", optAppuntamenti: "Appuntamenti",
        lblDataAppuntamento: "üóìÔ∏è Data Appuntamento",
        lblMidpoint: "üó∫Ô∏è Tappe Intermedie (Opzionale)", hintMidpoint: "Puoi elencare pi√π destinazioni qui",
        lblDettagliApp: "Dettagli Appuntamento (es. Cliente Rossi)", lblDettagliInt: "Elenca Interessi (es. cibo, musei)",
        lblPernottamento: "Pianifica anche il pernottamento",
        lblNotti: "üåô Notti", lblAdulti: "üë• Adulti", lblBambini: "üßí Bambini",
        btnSubmit: "Crea Itinerario", btnSuccess: "Richiesta inviata!", cancelHint: "Per annullare, chiudi la finestra."
      },
      en: {
        title: "üöó Plan Route", subtitle: "Create an itinerary or calculate a route for appointments.",
        lblPartenza: "üìç Custom Starting Point", lblPartenzaSede: "Depart from Office",
        lblArrivo: "üèÅ Custom Destination", lblArrivoSede: "Arrive at Office",
        lblTipoPercorso: "Purpose of the route", optInteressi: "Interests", optAppuntamenti: "Appointments",
        lblDataAppuntamento: "üóìÔ∏è Appointment Date",
        lblMidpoint: "üó∫Ô∏è Midpoints / Stops (Optional)", hintMidpoint: "You can list multiple destinations here",
        lblDettagliApp: "Appointment Details (e.g., Client Smith)", lblDettagliInt: "List Interests (e.g., food, museums)",
        lblPernottamento: "Plan overnight stay as well",
        lblNotti: "üåô Nights", lblAdulti: "üë• Adults", lblBambini: "üßí Children",
        btnSubmit: "Create Itinerary", btnSuccess: "Request sent!", cancelHint: "To cancel, just close the window."
      },
    };
    
    const N8N_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/a0b6b2cb-4e19-4a92-9269-6b6d8a7afb80";
    
    try {
      const tg = window.Telegram.WebApp;
      tg.ready(); tg.expand();
      
      const urlParams = new URLSearchParams(window.location.search);
      const lang = urlParams.get('lang') || 'it';
      const t = translations[lang] || translations.it;
      
      const dom = {
          form: document.getElementById('travelForm'), submitBtn: document.getElementById('submitBtn'),
          title: document.getElementById('title'), subtitle: document.getElementById('subtitle'),
          lblPartenza: document.getElementById('lblPartenza'), lblPartenzaSede: document.getElementById('lblPartenzaSede'),
          lblArrivo: document.getElementById('lblArrivo'), lblArrivoSede: document.getElementById('lblArrivoSede'),
          lblTipoPercorso: document.getElementById('lblTipoPercorso'),
          optInteressi: document.getElementById('optInteressi'), optAppuntamenti: document.getElementById('optAppuntamenti'),
          lblDataAppuntamento: document.getElementById('lblDataAppuntamento'), lblMidpoint: document.getElementById('lblMidpoint'),
          hintMidpoint: document.getElementById('hintMidpoint'), lblPernottamento: document.getElementById('lblPernottamento'),
          lblNotti: document.getElementById('lblNotti'), lblAdulti: document.getElementById('lblAdulti'),
          lblBambini: document.getElementById('lblBambini'), cancelHint: document.getElementById('cancelHint'),
          partenzaDaSede: document.getElementById('partenzaDaSede'), customPartenzaContainer: document.getElementById('customPartenzaContainer'),
          partenza: document.getElementById('partenza'), arrivoInSede: document.getElementById('arrivoInSede'),
          customArrivoContainer: document.getElementById('customArrivoContainer'), arrivo: document.getElementById('arrivo'),
          dataAppuntamentoContainer: document.getElementById('dataAppuntamentoContainer'), dataAppuntamento: document.getElementById('dataAppuntamento'),
          midpointContainer: document.getElementById('midpointContainer'), midpoint: document.getElementById('midpoint'),
          dettagli: document.getElementById('dettagli'), lblDettagli: document.getElementById('lblDettagli'),
          includeTripDetails: document.getElementById('includeTripDetails'), tripDetailsContainer: document.getElementById('tripDetailsContainer'),
          notti: document.getElementById('notti'), adulti: document.getElementById('adulti'),
          bambini: document.getElementById('bambini'),
          tripTypeRadios: document.querySelectorAll('input[name="tripType"]')
      };

      function applyTranslations() {
        document.title = t.title.replace(/<[^>]*>?/gm, '');
        dom.title.innerHTML = t.title; dom.subtitle.textContent = t.subtitle;
        dom.lblPartenza.textContent = t.lblPartenza; dom.lblPartenzaSede.textContent = t.lblPartenzaSede;
        dom.lblArrivo.textContent = t.lblArrivo; dom.lblArrivoSede.textContent = t.lblArrivoSede;
        dom.lblTipoPercorso.textContent = t.lblTipoPercorso; dom.optInteressi.textContent = t.optInteressi;
        dom.optAppuntamenti.textContent = t.optAppuntamenti; dom.lblDataAppuntamento.textContent = t.lblDataAppuntamento;
        dom.lblMidpoint.textContent = t.lblMidpoint; dom.hintMidpoint.textContent = t.hintMidpoint;
        dom.lblPernottamento.textContent = t.lblPernottamento; dom.lblNotti.textContent = t.lblNotti;
        dom.lblAdulti.textContent = t.lblAdulti; dom.lblBambini.textContent = t.lblBambini;
        dom.submitBtn.textContent = t.btnSubmit; dom.cancelHint.textContent = t.cancelHint;
      }
      applyTranslations();
      
      function setMinDate() { dom.dataAppuntamento.setAttribute('min', new Date().toISOString().split('T')[0]); }
      setMinDate();

      function updateFormUI() {
          const tripType = document.querySelector('input[name="tripType"]:checked').value;
          const isAppointments = tripType === 'appuntamenti';
          dom.dataAppuntamentoContainer.classList.toggle('hidden', !isAppointments);
          dom.dataAppuntamento.toggleAttribute('required', isAppointments);
          dom.midpointContainer.classList.toggle('hidden', isAppointments);
          dom.lblDettagli.textContent = isAppointments ? t.lblDettagliApp : t.lblDettagliInt;
          validateForm();
      }

      function createCheckboxToggleListener(checkbox, container, input) {
          checkbox.addEventListener('change', function() {
              container.classList.toggle('hidden', this.checked);
              input.toggleAttribute('required', !this.checked);
              validateForm();
          });
      }

      createCheckboxToggleListener(dom.partenzaDaSede, dom.customPartenzaContainer, dom.partenza);
      createCheckboxToggleListener(dom.arrivoInSede, dom.customArrivoContainer, dom.arrivo);
      dom.tripTypeRadios.forEach(radio => radio.addEventListener('change', updateFormUI));
      dom.includeTripDetails.addEventListener('change', function() {
          const isChecked = this.checked;
          dom.tripDetailsContainer.classList.toggle('hidden', !isChecked);
          dom.notti.toggleAttribute('required', isChecked);
          dom.adulti.toggleAttribute('required', isChecked);
          validateForm();
      });

      function validateForm() {
          const currentRequired = dom.form.querySelectorAll('[required]');
          const isValid = Array.from(currentRequired).every(input => input.value.trim() !== '');
          dom.submitBtn.disabled = !isValid;
      }
      
      dom.form.addEventListener('input', validateForm);
      updateFormUI();

      dom.form.addEventListener('submit', (e) => {
        e.preventDefault();
        const tripType = document.querySelector('input[name="tripType"]:checked').value;
        const pernottamento = dom.includeTripDetails.checked;
        const tripData = {
          type: 'TRIP_PLANNING_SUBMISSION',
          payload: {
              Partenza: dom.partenzaDaSede.checked ? "Sede" : dom.partenza.value.trim(),
              Arrivo: dom.arrivoInSede.checked ? "Sede" : dom.arrivo.value.trim(),
              TipoPercorso: tripType,
              TappeIntermedie: tripType === 'interessi' ? (dom.midpoint.value.trim() || null) : null,
              Dettagli: dom.dettagli.value.trim() || null,
              DataAppuntamento: tripType === 'appuntamenti' ? dom.dataAppuntamento.value : null,
              PernottamentoIncluso: pernottamento,
              Notti: pernottamento ? parseInt(dom.notti.value) : null,
              Adulti: pernottamento ? parseInt(dom.adulti.value) : null,
              Bambini: pernottamento ? parseInt(dom.bambini.value) : null,
          },
          context: { chatId: urlParams.get('chatId'), threadId: urlParams.get('threadId'), language: lang }
        };

        fetch(N8N_WEBHOOK_URL, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(tripData)
        }).finally(() => {
            dom.submitBtn.disabled = true; dom.submitBtn.textContent = t.btnSuccess;
            setTimeout(() => { tg.close(); }, 1200);
        });
      });
    } catch (error) {
        console.error("Errore nell'inizializzazione dell'app:", error);
        document.body.innerHTML = '<h1>Oops!</h1><p>Qualcosa √® andato storto. Assicurati di aprire questa pagina da Telegram.</p>';
    }
  </script>
</body>
</html>
