<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>SiteBoS Activation</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <div id="loader">
    <div class="spinner"></div>
  </div>

  <div id="access-denied" class="hidden container text-center" style="padding-top:40px;">
    <h1>ðŸ”’</h1>
    <h2>Accesso Riservato</h2>
    <p class="subtitle">Configurazione disponibile solo tramite Bot.</p>
  </div>

  <div id="app-content" class="container hidden">
    <!-- Lang Selector -->
    <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
      <select id="lang-selector" onchange="changeLanguage(this.value)" style="width:auto; padding:5px; font-size:12px;">
        <option value="it">ðŸ‡®ðŸ‡¹ IT</option>
        <option value="en">ðŸ‡¬ðŸ‡§ EN</option>
      </select>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-line"></div>
      <div class="progress-fill" id="progress-fill"></div>
      
      <div class="step-item active" id="si-1">
        <div class="step-circle">1</div>
        <div class="step-label">Start</div>
      </div>
      <div class="step-item" id="si-2">
        <div class="step-circle">2</div>
        <div class="step-label">Dati</div>
      </div>
      <div class="step-item" id="si-3">
        <div class="step-circle">3</div>
        <div class="step-label">Promo</div>
      </div>
    </div>

    <form id="wizardForm" onsubmit="return false;">
      
      <!-- STEP 1: SETUP -->
      <div class="step-content fade-in" id="step-1">
        <div class="form-section">
            <h3 class="form-section-title">Consensi & API</h3>
            <div class="checkbox-group">
                <input type="checkbox" id="chk_privacy" onchange="checkLegalGate()">
                <label for="chk_privacy">Privacy Policy</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="chk_terms" onchange="checkLegalGate()">
                <label for="chk_terms">Termini e Condizioni</label>
            </div>
            
            <div style="margin-top:15px;">
                <label class="required">Gemini API Key</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="gemini_key" placeholder="Incolla qui la chiave..." disabled>
                    <a href="https://aistudio.google.com/api-keys" target="_blank" class="btn btn-sm btn-secondary" style="white-space:nowrap;">Genera</a>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3 class="form-section-title">IdentitÃ  Admin</h3>
            <div class="row">
                <div class="col"><label class="required">Nome</label><input type="text" id="name"></div>
                <div class="col"><label class="required">Cognome</label><input type="text" id="surname"></div>
            </div>
            <div class="input-group"><label class="required">Codice Fiscale</label><input type="text" id="fiscal_code"></div>
            <div class="input-group"><label class="required">Email</label><input type="email" id="email"></div>
            <div class="input-group"><label class="required">Cellulare</label><input type="tel" id="phone"></div>
        </div>

        <div class="btn-container">
          <button type="button" class="btn btn-primary btn-block" id="btn-step1" onclick="validateAndGo(2)" disabled>
            Avanti <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- STEP 2: AZIENDA -->
      <div class="step-content hidden fade-in" id="step-2">
        <h3 class="form-section-title">Dati Aziendali</h3>
        
        <div class="input-group"><label class="required">Ragione Sociale</label><input type="text" id="ragione_sociale"></div>
        <div class="row">
          <div class="col"><label class="required">P.IVA</label><input type="text" id="vat_number"></div>
          <div class="col"><label>SDI / PEC</label><input type="text" id="sdi_pec"></div>
        </div>
        
        <div class="input-group">
           <label class="required">Sede Legale</label>
           <div class="row">
             <div class="col-2"><input type="text" id="addr_route" placeholder="Via/Piazza"></div>
             <div class="col"><input type="text" id="addr_num" placeholder="NÂ°"></div>
           </div>
           <div class="row">
             <div class="col"><input type="text" id="addr_zip" placeholder="CAP"></div>
             <div class="col-2"><input type="text" id="addr_city" placeholder="CittÃ "></div>
             <div class="col"><input type="text" id="addr_prov" placeholder="PR" maxlength="2"></div>
           </div>
        </div>

        <div class="input-group"><label>Settore</label>
            <select id="sector">
                <option value="services">Servizi</option>
                <option value="retail">Retail</option>
                <option value="other">Altro</option>
            </select>
        </div>

        <div class="btn-container">
          <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Indietro</button>
          <button type="button" class="btn btn-primary" onclick="validateAndGo(3)">Avanti <i class="fas fa-arrow-right"></i></button>
        </div>
      </div>

      <!-- STEP 3: PROMO -->
      <div class="step-content hidden fade-in" id="step-3">
        <h3 class="form-section-title">Attivazione</h3>
        
        <div class="pioneer-card">
            <div class="pioneer-badge">14 GIORNI GRATIS</div>
            <div style="font-size:18px; font-weight:bold; color:#fff;">SiteBoS Enterprise</div>
            <p style="font-size:13px; color:rgba(255,255,255,0.7); margin-bottom:15px;">Accesso completo alle funzionalitÃ  AI.</p>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="text-decoration:line-through; color:rgba(255,255,255,0.5);">â‚¬ 5.000 / anno</span>
                <span style="font-size:20px; color:#4cd964; font-weight:bold;">GRATIS ORA</span>
            </div>
        </div>

        <div style="margin-top:20px;">
            <label>Metodo di pagamento preferito (Futuro):</label>
            <div class="payment-selector">
                <div class="payment-option selected" onclick="setPay('card', this)"><i class="fas fa-credit-card"></i> Carta</div>
                <div class="payment-option" onclick="setPay('paypal', this)"><i class="fab fa-paypal"></i> PayPal</div>
                <div class="payment-option" onclick="setPay('wire', this)"><i class="fas fa-university"></i> Bonifico</div>
            </div>
            <input type="hidden" id="payment_pref" value="card">
        </div>

        <div class="btn-container">
          <button type="button" class="btn btn-secondary" onclick="goToStep(2)">Indietro</button>
          <!-- IL PULSANTE CRITICO -->
          <button type="button" class="btn btn-success" id="finalSubmitBtn" onclick="finalizeSubmission()">
            <i class="fas fa-rocket"></i> ATTIVA PROVA ORA
          </button>
        </div>
      </div>

    </form>
  </div>

  <script>
    // URL WEBHOOK N8N
    const WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/ef4aece4-9ec0-4026-a7a7-328562bcbdf6"; 
    
    const tg = window.Telegram.WebApp; 
    tg.ready(); tg.expand();

    // DOM Elements
    const dom = {
        loader: document.getElementById('loader'),
        app: document.getElementById('app-content'),
        denied: document.getElementById('access-denied'),
        steps: [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')],
        dots: [document.getElementById('si-1'), document.getElementById('si-2'), document.getElementById('si-3')],
        progressFill: document.getElementById('progress-fill'),
        geminiKey: document.getElementById('gemini_key'),
        btnStep1: document.getElementById('btn-step1')
    };

    // URL Params
    const urlParams = new URLSearchParams(window.location.search);
    const chatId = urlParams.get('chat_id') || tg.initDataUnsafe?.user?.id;
    const lang = urlParams.get('lang') || 'it';

    // Init
    if(!chatId) {
        dom.loader.classList.add('hidden');
        dom.denied.classList.remove('hidden');
    } else {
        dom.loader.classList.add('hidden');
        dom.app.classList.remove('hidden');
    }

    // Logic Step 1
    window.checkLegalGate = function() {
        const p = document.getElementById('chk_privacy').checked;
        const t = document.getElementById('chk_terms').checked;
        const ok = p && t;
        dom.geminiKey.disabled = !ok;
        dom.btnStep1.disabled = !ok;
    };

    // Navigazione e Validazione Manuale
    window.validateAndGo = function(targetStep) {
        // Validazione Step 1
        if(targetStep > 1) {
            const req1 = ['gemini_key', 'name', 'surname', 'fiscal_code', 'email', 'phone'];
            for(let id of req1) {
                if(!document.getElementById(id).value.trim()) {
                    alert("Compila: " + id);
                    goToStep(1);
                    document.getElementById(id).focus();
                    return;
                }
            }
        }
        // Validazione Step 2
        if(targetStep > 2) {
            const req2 = ['ragione_sociale', 'vat_number', 'addr_route', 'addr_city'];
            for(let id of req2) {
                if(!document.getElementById(id).value.trim()) {
                    alert("Compila: " + id);
                    goToStep(2);
                    document.getElementById(id).focus();
                    return;
                }
            }
        }
        goToStep(targetStep);
    };

    window.goToStep = function(step) {
        dom.steps.forEach(s => s.classList.add('hidden'));
        dom.steps[step-1].classList.remove('hidden');
        
        // Update Bar
        dom.progressFill.style.width = ((step - 1) / 2) * 100 + "%";
        dom.dots.forEach((d, i) => {
            d.parentElement.classList.remove('active', 'completed');
            if(i < step-1) d.parentElement.classList.add('completed');
            if(i === step-1) d.parentElement.classList.add('active');
        });
    };

    window.setPay = function(val, el) {
        document.querySelectorAll('.payment-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('payment_pref').value = val;
    };

    // SUBMISSION (Corretta)
    window.finalizeSubmission = async function() {
        const btn = document.getElementById('finalSubmitBtn');
        
        // 1. Controllo finale integritÃ  (Ridondante ma sicuro)
        const allIds = ['gemini_key', 'name', 'surname', 'email', 'ragione_sociale', 'vat_number'];
        for(let id of allIds) {
            if(!document.getElementById(id).value.trim()) {
                alert("Dato mancante: " + id);
                // Trova in che step Ã¨ e vacci
                if(['ragione_sociale','vat_number'].includes(id)) goToStep(2);
                else goToStep(1);
                return;
            }
        }

        // 2. UI Loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Invio...';

        // 3. Payload
        const addr = `${document.getElementById('addr_route').value}, ${document.getElementById('addr_num').value} - ${document.getElementById('addr_zip').value} ${document.getElementById('addr_city').value}`;

        const payload = {
            action: 'onboarding_complete',
            chat_id: chatId,
            owner_data: {
                gemini_key: document.getElementById('gemini_key').value,
                name: document.getElementById('name').value,
                surname: document.getElementById('surname').value,
                fiscal_code: document.getElementById('fiscal_code').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                ragione_sociale: document.getElementById('ragione_sociale').value,
                vat_number: document.getElementById('vat_number').value,
                sdi_pec: document.getElementById('sdi_pec').value,
                indirizzo: addr,
                sector: document.getElementById('sector').value,
                payment_pref: document.getElementById('payment_pref').value,
                lang: lang
            }
        };

        // 4. Fetch
        try {
            const res = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if(res.ok) {
                btn.className = "btn btn-success btn-block";
                btn.innerHTML = "âœ… SUCCESSO!";
                tg.HapticFeedback.notificationOccurred('success');
                setTimeout(() => { tg.close(); }, 1500);
            } else {
                throw new Error("Errore Server");
            }
        } catch(e) {
            console.error(e);
            alert("Errore di connessione. Riprova.");
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-rocket"></i> ATTIVA PROVA ORA';
        }
    };
    
    // Placeholder function per compatibilitÃ  se richiamata
    window.changeLanguage = function(l) { console.log("Lang switch to", l); }
  </script>
</body>
</html>
