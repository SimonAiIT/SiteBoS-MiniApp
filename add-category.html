<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nuova Categoria</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- SEZIONE 1: INPUT INIZIALE -->
        <div id="initialInputSection">
            <h1 id="title"></h1>
            <p class="subtitle" id="subtitle"></p>
            <div class="form-group">
                <label for="categoryName" class="required"><span id="lblCatName"></span></label>
                <input type="text" id="categoryName" required>
            </div>
            <div class="form-group">
                <label for="categoryDescription"><span id="lblCatDesc"></span></label>
                <textarea id="categoryDescription" rows="3"></textarea>
            </div>
            <button id="generateBtn" class="button"></button>
        </div>

        <!-- SEZIONE 2: ESPANSIONE E CURA (INIZIALMENTE NASCOSTA) -->
        <div id="subcategoriesSection" class="hidden">
            <h2 id="subcatTitle"></h2>
            <ul id="subcategoriesList"></ul>
            <div class="form-group">
                <input type="text" id="manualSubcat" placeholder="">
            </div>
            <button id="addSubcatBtn" class="button"></button>
            <hr>
            <button id="saveBtn" class="button"></button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        const GENERATE_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/5e225cf6-76bb-4e19-8657-35cac49fd399";
        const SAVE_WEBHOOK_URL = "https://trinai.api.workflow.dcmake.it/webhook/7da6f424-dc2a-4476-a0bd-a3bfd21270fb";

        const translations = {
            it: {
                title: "➕ Nuova Categoria", subtitle: "Definisci una nuova area per i tuoi prodotti o servizi.",
                lblCatName: "Nome Categoria", lblCatDesc: "Descrizione (Opzionale)",
                btnGenerate: "✨ Genera Servizi Suggeriti con AI", btnGenerating: "Analisi in corso...",
                subcatTitle: "Seleziona i servizi da includere",
                manualSubcatPlaceholder: "Aggiungi un servizio manualmente...", btnAddSubcat: "Aggiungi",
                btnSave: "✅ Salva Categoria e Servizi", btnSaving: "Salvataggio...",
                statusGenerating: "Il tuo assistente sta pensando...", statusError: "❌ Errore, riprova.",
                statusSuccess: "✅ Fatto! Puoi chiudere."
            },
            en: {
                title: "➕ New Category", subtitle: "Define a new area for your products or services.",
                lblCatName: "Category Name", lblCatDesc: "Description (Optional)",
                btnGenerate: "✨ Generate Suggested Services with AI", btnGenerating: "Analyzing...",
                subcatTitle: "Select the services to include",
                manualSubcatPlaceholder: "Add a service manually...", btnAddSubcat: "Add",
                btnSave: "✅ Save Category and Services", btnSaving: "Saving...",
                statusGenerating: "Your assistant is thinking...", statusError: "❌ Error, please try again.",
                statusSuccess: "✅ Done! You can close now."
            },
            fr: {
                title: "➕ Nouvelle Catégorie", subtitle: "Définissez une nouvelle zone pour vos produits ou services.",
                lblCatName: "Nom de la Catégorie", lblCatDesc: "Description (Optionnel)",
                btnGenerate: "✨ Générer des Services Suggérés par l'IA", btnGenerating: "Analyse en cours...",
                subcatTitle: "Sélectionnez les services à inclure",
                manualSubcatPlaceholder: "Ajouter un service manuellement...", btnAddSubcat: "Ajouter",
                btnSave: "✅ Enregistrer la Catégorie et les Services", btnSaving: "Enregistrement...",
                statusGenerating: "Votre assistant réfléchit...", statusError: "❌ Erreur, veuillez réessayer.",
                statusSuccess: "✅ Terminé ! Vous pouvez fermer."
            },
            de: {
                title: "➕ Neue Kategorie", subtitle: "Definieren Sie einen neuen Bereich für Ihre Produkte oder Dienstleistungen.",
                lblCatName: "Kategoriename", lblCatDesc: "Beschreibung (Optional)",
                btnGenerate: "✨ KI-gestützte Dienstvorschläge generieren", btnGenerating: "Analysiere...",
                subcatTitle: "Wählen Sie die einzuschließenden Dienste aus",
                manualSubcatPlaceholder: "Dienst manuell hinzufügen...", btnAddSubcat: "Hinzufügen",
                btnSave: "✅ Kategorie und Dienste speichern", btnSaving: "Speichern...",
                statusGenerating: "Ihr Assistent denkt nach...", statusError: "❌ Fehler, bitte erneut versuchen.",
                statusSuccess: "✅ Fertig! Sie können schließen."
            },
            es: {
                title: "➕ Nueva Categoría", subtitle: "Define una nueva área para tus productos o servicios.",
                lblCatName: "Nombre de la Categoría", lblCatDesc: "Descripción (Opcional)",
                btnGenerate: "✨ Generar Servicios Sugeridos con IA", btnGenerating: "Analizando...",
                subcatTitle: "Selecciona los servicios a incluir",
                manualSubcatPlaceholder: "Añadir un servicio manualmente...", btnAddSubcat: "Añadir",
                btnSave: "✅ Guardar Categoría y Servicios", btnSaving: "Guardando...",
                statusGenerating: "Tu asistente está pensando...", statusError: "❌ Error, por favor inténtalo de nuevo.",
                statusSuccess: "✅ ¡Hecho! Ya puedes cerrar."
            },
            pt: {
                title: "➕ Nova Categoria", subtitle: "Defina uma nova área para seus produtos ou serviços.",
                lblCatName: "Nome da Categoria", lblCatDesc: "Descrição (Opcional)",
                btnGenerate: "✨ Gerar Serviços Sugeridos com IA", btnGenerating: "Analisando...",
                subcatTitle: "Selecione os serviços a incluir",
                manualSubcatPlaceholder: "Adicionar um serviço manualmente...", btnAddSubcat: "Adicionar",
                btnSave: "✅ Salvar Categoria e Serviços", btnSaving: "Salvando...",
                statusGenerating: "Seu assistente está pensando...", statusError: "❌ Erro, por favor tente novamente.",
                statusSuccess: "✅ Feito! Pode fechar agora."
            }
        };

        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('chat_id');
        const lang = urlParams.get('language') || 'it';
        const t = translations[lang] || translations.it;

        const dom = {
            initialSection: document.getElementById('initialInputSection'),
            subcatSection: document.getElementById('subcategoriesSection'),
            generateBtn: document.getElementById('generateBtn'),
            saveBtn: document.getElementById('saveBtn'),
            subcatList: document.getElementById('subcategoriesList'),
            manualSubcatInput: document.getElementById('manualSubcat'),
            addSubcatBtn: document.getElementById('addSubcatBtn'),
            status: document.getElementById('status'),
            categoryName: document.getElementById('categoryName'),
            categoryDescription: document.getElementById('categoryDescription'),
        };
        
        // Salva i dati della categoria generata dall'AI
        let generatedCategoryData = null;

        function applyTranslations() {
            document.title = t.title;
            document.getElementById('title').innerHTML = t.title;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('lblCatName').textContent = t.lblCatName;
            document.getElementById('lblCatDesc').textContent = t.lblCatDesc;
            dom.generateBtn.textContent = t.btnGenerate;
            document.getElementById('subcatTitle').textContent = t.subcatTitle;
            dom.manualSubcatInput.placeholder = t.manualSubcatPlaceholder;
            dom.addSubcatBtn.textContent = t.btnAddSubcat;
            dom.saveBtn.textContent = t.btnSave;
        }

        function createSubcategoryItem(subcatObject, isChecked = true) {
            const li = document.createElement('li');
            const labelEl = document.createElement('label');
            labelEl.className = 'checkbox-container';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = isChecked;
            checkbox.value = subcatObject.name;
            
            const customCheckbox = document.createElement('div');
            customCheckbox.className = 'custom-checkbox';

            const labelText = document.createElement('span');
            labelText.className = 'subcat-label';
            labelText.textContent = subcatObject.short_name;

            labelEl.appendChild(checkbox);
            labelEl.appendChild(customCheckbox);
            labelEl.appendChild(labelText);
            li.appendChild(labelEl);
            return li;
        }

        dom.generateBtn.addEventListener('click', async () => {
            const categoryName = dom.categoryName.value;
            if (!categoryName) { alert('Il nome della categoria è obbligatorio!'); return; }
            
            dom.generateBtn.disabled = true;
            dom.generateBtn.textContent = t.btnGenerating;
            dom.status.innerHTML = `<div class="spinner"></div><p>${t.statusGenerating}</p>`;

            try {
                const response = await fetch(GENERATE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category_name: categoryName,
                        category_description: dom.categoryDescription.value,
                        chat_id: chatId, language: lang
                    })
                });
                const data = await response.json();
                
                generatedCategoryData = data; // Salva l'intero blocco categoria
                
                dom.categoryName.value = data.name; // Aggiorna il nome con quello raffinato dall'AI
                dom.categoryName.readOnly = true; // Blocca la modifica del nome
                dom.categoryDescription.readOnly = true;

                if (data.subcategories && data.subcategories.length > 0) {
                    dom.subcatList.innerHTML = '';
                    data.subcategories.forEach(subcat => {
                        dom.subcatList.appendChild(createSubcategoryItem(subcat));
                    });
                }
                
                dom.initialSection.classList.add('hidden');
                dom.subcatSection.classList.remove('hidden');
                dom.status.innerHTML = '';
            } catch (error) {
                console.error("Errore generazione sottocategorie:", error);
                dom.status.textContent = t.statusError;
                dom.generateBtn.disabled = false;
                dom.generateBtn.textContent = t.btnGenerate;
            }
        });

        dom.addSubcatBtn.addEventListener('click', () => {
            const newSubcatName = dom.manualSubcatInput.value.trim();
            if (newSubcatName) {
                const manualObject = { name: newSubcatName, short_name: newSubcatName };
                dom.subcatList.appendChild(createSubcategoryItem(manualObject));
                dom.manualSubcatInput.value = '';
            }
        });

        dom.saveBtn.addEventListener('click', async () => {
            dom.saveBtn.disabled = true;
            dom.saveBtn.textContent = t.btnSaving;
            dom.status.innerHTML = `<div class="spinner"></div>`;
            
            const selectedSubcatNames = Array.from(dom.subcatList.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            // Filtra le sottocategorie originali per tenere solo quelle selezionate
            const selectedSubcategories = generatedCategoryData.subcategories.filter(
                subcat => selectedSubcatNames.includes(subcat.name)
            );

            // Aggiungi le voci manuali se ci sono
            const manualNames = Array.from(dom.subcatList.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value)
                .filter(name => !generatedCategoryData.subcategories.some(s => s.name === name));
            
            manualNames.forEach(name => {
                selectedSubcategories.push({
                    name: name,
                    short_name: name, // Per le voci manuali, name e short_name coincidono
                    callback_data: name.toUpperCase().replace(/ /g, '_') // Genera un callback base
                });
            });

            const finalPayload = {
                chat_id: chatId,
                new_category_block: {
                    name: generatedCategoryData.name,
                    short_name: generatedCategoryData.short_name,
                    callback_data: generatedCategoryData.callback_data,
                    subcategories: selectedSubcategories
                },
                user_data: tg.initDataUnsafe?.user,
                language: lang
            };

            try {
                const response = await fetch(SAVE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(finalPayload)
                });
                if (response.ok) {
                    dom.status.innerHTML = `<p>${t.statusSuccess}</p>`;
                    setTimeout(() => tg.close(), 1500);
                } else {
                    throw new Error('Errore salvataggio server.');
                }
            } catch (error) {
                console.error("Errore salvataggio categoria:", error);
                dom.status.textContent = t.statusError;
                dom.saveBtn.disabled = false;
                dom.saveBtn.textContent = t.btnSave;
            }
        });

        applyTranslations();
    </script>
</body>
</html>
