<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>SiteBoS Engine</title>
  
  <!-- LIBS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* --- THEME VARIABLES (Original Style Restored) --- */
    :root {
      --bg-start: #4a5b8f; --bg-end: #2a3d5f; 
      --text-main: #ffffff; --text-muted: rgba(255, 255, 255, 0.75);
      --primary: #5B6FED; --primary-hover: #4a5ecf;
      --success: #4cd964; --error: #ff6b6b; --warning: #f59e0b;
      --border: rgba(255, 255, 255, 0.15);
      --input-bg: rgba(255, 255, 255, 0.08);
      --card-bg: rgba(0, 0, 0, 0.25);
      --glass: rgba(255, 255, 255, 0.05);
      --nav-height: 70px;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
      padding-bottom: calc(var(--nav-height) + 20px);
    }

    /* --- LAYOUT UTILS --- */
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    /* --- LOADER --- */
    #loader { position:fixed; inset:0; background:var(--bg-end); z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:15px; }
    .spinner { width:40px; height:40px; border:4px solid rgba(255,255,255,0.1); border-top-color:var(--primary); border-radius:50%; animation:spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- PUBLIC DIRECTORY STYLES --- */
    .view-container { padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; }
    
    h2 { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: white; letter-spacing: -0.5px; }
    p.subtitle { font-size: 14px; color: var(--text-muted); margin-bottom: 28px; font-weight: 400; line-height: 1.6; }

    .search-box { position: relative; margin-bottom: 25px; }
    .search-box input { width: 100%; padding: 16px 20px 16px 50px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 14px; color: white; font-family: inherit; font-size: 15px; transition: all 0.3s; backdrop-filter: blur(5px); }
    .search-box input:focus { outline: none; border-color: var(--primary); background: rgba(255,255,255,0.1); }
    .search-box i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    
    .company-card { display: flex; align-items: center; gap: 15px; background: var(--card-bg); border: 1px solid var(--border); padding: 15px; border-radius: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; }
    .company-card:active { transform: scale(0.98); border-color: var(--primary); }
    .company-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; color: white; border: 2px solid rgba(255,255,255,0.2); }

    /* --- PRIVATE HUB STYLES --- */
    .hub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
    
    .lang-select { background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; outline: none; cursor: pointer; }

    /* AI INDICATOR (The Wheel) */
    .ai-status { width: 38px; height: 38px; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; transition: all 0.3s; position: relative; margin-left: 10px; }
    .ai-status.processing { border-color: var(--primary); box-shadow: 0 0 10px rgba(91, 111, 237, 0.3); }
    .ai-status.processing i { animation: spin 1s linear infinite; color: var(--primary); }
    .ai-status.insight { background: var(--primary); border-color: var(--primary); cursor: pointer; box-shadow: 0 0 15px rgba(91, 111, 237, 0.5); }
    .ai-status.human { background: var(--success); border-color: var(--success); cursor: pointer; }
    .ai-status i { font-size: 16px; color: var(--text-muted); }
    .ai-status.insight i, .ai-status.human i { color: white; }

    /* INSIGHT BUBBLE */
    .insight-bubble { position: absolute; top: 75px; right: 20px; width: 280px; background: rgba(20, 30, 50, 0.95); border: 1px solid var(--primary); border-radius: 16px; padding: 15px; z-index: 500; backdrop-filter: blur(15px); transform-origin: top right; transform: scale(0); opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .insight-bubble.visible { transform: scale(1); opacity: 1; }
    .insight-bubble::before { content: ""; position: absolute; top: -7px; right: 24px; width: 12px; height: 12px; background: inherit; border-top: 1px solid var(--primary); border-left: 1px solid var(--primary); transform: rotate(45deg); }

    /* TABS */
    .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
    .tab-content.active { display: block; }
    
    .info-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 15px; }
    .info-card h3 { font-size: 18px; margin-bottom: 8px; color: white; }
    .info-card p { font-size: 14px; color: var(--text-muted); line-height: 1.5; }

    /* LOGIN MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 800; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .login-box { background: var(--bg-end); border: 1px solid var(--border); padding: 30px; border-radius: 20px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.6); position: relative; }
    .login-input { width: 100%; padding: 14px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 12px; color: white; margin-bottom: 12px; font-size: 15px; }
    .login-input:focus { border-color: var(--primary); outline: none; }
    
    .btn { padding: 14px; border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; border: none; transition: all 0.2s; width: 100%; }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-top: 10px; }
    .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-muted); margin-top: 10px; }

    /* ACTION BAR (FLOATING) */
    .action-bar-container { position: fixed; bottom: calc(var(--nav-height) + 20px); left: 0; right: 0; display: flex; justify-content: center; z-index: 400; pointer-events: none; }
    .action-bar { pointer-events: auto; background: rgba(0, 0, 0, 0.4); border: 1px solid var(--border); border-radius: 40px; padding: 6px 12px; display: flex; gap: 12px; backdrop-filter: blur(20px); box-shadow: 0 8px 30px rgba(0,0,0,0.4); }
    .ab-btn { width: 44px; height: 44px; border-radius: 50%; border: none; background: transparent; color: var(--text-muted); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .ab-btn:active { transform: scale(0.9); color: white; background: rgba(255,255,255,0.1); }
    .ab-btn.primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(91, 111, 237, 0.4); width: 48px; height: 48px; }

    /* BOTTOM NAV */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: rgba(30, 40, 65, 0.95); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 500; backdrop-filter: blur(10px); padding-bottom: env(safe-area-inset-bottom); }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: rgba(255,255,255,0.5); font-size: 10px; text-decoration: none; padding: 8px; border-radius: 8px; flex: 1; transition: all 0.2s; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
    .nav-item i { font-size: 20px; margin-bottom: 2px; }
    .nav-item.active { color: white; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
    .nav-item.active i { color: var(--primary); transform: translateY(-2px); }

  </style>
</head>
<body>

  <!-- LOADER -->
  <div id="loader">
    <div class="spinner"></div>
    <div style="font-size:12px; color:rgba(255,255,255,0.5); letter-spacing:1px; margin-top:10px;">INITIALIZING ENGINE</div>
  </div>

  <!-- 1. PUBLIC PORTAL VIEW -->
  <div id="view-public" class="view-container hidden fade-in">
    <h2 data-i18n="portal_title">SiteBoS Portal</h2>
    <p class="subtitle" data-i18n="portal_sub">Cerca un'azienda per accedere al suo Hub.</p>
    
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="public-search" placeholder="..." onkeyup="filterPublicList()">
    </div>
    
    <div id="company-list">
      <!-- Populated via JS -->
    </div>
  </div>

  <!-- 2. PRIVATE CLIENT HUB VIEW -->
  <div id="view-hub" class="view-container hidden fade-in" style="max-width: 100%;">
    
    <!-- Header -->
    <div class="hub-header">
      <div>
        <h3 id="company-name" style="color:white; font-size:18px; margin:0;">Company Name</h3>
        <span id="user-status" style="font-size:10px; color:var(--text-muted); background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:10px; font-weight:600; display:inline-block; margin-top:4px;">GUEST</span>
      </div>
      <div style="display:flex; align-items:center;">
        <select id="lang-selector" onchange="changeLanguage(this.value)" class="lang-select">
            <option value="it">ðŸ‡®ðŸ‡¹ IT</option>
            <option value="en">ðŸ‡¬ðŸ‡§ EN</option>
            <option value="fr">ðŸ‡«ðŸ‡· FR</option>
            <option value="de">ðŸ‡©ðŸ‡ª DE</option>
            <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
            <option value="pt">ðŸ‡µðŸ‡¹ PT</option>
        </select>
        
        <!-- AI INDICATOR -->
        <div id="ai-indicator" class="ai-status" onclick="toggleInsightBubble()">
          <i id="ai-icon" class="fas fa-robot"></i>
        </div>
      </div>
    </div>

    <!-- Insight Bubble -->
    <div id="insight-bubble" class="insight-bubble">
      <h4 style="color:var(--primary); font-size:11px; margin:0 0 5px 0; text-transform:uppercase; font-weight:700; display:flex; justify-content:space-between;">
        <span>AI Insight</span>
        <i class="fas fa-times" onclick="toggleInsightBubble()" style="cursor:pointer; opacity:0.5;"></i>
      </h4>
      <p id="insight-text" style="color:white; font-size:13px; line-height:1.5; margin:0;">...</p>
    </div>

    <!-- TABS CONTENT -->
    <div id="tab-knowledge" class="tab-content active">
      <h2 data-i18n="tab_knowledge">Knowledge Base</h2>
      <div id="content-knowledge" style="margin-top:15px;"><!-- Dynamic --></div>
    </div>

    <div id="tab-products" class="tab-content">
      <h2 data-i18n="tab_products">Prodotti & Servizi</h2>
      <div id="content-products" style="margin-top:15px;"><!-- Dynamic --></div>
    </div>

    <div id="tab-agenda" class="tab-content">
      <h2 data-i18n="tab_agenda">Agenda & Appuntamenti</h2>
      <div id="content-agenda" style="margin-top:15px;"><!-- Dynamic --></div>
    </div>

    <!-- ACTION BAR -->
    <div class="action-bar-container">
      <div class="action-bar">
        <button class="ab-btn" onclick="triggerAction('text')"><i class="fas fa-keyboard"></i></button>
        <button class="ab-btn primary" onclick="triggerAction('voice')"><i class="fas fa-microphone"></i></button>
        <button class="ab-btn" onclick="document.getElementById('file-input').click()"><i class="fas fa-camera"></i></button>
        <input type="file" id="file-input" accept="image/*" style="display:none" onchange="triggerAction('image', this.files[0])">
      </div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
      <a href="#" class="nav-item active" onclick="switchTab('knowledge', this)"><i class="fas fa-book-open"></i><span data-i18n="nav_kb">Knowledge</span></a>
      <a href="#" class="nav-item" onclick="switchTab('products', this)"><i class="fas fa-box"></i><span data-i18n="nav_prod">Prodotti</span></a>
      <a href="#" class="nav-item" onclick="switchTab('agenda', this)"><i class="fas fa-calendar-alt"></i><span data-i18n="nav_agenda">Agenda</span></a>
      <a href="#" class="nav-item" onclick="showLoginModal()"><i class="fas fa-user"></i><span data-i18n="nav_profile">Profilo</span></a>
    </nav>

  </div>

  <!-- 3. LOGIN MODAL -->
  <div id="login-modal" class="modal-overlay hidden">
    <div class="login-box fade-in">
      <div style="width:60px; height:60px; background:rgba(255,255,255,0.05); border-radius:50%; margin:0 auto 15px auto; display:flex; align-items:center; justify-content:center; font-size:24px; color:var(--primary);"><i class="fas fa-fingerprint"></i></div>
      <h3 style="color:white; margin-bottom:5px;" data-i18n="login_title">Identificazione</h3>
      <p style="color:var(--text-muted); font-size:13px; margin-bottom:25px;" data-i18n="login_desc">Accedi per sbloccare le funzioni avanzate.</p>
      
      <input type="text" id="login-user" class="login-input" placeholder="Email / Username">
      <input type="password" id="login-pass" class="login-input" placeholder="Password">
      
      <button class="btn btn-primary" onclick="processLogin()"><span data-i18n="btn_login">Accedi</span></button>
      <button class="btn btn-secondary" onclick="closeLoginModal()"><span data-i18n="btn_cancel">Annulla</span></button>
    </div>
  </div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 1. CONFIGURAZIONE ENDPOINT (INSERISCI QUI I TUOI URL)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const API = {
        PUBLIC: "https://trinai.api.workflow.dcmake.it/webhook/f33ae38a-5afd-488d-9222-60871d1b2018", // Endpoint per lista aziende (No Params)
        REFLEX: "https://trinai.api.workflow.dcmake.it/webhook/f33ae38a-5afd-488d-9222-60871d1b2019",           // Endpoint Reflex (UI Command)
        COGNITIVE: "https://trinai.api.workflow.dcmake.it/webhook/f33ae38a-5afd-488d-9222-60871d1b2020",     // Endpoint AI (KCRag Insight)
        HUMAN: "https://trinai.api.workflow.dcmake.it/webhook/f33ae38a-5afd-488d-9222-60871d1b2021"              // Endpoint Human (Handover)
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 2. DIZIONARIO MULTILINGUA (6 LINGUE)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const i18n = {
      it: { 
        portal_title: "Portale SiteBoS", portal_sub: "Cerca un'azienda per accedere.",
        tab_knowledge: "Knowledge Base", tab_products: "Prodotti & Servizi", tab_agenda: "Agenda",
        nav_kb: "Knowledge", nav_prod: "Prodotti", nav_agenda: "Agenda", nav_profile: "Profilo",
        login_title: "Identificazione", login_desc: "Accedi per sbloccare funzioni e prezzi.", btn_login: "Accedi", btn_cancel: "Chiudi"
      },
      en: { 
        portal_title: "SiteBoS Portal", portal_sub: "Search for a company to access.",
        tab_knowledge: "Knowledge Base", tab_products: "Products & Services", tab_agenda: "Agenda",
        nav_kb: "Knowledge", nav_prod: "Products", nav_agenda: "Agenda", nav_profile: "Profile",
        login_title: "Identification", login_desc: "Login to unlock features and prices.", btn_login: "Login", btn_cancel: "Close"
      },
      fr: { 
        portal_title: "Portail SiteBoS", portal_sub: "Recherchez une entreprise.",
        tab_knowledge: "Base de Connaissances", tab_products: "Produits et Services", tab_agenda: "Agenda",
        nav_kb: "Savoir", nav_prod: "Produits", nav_agenda: "Agenda", nav_profile: "Profil",
        login_title: "Identification", login_desc: "Connectez-vous pour dÃ©bloquer.", btn_login: "Se connecter", btn_cancel: "Fermer"
      },
      de: { 
        portal_title: "SiteBoS Portal", portal_sub: "Suchen Sie ein Unternehmen.",
        tab_knowledge: "Wissensdatenbank", tab_products: "Produkte und Dienstleistungen", tab_agenda: "Agenda",
        nav_kb: "Wissen", nav_prod: "Produkte", nav_agenda: "Agenda", nav_profile: "Profil",
        login_title: "Identifizierung", login_desc: "Anmelden zum Freischalten.", btn_login: "Anmelden", btn_cancel: "SchlieÃŸen"
      },
      es: { 
        portal_title: "Portal SiteBoS", portal_sub: "Busca una empresa para acceder.",
        tab_knowledge: "Base de Conocimiento", tab_products: "Productos y Servicios", tab_agenda: "Agenda",
        nav_kb: "Saber", nav_prod: "Productos", nav_agenda: "Agenda", nav_profile: "Perfil",
        login_title: "IdentificaciÃ³n", login_desc: "Inicia sesiÃ³n para desbloquear.", btn_login: "Entrar", btn_cancel: "Cerrar"
      },
      pt: { 
        portal_title: "Portal SiteBoS", portal_sub: "Procure uma empresa para acessar.",
        tab_knowledge: "Base de Conhecimento", tab_products: "Produtos e ServiÃ§os", tab_agenda: "Agenda",
        nav_kb: "Saber", nav_prod: "Produtos", nav_agenda: "Agenda", nav_profile: "Perfil",
        login_title: "IdentificaÃ§Ã£o", login_desc: "FaÃ§a login para desbloquear.", btn_login: "Entrar", btn_cancel: "Fechar"
      }
    };

    // Stato App
    const app = { vat: null, lang: 'it', user: null };
    const tg = window.Telegram.WebApp; tg.ready(); tg.expand();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 3. CORE LOGIC
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.onload = async () => {
        const params = new URLSearchParams(window.location.search);
        app.vat = params.get('vat_number');
        const companyName = params.get('ragione_sociale');
        
        // Auto-detect lang
        const userLang = tg.initDataUnsafe?.user?.language_code || navigator.language.slice(0,2);
        if(i18n[userLang]) changeLanguage(userLang);

        if (app.vat) {
            initHub(app.vat, companyName);
        } else {
            initPublic();
        }
        document.getElementById('loader').classList.add('hidden');
    };

    function changeLanguage(lang) {
        app.lang = lang;
        document.getElementById('lang-selector').value = lang;
        const dict = i18n[lang] || i18n.en;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(dict[key]) el.innerText = dict[key];
        });
    }

    // --- PUBLIC ---
    async function initPublic() {
        document.getElementById('view-public').classList.remove('hidden');
        try {
            const res = await fetch(API.PUBLIC, { method: 'POST', body: JSON.stringify({ action: 'get_all_owners' }) });
            const data = await res.json();
            const list = document.getElementById('company-list');
            list.innerHTML = (data.owners || []).map(c => `
                <div class="company-card" onclick="location.href='?vat_number=${c.vat_number}&ragione_sociale=${encodeURIComponent(c.ragione_sociale)}'">
                    <div class="company-avatar">${c.ragione_sociale.charAt(0)}</div>
                    <div style="flex:1">
                        <h4 style="color:white; margin:0;">${c.ragione_sociale}</h4>
                        <small style="color:var(--text-muted);">${c.sector || 'Business'}</small>
                    </div>
                    <i class="fas fa-chevron-right" style="color:var(--text-muted)"></i>
                </div>
            `).join('');
        } catch(e) { console.error("Public API Error"); }
    }

    // --- PRIVATE HUB ---
    async function initHub(vat, name) {
        document.getElementById('view-hub').classList.remove('hidden');
        if(name) document.getElementById('company-name').innerText = name;
        
        // Load Session
        const stored = localStorage.getItem('sb_sess_'+vat);
        if(stored) { app.user = JSON.parse(stored); updateUserStatus(); }
        
        // Load Initial Data (via Reflex or direct fetch)
        triggerAction('init_load');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 4. PARALLEL ENGINE (THE 3-CHANNEL MAGIC)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function triggerAction(type, payload = null) {
        const ind = document.getElementById('ai-indicator');
        const icon = document.getElementById('ai-icon');
        
        // UI Feedback: Start Processing
        ind.className = 'ai-status processing';
        icon.className = 'fas fa-circle-notch';

        const body = {
            vat_number: app.vat,
            session_id: app.user?.sessionId || 'anon',
            action_type: type,
            payload: payload
        };
        
        // Base64 conversion for images
        if(type === 'image' && payload instanceof File) {
            body.payload = await fileToBase64(payload);
        }

        // --- CHANNEL 1: REFLEX (FAST) ---
        fetch(API.REFLEX, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) })
            .then(r => r.json()).then(data => {
                if(data.ui_command) executeUiCommand(data.ui_command);
            }).catch(e => console.log("Reflex fail"));

        // --- CHANNEL 2: COGNITIVE (SLOW) ---
        fetch(API.COGNITIVE, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) })
            .then(r => r.json()).then(data => {
                if(data.ai_insight) {
                    showInsight(data.ai_insight);
                } else if(data.human_handover) {
                    triggerHuman(body);
                } else {
                    resetIndicator();
                }
            }).catch(e => resetIndicator());
    }

    function triggerHuman(body) {
         fetch(API.HUMAN, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
         const ind = document.getElementById('ai-indicator');
         ind.className = 'ai-status human';
         document.getElementById('ai-icon').className = 'fas fa-headset';
         document.getElementById('insight-text').innerText = "Operatore notificato. Attendere...";
    }

    // --- HANDLERS ---
    function executeUiCommand(cmd) {
        if(!cmd) return;
        if(cmd.action === 'NAVIGATE') switchTab(cmd.target);
        if(cmd.action === 'SHOW_CONTENT') document.getElementById(`content-${cmd.target}`).innerHTML = cmd.html;
        if(cmd.action === 'SHOW_LOGIN') showLoginModal();
    }

    function showInsight(text) {
        const ind = document.getElementById('ai-indicator');
        ind.className = 'ai-status insight';
        document.getElementById('ai-icon').className = 'fas fa-lightbulb';
        document.getElementById('insight-text').innerHTML = text;
        if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 5. UI UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.switchTab = (tabId, el) => {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.getElementById(`tab-${tabId}`).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        
        // Lazy load content if empty
        const cont = document.getElementById(`content-${tabId}`);
        if(!cont.innerHTML) triggerAction('load_tab', tabId);
    }

    window.toggleInsightBubble = () => document.getElementById('insight-bubble').classList.toggle('visible');
    
    window.showLoginModal = () => document.getElementById('login-modal').classList.remove('hidden');
    window.closeLoginModal = () => document.getElementById('login-modal').classList.add('hidden');
    
    window.processLogin = () => {
        const u = document.getElementById('login-user').value;
        if(u) {
            app.user = { status: 'VERIFIED', name: u, sessionId: 'sess_'+Date.now() };
            localStorage.setItem('sb_sess_'+app.vat, JSON.stringify(app.user));
            updateUserStatus();
            closeLoginModal();
            triggerAction('login_success');
        }
    };

    function updateUserStatus() {
        const badge = document.getElementById('user-status');
        if(app.user?.status === 'VERIFIED') {
            badge.innerText = "VERIFIED"; badge.style.color = "var(--success)"; badge.style.borderColor = "var(--success)";
        }
    }
    
    function resetIndicator() {
        document.getElementById('ai-indicator').className = 'ai-status';
        document.getElementById('ai-icon').className = 'fas fa-robot';
    }

    window.filterPublicList = () => {
        const term = document.getElementById('public-search').value.toLowerCase();
        document.querySelectorAll('.company-card').forEach(c => {
            c.style.display = c.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
        });
    };
    
    const fileToBase64 = file => new Promise((res, rej) => {
        const r = new FileReader(); r.readAsDataURL(file);
        r.onload = () => res(r.result.split(',')[1]); r.onerror = rej;
    });

</script>
</body>
</html>
